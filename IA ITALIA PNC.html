<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificaci√≥n Permiso Italia (FINAL)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Estilos Generales */
    .delete-icon { cursor: pointer; transition: transform 0.2s; color: #ef4444; }
    .delete-icon:hover { transform: scale(1.1); }
    .cpi-table-container { max-height: 400px; overflow-y: auto; }

    /* LOGO HEADER */
    .header-logo-container {
         width: 10rem; height: 10rem; border-radius: 9999px; overflow: hidden;
         box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* DROP ZONE - Base limpia y profesional */
    .drop-zone {
        transition: all 0.3s ease;
        border: 3px solid transparent;
        background-color: #ffffff; 
        border-radius: 1rem;
        position: relative;
        min-height: 150px;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* Sombra suave */
    }
    .drop-zone.drag-active {
        background-color: #ecfdf5 !important; /* Verde muy p√°lido */
        border-color: #34d399 !important; /* Verde medio */
        border-style: dashed;
        transform: scale(1.01);
        z-index: 50;
    }
    .image-indicator {
        width: 10px; height: 10px; border-radius: 50%;
        background-color: #e2e8f0; transition: background-color 0.3s; border: 1px solid #cbd5e1;
    }
    .image-indicator.active { background-color: #10b981; border-color: #059669; box-shadow: 0 0 5px #10b981; }

    /* Overlay Carga */
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.95); 
        z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner {
        width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid #2563eb; border-radius: 50%; 
        animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #aiResultBox { animation: slideDown 0.5s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col pb-16 relative">

  <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="spinner"></div>
      <h3 class="text-blue-600 font-bold text-lg animate-pulse">Analizando Documento...</h3>
  </div>

  <div class="absolute top-4 right-4 z-40">
      <button onclick="toggleSettings()" class="bg-gray-800 text-white text-xs px-3 py-1 rounded-lg shadow hover:bg-gray-700 flex items-center gap-1 font-bold">‚öôÔ∏è Configurar IA</button>
  </div>
  
  <div id="settingsPanel" class="hidden absolute top-12 right-4 w-72 bg-gray-900 border border-gray-700 shadow-xl rounded-lg p-4 z-40 text-white">
      <div class="text-xs text-gray-400 mb-3">Proveedor: Google Gemini (Fijo)</div>
      <label class="block text-xs font-bold text-gray-300 mb-1">API Key:</label>
      <input type="password" id="apiKeyInput" class="w-full bg-gray-800 text-white text-xs border border-gray-600 p-2 rounded mb-3 focus:outline-none focus:border-blue-500" placeholder="Pegar API Key aqu√≠...">
      <label class="block text-xs font-bold text-gray-300 mb-1">Modelo:</label>
      <input type="text" id="modelInput" class="w-full bg-gray-800 text-white text-xs border border-gray-600 p-2 rounded mb-4 focus:outline-none focus:border-blue-500" value="gemini-1.5-flash">
      <button onclick="saveSettings()" class="w-full bg-blue-600 text-white text-xs py-2 rounded-lg hover:bg-blue-700 font-bold uppercase tracking-wide">GUARDAR CONFIGURACI√ìN</button>
  </div>

  <header class="bg-blue-600 w-full flex justify-center items-center py-4 shadow-xl">
    <div class="header-logo-container">
      <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-contain block">
    </div>
  </header>

  <h1 class="text-gray-800 text-center mt-6 text-2xl font-bold px-4">Verificaci√≥n Permiso de Conducir Italia</h1>
  
  <div id="mainDropZone" class="drop-zone w-11/12 max-w-md mx-auto mt-4 py-4 cursor-pointer">
    <p class="text-gray-500 text-center text-sm mb-2 font-medium">Arrastra Anverso y Reverso o pega (Ctrl+V)</p>
    <div class="w-full pointer-events-none select-none mb-2">
      <img src="logoitalia.png" alt="Logo Italia" class="h-28 mx-auto object-contain transition-transform duration-300">
    </div>
    <div class="flex gap-2">
        <div id="imgDot1" class="image-indicator" title="Imagen 1"></div>
        <div id="imgDot2" class="image-indicator" title="Imagen 2"></div>
    </div>
    <div id="statusText" class="text-xs text-blue-600 font-bold h-4 mt-1"></div>
    <button onclick="limpiarTodo('manual')" class="mt-1 text-[10px] text-gray-400 underline hover:text-red-500">Limpiar im√°genes</button>
  </div>

  <div class="w-11/12 max-w-md mx-auto mt-4 bg-white p-4 rounded-xl shadow-lg border border-gray-100">
      <label class="block text-xs font-bold text-gray-500 mb-2 uppercase text-center tracking-wider">B√∫squeda Manual</label>
      <input type="text" id="numero" placeholder="Ej: AN6023163" class="block w-full p-3 text-base border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase font-bold text-lg shadow-inner mb-3"/>
      <button onclick="buscarFecha()" class="block w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-md">CALCULAR FECHA ESTIMADA</button>
  </div>

  <div id="output" class="mt-4 text-gray-700 text-center w-11/12 max-w-md mx-auto"></div>

  <div id="aiResultBox" class="hidden mt-6 w-11/12 max-w-md mx-auto bg-white border rounded-xl shadow-xl overflow-hidden mb-10">
      <div id="aiHeader" class="bg-gray-100 p-3 border-b">
          <h3 class="font-bold text-lg text-center" id="aiTitle">üîç Resultado del An√°lisis</h3>
      </div>
      <div class="p-5">
          <div class="grid grid-cols-2 gap-3 text-sm text-gray-800 text-left mb-5">
              <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                  <span class="text-[10px] text-gray-500 block uppercase font-bold tracking-wider">N¬∫ SOPORTE</span>
                  <span id="aiNumero" class="font-mono font-bold text-black text-xl break-all"></span>
              </div>
              <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                  <span class="text-[10px] text-gray-500 block uppercase font-bold tracking-wider">FECHA (4a)</span>
                  <span id="aiFecha" class="font-mono font-bold text-black text-xl"></span>
              </div>
          </div>
          <div id="aiValidationMsg" class="mb-4 text-sm"></div>
          <div id="aiActions" class="mt-4"></div>
          <button onclick="document.getElementById('aiResultBox').classList.add('hidden')" class="w-full mt-4 text-gray-400 text-xs underline text-center">Cerrar panel</button>
      </div>
  </div>
  
  <div class="bg-white shadow-xl rounded-xl p-6 mt-4 text-center w-11/12 max-w-md mx-auto mb-12 border border-gray-100">
    <h3 class="text-lg font-semibold mb-4 text-gray-700">Base de Datos Local</h3>
    <div class="flex gap-2">
        <button id="mostrarFormularioBtn" class="flex-1 bg-gray-600 text-white py-2 rounded-lg shadow hover:bg-gray-700 text-xs font-bold uppercase">+ A√±adir Manual</button>
        <button id="mostrarListadoBtn" class="flex-1 bg-blue-500 text-white py-2 rounded-lg shadow hover:bg-blue-600 text-xs font-bold uppercase">Ver Lista</button>
    </div>
    <div id="cpiDataTable" class="mt-4 hidden">
        <div class="cpi-table-container border rounded-lg bg-gray-50">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                    <tr><th class="px-4 py-3">N√∫mero</th><th class="px-4 py-3">Fecha</th><th class="px-4 py-3"></th></tr>
                </thead>
                <tbody id="cpiList"></tbody>
            </table>
        </div>
    </div>
    <div id="formularioNuevosDatos" class="mt-4 hidden text-left bg-gray-50 p-4 rounded-lg border">
      <div class="mb-4"><label class="block text-xs font-bold text-gray-700 mb-1">N√öMERO:</label><input type="text" id="nuevoNumero" placeholder="Ej: AN6023163" class="w-full border border-gray-300 rounded px-3 py-2 uppercase"></div>
      <div class="mb-4"><label class="block text-xs font-bold text-gray-700 mb-1">FECHA:</label><input type="date" id="nuevaFecha" class="w-full border border-gray-300 rounded px-3 py-2"></div>
      <button onclick="guardarNuevoNumero()" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">GUARDAR</button>
    </div>
  </div>

 <footer class="mt-auto text-center py-6 bg-gray-200 border-t border-gray-300 w-full">
    <p class="font-bold text-sm text-gray-700">GRUPO DE AN√ÅLISIS DOCUMENTAL</p>
    <p class="font-bold text-[10px] text-gray-600">POLIC√çA LOCAL DE ALICANTE</p>
 </footer>

  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script> 
  
  <script>
    // --- CONFIG ---
    
    const firebaseConfig = {
        apiKey: "AIzaSyBu5ALRVJ5aDzuU9YIAQD_9KMgR6ZwttpU", 
        authDomain: "gad-alicante-v1.firebaseapp.com",
        databaseURL: "https://gad-alicante-v1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gad-alicante-v1",
        storageBucket: "gad-alicante-v1.appspot.com",
        messagingSenderId: "545835357966",
        appId: "1:545835357966:web:6351ec6c0d3c8e69eb695f"
    }

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), licenciasNuevasRef = db.ref('licencias_italia');
    let datosCompletos = [], geminiApiKey = localStorage.getItem('ai_api_key') || '', geminiModelName = localStorage.getItem('gemini_model_name') || 'gemini-1.5-flash';

    function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); document.getElementById('apiKeyInput').value = geminiApiKey; document.getElementById('modelInput').value = geminiModelName; }
    function saveSettings() { const key = document.getElementById('apiKeyInput').value.trim(), model = document.getElementById('modelInput').value.trim(); if(key && model) { geminiApiKey = key; geminiModelName = model; localStorage.setItem('ai_api_key', key); localStorage.setItem('gemini_model_name', model); alert("Guardado."); toggleSettings(); } }

    // --- LOGICA DE LIMPIEZA ---
    function limpiarInterfaz(modo) {
        if (modo === 'manual') {
            imagesBuffer = []; updateImageStatus();
            document.getElementById('aiResultBox').classList.add('hidden');
            document.getElementById('aiNumero').textContent = ''; document.getElementById('aiFecha').textContent = '';
        }
        if (modo === 'ia') {
            document.getElementById('numero').value = ''; document.getElementById('output').innerHTML = '';
            if (!document.getElementById('aiResultBox').classList.contains('hidden')) {
                document.getElementById('aiResultBox').classList.add('hidden'); imagesBuffer = []; updateImageStatus();
            }
        }
    }
    function limpiarTodo(origen) { imagesBuffer = []; updateImageStatus(); document.getElementById('aiResultBox').classList.add('hidden'); if (origen === 'full' || origen === 'manual') { document.getElementById('numero').value = ''; document.getElementById('output').innerHTML = ''; } }

    // --- CARGA IM√ÅGENES ---
    let imagesBuffer = []; 
    const dropZone = document.getElementById('mainDropZone'), statusText = document.getElementById('statusText'), dot1 = document.getElementById('imgDot1'), dot2 = document.getElementById('imgDot2');
    
    function updateImageStatus() { 
        const count = imagesBuffer.length; dot1.classList.toggle('active', count >= 1); dot2.classList.toggle('active', count >= 2); 
        statusText.textContent = count === 0 ? "" : count === 1 ? "1 imagen lista. Falta la otra." : "Procesando..."; 
        if (count >= 2) processBufferedImages(); 
    }

    function handleFiles(files) { 
        if (!files.length) return; limpiarInterfaz('ia');
        Array.from(files).forEach(file => { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => { if (imagesBuffer.length < 2) { imagesBuffer.push(e.target.result.replace(/^data:(.*,)?/, '')); updateImageStatus(); } }; reader.readAsDataURL(file); } }); 
    }

    // --- IA ---
    async function processBufferedImages() {
        if (imagesBuffer.length < 2) return; document.getElementById('loadingOverlay').classList.remove('hidden');
        const PROMPT = `Analiza DOS im√°genes (Anverso/Reverso) ID Italia. 1. ANVERSO: FECHA Campo 4a. 2. REVERSO: N√öMERO SOPORTE (2 letras+numeros, abajo derecha). JSON: {"numero": "VALOR", "fecha": "DD/MM/AAAA"}`;
        try { 
            if (!geminiApiKey) throw new Error("Falta API Key"); 
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModelName}:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT }, { inline_data: { mime_type: "image/jpeg", data: imagesBuffer[0] } }, { inline_data: { mime_type: "image/jpeg", data: imagesBuffer[1] } }] }] }) });
            const data = await response.json(); if (data.error) throw new Error(data.error.message); handleAiResult(JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim()));
        } catch (error) { 
            console.error(error); alert("Error IA: " + error.message); 
        } finally { 
            document.getElementById('loadingOverlay').classList.add('hidden'); imagesBuffer = []; updateImageStatus(); 
        }
    }

    function validarFormatoItalia(num) { return /^[A-Z]{2}\d{7}$/.test(num); }

    function handleAiResult(result) {
        const num = (result.numero || "").replace(/[^A-Za-z0-9]/g, '').toUpperCase(), fecha = (result.fecha || "").replace(/\./g, '/').replace(/-/g, '/');
        document.getElementById('numero').value = num; document.getElementById('aiNumero').textContent = num || "ND"; document.getElementById('aiFecha').textContent = fecha || "ND";
        const box = document.getElementById('aiResultBox'), header = document.getElementById('aiHeader'), title = document.getElementById('aiTitle'), msg = document.getElementById('aiValidationMsg'), actions = document.getElementById('aiActions'); box.className = "mt-6 w-11/12 max-w-md mx-auto bg-white border-2 rounded-lg shadow-xl overflow-hidden mb-10"; actions.innerHTML = "";

        if (!num || !fecha) { box.classList.remove('hidden'); msg.innerHTML = "<span class='text-red-500'>Error de lectura.</span>"; return; }
        if (!validarFormatoItalia(num)) {
            box.classList.add('border-red-500'); header.className = "bg-red-600 p-3 border-b text-white"; title.innerHTML = "‚ö†Ô∏è FORMATO INV√ÅLIDO";
            msg.className = "bg-red-50 p-4 rounded border border-red-200 text-left";
            msg.innerHTML = `<div class="text-red-800 font-bold text-sm"><p class="uppercase mb-1">ERROR FORMATO:</p><p>Debe ser 2 Letras + 7 N√∫meros (${num}).</p></div>`;
            box.classList.remove('hidden'); return;
        }
        mostrarResultadoIA(verificarCongruencia(num, fecha), num, fecha);
    }

    function mostrarResultadoIA(chequeo, num, fecha) {
        const box = document.getElementById('aiResultBox'), header = document.getElementById('aiHeader'), title = document.getElementById('aiTitle'), msg = document.getElementById('aiValidationMsg'), actions = document.getElementById('aiActions');
        if (chequeo.esFraude) {
            box.classList.add('border-red-500'); header.className = "bg-red-600 p-3 border-b text-white"; title.innerHTML = "‚ö†Ô∏è INCONGRUENCIA DETECTADA";
            msg.className = "bg-red-50 p-4 rounded border border-red-200 text-left";
            let estimateHtml = chequeo.fechaEstimada ? `<div class="mt-3 bg-yellow-100 p-3 rounded-lg border border-yellow-300 text-center"><p class="text-yellow-800 text-xs uppercase font-bold">Fecha Real Estimada:</p><p class="text-xl font-bold text-yellow-900">${chequeo.fechaEstimada}</p></div>` : '';
            msg.innerHTML = `<div class="text-red-800 font-bold text-lg mb-2">${chequeo.mensajeClaro}</div>${estimateHtml}<div class="mt-3 pt-3 border-t border-red-200 text-gray-600 text-xs"><p class="font-bold mb-1">Detalles:</p>${chequeo.detallesTecnicos}</div>`;
        } else if (chequeo.existe) {
            box.classList.add('border-blue-500'); header.className = "bg-blue-600 p-3 border-b text-white"; title.innerHTML = "‚ÑπÔ∏è Registrado Correctamente";
            msg.innerHTML = `<p class="text-blue-800 p-3 bg-blue-50 rounded-lg">El n√∫mero existe y la fecha coincide.</p>`;
        } else {
            // VERDE CON RANGO
            box.classList.add('border-green-500'); header.className = "bg-green-600 p-3 border-b text-white"; title.innerHTML = "‚úÖ Documento Correcto";
            msg.innerHTML = `<div class="bg-green-50 p-3 rounded-lg border border-green-200">
                <p class="text-green-800 font-bold text-lg mb-1">Progresi√≥n L√≥gica Correcta</p>
                <div class="text-gray-600 text-xs mt-2 pt-2 border-t border-green-200">
                    <p class="font-bold uppercase mb-1 text-green-700">Rango Justificado:</p>
                    ${chequeo.rangoInfo}
                </div>
            </div>`;
            window.tempAiData = { numero: num, fecha: fecha };
            actions.innerHTML = `<button onclick="guardarDesdeAI()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg mt-2 shadow hover:bg-green-700 flex justify-center items-center gap-2">A√ëADIR A LA LISTA</button>`;
        }
        box.classList.remove('hidden');
    }

    // --- ESTIMACI√ìN Y VERIFICACI√ìN ---
    function calcularEstimacionString(numStr, antesObj, despuesObj) {
        if (!antesObj || !despuesObj) return null;
        const n1 = parseInt(antesObj.numero.replace(/\D/g, ''), 36) || 0, n2 = parseInt(despuesObj.numero.replace(/\D/g, ''), 36) || 0, nTarget = parseInt(numStr.replace(/\D/g, ''), 36) || 0;
        if (n2 <= n1) return null;
        const prop = (nTarget - n1) / (n2 - n1);
        const parseDate = (str) => { const p = str.split('/'); return new Date(p[2], p[1] - 1, p[0]); };
        const f1 = parseDate(antesObj.fecha), f2 = parseDate(despuesObj.fecha);
        if (f1 >= f2) return null;
        return new Date(f1.getTime() + prop * (f2.getTime() - f1.getTime())).toLocaleDateString("es-ES", { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function verificarCongruencia(numeroDoc, fechaDocStr) {
        const [d, m, y] = fechaDocStr.split('/').map(Number), fechaDoc = new Date(y, m - 1, d);
        const existente = datosCompletos.find(d => d.numero === numeroDoc);
        if (existente) {
            return existente.fecha === fechaDocStr ? { esFraude: false, existe: true } : { esFraude: true, existe: true, mensajeClaro: "El n√∫mero existe pero la fecha NO coincide.", detallesTecnicos: `Registrado: ${existente.fecha} vs Documento: ${fechaDocStr}` };
        }
        
        const sorted = [...datosCompletos].sort((a, b) => a.numero.localeCompare(b.numero, undefined, { numeric: true }));
        const anterior = sorted.filter(d => d.numero.localeCompare(numeroDoc, undefined, { numeric: true }) < 0).pop();
        const posterior = sorted.find(d => d.numero.localeCompare(numeroDoc, undefined, { numeric: true }) > 0);
        
        let esFraude = false, mensajeClaro = "", detallesTecnicos = "", fechaEstimada = null, rangoInfo = "";

        if (anterior) {
            const [d1, m1, y1] = anterior.fecha.split('/'); 
            if (fechaDoc < new Date(`${y1}-${m1}-${d1}`)) { 
                esFraude = true; mensajeClaro = "Fecha demasiado ANTIGUA."; detallesTecnicos = `Posterior a ${anterior.numero} (${anterior.fecha}).`; 
            }
        }
        if (posterior && !esFraude) {
            const [d2, m2, y2] = posterior.fecha.split('/'); 
            if (fechaDoc > new Date(`${y2}-${m2}-${d2}`)) { 
                esFraude = true; mensajeClaro = "Fecha demasiado FUTURA."; detallesTecnicos = `Anterior a ${posterior.numero} (${posterior.fecha}).`; 
            }
        }
        
        if (anterior && posterior) {
            fechaEstimada = calcularEstimacionString(numeroDoc, anterior, posterior);
            rangoInfo = `Se sit√∫a entre el anterior <strong>${anterior.numero}</strong> (${anterior.fecha}) y el posterior <strong>${posterior.numero}</strong> (${posterior.fecha}).`;
        } else if (anterior) {
            rangoInfo = `Es posterior al √∫ltimo registro conocido <strong>${anterior.numero}</strong> (${anterior.fecha}).`;
        } else if (posterior) {
            rangoInfo = `Es anterior al primer registro conocido <strong>${posterior.numero}</strong> (${posterior.fecha}).`;
        } else {
            rangoInfo = "Es el primer registro de la base de datos.";
        }

        return { esFraude, existe: false, mensajeClaro, detallesTecnicos, fechaEstimada, rangoInfo };
    }

    // --- B√öSQUEDA MANUAL ---
    function buscarFecha() {
        limpiarInterfaz('manual');
        const num = document.getElementById("numero").value.trim().toUpperCase();
        const output = document.getElementById("output");
        if(!num) return;
        if (!validarFormatoItalia(num)) { output.innerHTML = "<div class='bg-red-100 text-red-700 p-3 rounded font-bold'>Formato inv√°lido (2 Letras + 7 N√∫meros)</div>"; return; }
        const exacto = datosCompletos.find(d => d.numero === num);
        if (exacto) { output.innerHTML = `<div class='bg-blue-50 border border-blue-200 p-4 rounded'><p class='text-green-600 font-bold text-xl'>‚úÖ EXISTE</p><p class="text-gray-600">Fecha registrada: <strong>${exacto.fecha}</strong></p></div>`; return; }

        const sorted = [...datosCompletos].sort((a, b) => a.numero.localeCompare(b.numero, undefined, { numeric: true }));
        const anterior = sorted.filter(d => d.numero.localeCompare(num, undefined, { numeric: true }) < 0).pop();
        const posterior = sorted.find(d => d.numero.localeCompare(num, undefined, { numeric: true }) > 0);
        
        let html = "";
        if (anterior && posterior) {
            const estimacion = calcularEstimacionString(num, anterior, posterior);
            html = `<div class="bg-yellow-50 p-4 rounded border border-yellow-200 shadow-sm text-left"><h4 class="font-bold text-yellow-800 border-b border-yellow-200 pb-2 mb-2 text-center">üìä ESTIMACI√ìN MANUAL</h4><div class="text-xs text-gray-500 flex justify-between mb-3"><span>Ant: ${anterior.numero} (${anterior.fecha})</span><span>Post: ${posterior.numero} (${posterior.fecha})</span></div><div class="text-center bg-white p-3 rounded border border-yellow-100"><p class="text-xs uppercase text-gray-400 font-bold tracking-wider">Fecha Probable</p><p class="text-2xl font-bold text-blue-600 mt-1">${estimacion || "Calculando..."}</p></div></div>`;
        } else if (anterior) { html = `<div class="bg-gray-100 p-3 rounded text-sm text-gray-600">Posterior al √∫ltimo registro (${anterior.fecha}). Deber√≠a ser reciente.</div>`;
        } else if (posterior) { html = `<div class="bg-gray-100 p-3 rounded text-sm text-gray-600">Anterior al primer registro (${posterior.fecha}). Deber√≠a ser antiguo.</div>`;
        } else { html = `<div class="text-gray-400">Sin datos suficientes.</div>`; }
        output.innerHTML = html;
    }

    // --- EVENTOS ---
    window.addEventListener('dragover', e => e.preventDefault()); window.addEventListener('drop', e => e.preventDefault());
    dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-active'));
    dropZone.addEventListener('dragleave', e => { if (e.target === dropZone) dropZone.classList.remove('drag-active'); });
    dropZone.addEventListener('drop', e => { dropZone.classList.remove('drag-active'); handleFiles(e.dataTransfer.files); });
    window.addEventListener('paste', e => { const files = []; Array.from(e.clipboardData.items).forEach(i => { if (i.type.startsWith("image")) files.push(i.getAsFile()); }); handleFiles(files); });
    document.addEventListener('DOMContentLoaded', cargarDatos);
    document.getElementById("numero").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            buscarFecha();
        }
    });

    // --- CRUD Y AUX ---
    function cargarDatos() { licenciasNuevasRef.once('value').then(s => { datosCompletos = []; const d = s.val(); if (d) Object.keys(d).forEach(k => datosCompletos.push({ ...d[k], key: k })); datosCompletos.sort((a, b) => a.numero.localeCompare(b.numero, undefined, { numeric: true })); renderTabla(); }); }
    document.getElementById('mostrarFormularioBtn').onclick = () => { document.getElementById('formularioNuevosDatos').classList.toggle('hidden'); document.getElementById('cpiDataTable').classList.add('hidden'); };
    document.getElementById('mostrarListadoBtn').onclick = () => { document.getElementById('cpiDataTable').classList.toggle('hidden'); document.getElementById('formularioNuevosDatos').classList.add('hidden'); };
    function guardarNuevoNumero() { const num = document.getElementById('nuevoNumero').value.trim().toUpperCase(), date = document.getElementById('nuevaFecha').value; if(!num || !date) return alert("Faltan datos"); const [y,m,d] = date.split('-'); const fFmt = `${d}/${m}/${y}`; if (!validarFormatoItalia(num)) return alert("Formato incorrecto"); const chk = verificarCongruencia(num, fFmt); if(chk.esFraude) return alert(chk.mensajeClaro); licenciasNuevasRef.child(num).set({ numero: num, fecha: fFmt }).then(() => { alert("Guardado OK"); cargarDatos(); }); }
    function guardarDesdeAI() { if(!window.tempAiData) return; licenciasNuevasRef.child(window.tempAiData.numero).set(window.tempAiData).then(() => { alert("A√±adido."); document.getElementById('aiResultBox').classList.add('hidden'); cargarDatos(); }); }
    function renderTabla() { const tb = document.getElementById('cpiList'); tb.innerHTML = ''; [...datosCompletos].sort((a,b) => { const [d1,m1,y1]=a.fecha.split('/'); const [d2,m2,y2]=b.fecha.split('/'); return new Date(`${y2}-${m2}-${d2}`) - new Date(`${y1}-${m1}-${d1}`); }).forEach(d => { tb.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-3 font-mono font-bold">${d.numero}</td><td class="px-4 py-3">${d.fecha}</td><td class="px-4 py-3 text-right"><span onclick="if(confirm('¬øBorrar?')) licenciasNuevasRef.child('${d.key}').remove().then(cargarDatos)" class="text-red-500 font-bold cursor-pointer">X</span></td></tr>`; }); }
  </script>
</body>
</html>
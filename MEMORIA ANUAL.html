<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAD COMMAND CENTER v13.1 (Excel Fix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #0f172a;    /* Azul Noche */
            --bg-body: #f8fafc;    /* Gris muy claro */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body { background-color: var(--bg-body); font-family: 'Segoe UI', system-ui, sans-serif; color: #334155; }

        /* NAVBAR */
        .navbar { background: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: 800; letter-spacing: 1px; font-size: 1.25rem; }
        .nav-link { font-weight: 500; transition: 0.2s; }
        .nav-link.active { background: rgba(255,255,255,0.1); border-radius: 6px; color: #fff !important; }

        /* PANELES */
        .main-panel { display: none; animation: fadeIn 0.4s ease-out; padding-top: 20px; }
        .main-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card-gad { background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: var(--card-shadow); overflow: hidden; margin-bottom: 24px; }
        .card-header-gad { padding: 15px 20px; font-weight: 700; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; color: var(--primary); }

        /* FORMULARIO */
        .form-section { 
            display: none; 
            padding: 20px; 
            background: #f1f5f9; 
            border-radius: 8px; 
            border-left: 5px solid #3b82f6; 
            margin-bottom: 20px; 
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from{opacity:0; transform: translateX(-10px);} to{opacity:1; transform: translateX(0);} }

        /* DIARIO DESGLOSADO (COLORES) */
        .group-header { padding: 12px 20px; color: white; font-weight: bold; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; margin-top: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .bg-header-doc { background: linear-gradient(135deg, #0284c7, #0ea5e9); } /* Azul */
        .bg-header-det { background: linear-gradient(135deg, #dc2626, #ef4444); } /* Rojo */
        .bg-header-veh { background: linear-gradient(135deg, #334155, #475569); } /* Gris Oscuro */
        .bg-header-def { background: linear-gradient(135deg, #64748b, #94a3b8); } /* Gris Claro */

        .table-gad { width: 100%; background: white; border-collapse: collapse; border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px; }
        .table-gad th { font-size: 0.75rem; text-transform: uppercase; background: #f8fafc; color: #64748b; padding: 12px; border-bottom: 2px solid #e2e8f0; }
        .table-gad td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; }
        .table-gad tr:last-child td { border-bottom: none; }
        .table-gad tr:hover { background-color: #f8fafc; }

        /* CONFIG LISTS */
        .config-list-box { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; }
        .list-group-item { border: none; border-bottom: 1px solid #f1f5f9; padding: 8px 12px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* DASHBOARD METRICS */
        .kpi-box { padding: 20px; text-align: center; border-right: 1px solid #f1f5f9; }
        .kpi-box:last-child { border-right: none; }
        .kpi-val { font-size: 2.5rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .kpi-lbl { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #94a3b8; letter-spacing: 1px; margin-top: 5px; }

        /* LOADING */
        .loader { position: fixed; inset: 0; background: rgba(15,23,42,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <i class="fas fa-microchip fa-3x mb-3 fa-spin"></i>
        <h3>GAD SYSTEM v13.1</h3>
        <p class="text-secondary">Cargando módulos de Auto-Aprendizaje...</p>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-robot me-2"></i> GAD PRO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navC"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navC">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" onclick="app.go('panel-reg')"><i class="fas fa-plus-circle"></i> NUEVA</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="app.go('panel-diario')"><i class="fas fa-list-alt"></i> DIARIO</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="app.go('panel-bal')"><i class="fas fa-chart-line"></i> BALANCE</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="app.go('panel-cfg')"><i class="fas fa-cog"></i> CONFIG</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container pb-5">

        <div id="panel-reg" class="main-panel active">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card-gad">
                        <div class="card-header-gad">
                            <span id="form-title"><i class="fas fa-file-signature me-2"></i> Registrar Intervención</span>
                            <button id="btn-cancel" class="btn btn-sm btn-outline-secondary d-none" onclick="app.reset()">Cancelar Edición</button>
                        </div>
                        <div class="card-body p-4">
                            <form id="form-main">
                                <input type="hidden" id="edit-id">
                                
                                <div class="row mb-4">
                                    <div class="col-md-5">
                                        <label class="form-label fw-bold small text-muted">FECHA</label>
                                        <input type="date" class="form-control" id="inp-fecha" required>
                                    </div>
                                    <div class="col-md-7">
                                        <label class="form-label fw-bold small text-muted">CONCEPTO OPERATIVO</label>
                                        <select class="form-select" id="inp-cat" required onchange="app.renderContext()">
                                            <option value="" disabled selected>Cargando...</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="ctx-doc" class="form-section">
                                    <h6 class="text-primary fw-bold mb-3"><i class="fas fa-passport"></i> DATOS DOCUMENTALES</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="small">Tipo Documento</label>
                                            <select class="form-select" id="inp-doc-tipo"><option value="">Seleccione...</option></select>
                                        </div>
                                        <div class="col-6">
                                            <label class="small">País Emisor</label>
                                            <input class="form-control" id="inp-doc-pais" list="dl-paises" placeholder="Escriba o seleccione...">
                                            <datalist id="dl-paises"></datalist>
                                        </div>
                                    </div>
                                </div>

                                <div id="ctx-det" class="form-section" style="border-left-color: #ef4444;">
                                    <h6 class="text-danger fw-bold mb-3"><i class="fas fa-user-lock"></i> DATOS DETENIDO</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="small">Nacionalidad</label>
                                            <input class="form-control" id="inp-det-nac" list="dl-nacionalidades" placeholder="Escriba o seleccione...">
                                            <datalist id="dl-nacionalidades"></datalist>
                                        </div>
                                        <div class="col-6">
                                            <label class="small">Situación</label>
                                            <select class="form-select" id="inp-det-sit">
                                                <option value="REGULAR">REGULAR</option>
                                                <option value="IRREGULAR">IRREGULAR</option>
                                                <option value="DESCONOCIDA">DESCONOCIDA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div id="ctx-veh" class="form-section" style="border-left-color: #334155;">
                                    <h6 class="text-dark fw-bold mb-3"><i class="fas fa-car"></i> ESTADO VEHÍCULO</h6>
                                    <div class="btn-group w-100">
                                        <input type="radio" class="btn-check" name="rad-veh" id="v1" value="SIN MAQUILLAR" checked>
                                        <label class="btn btn-outline-secondary" for="v1">Sin Maquillar</label>
                                        <input type="radio" class="btn-check" name="rad-veh" id="v2" value="MAQUILLADO">
                                        <label class="btn btn-outline-danger" for="v2">Maquillado</label>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold small text-muted">OBSERVACIONES</label>
                                    <textarea class="form-control" id="inp-obs" rows="2"></textarea>
                                </div>

                                <div class="p-3 bg-light rounded border mb-4">
                                    <div class="row align-items-center">
                                        <div class="col-6">
                                            <label class="small fw-bold">DILIGENCIAS / REF</label>
                                            <input class="form-control" id="inp-ref" placeholder="Ej: 1234/25">
                                        </div>
                                        <div class="col-6">
                                            <div id="box-lince" class="d-none">
                                                <label class="small fw-bold text-primary">INDICATIVO LINCE</label>
                                                <select class="form-select fw-bold text-primary" id="sel-lince">
                                                    <option value="">Seleccione...</option>
                                                    <option value="LINCE 10">LINCE 10</option>
                                                    <option value="LINCE 20">LINCE 20</option>
                                                    <option value="LINCE 10 y 20">AMBOS</option>
                                                </select>
                                            </div>
                                            <div id="box-agente" class="d-none">
                                                <label class="small fw-bold text-dark">NÚMERO AGENTE</label>
                                                <input type="number" class="form-control fw-bold" id="inp-agente-num" placeholder="Ej: 1055">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-primary w-100 py-3 fw-bold shadow" id="btn-save">GUARDAR DATOS</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-diario" class="main-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold text-primary mb-0">Diario Operativo</h4>
                <button class="btn btn-success btn-sm" onclick="app.exportExcel()"><i class="fas fa-file-excel me-2"></i>Descargar Excel</button>
            </div>
            <div id="diary-feed"></div>
        </div>

        <div id="panel-bal" class="main-panel">
            <div class="card-gad mb-4">
                <div class="card-header-gad bg-light">
                    <small>FILTROS DE ANÁLISIS</small>
                    <button class="btn btn-xs btn-link text-danger text-decoration-none" onclick="app.resetFilters()">LIMPIAR</button>
                </div>
                <div class="card-body py-3">
                    <div class="row g-2">
                        <div class="col-md-3"><select id="f-cat" class="form-select form-select-sm"><option value="ALL">Concepto: TODOS</option></select></div>
                        <div class="col-md-2"><select id="f-mes" class="form-select form-select-sm"><option value="ALL">Mes: TODOS</option><option value="0">ENERO</option><option value="11">DICIEMBRE</option></select></div>
                        <div class="col-md-3"><select id="f-nac" class="form-select form-select-sm"><option value="ALL">País/Nac: TODOS</option></select></div>
                        <div class="col-md-2"><select id="f-age" class="form-select form-select-sm"><option value="">Agente: TODOS</option><option value="LINCE 10">LINCE 10</option><option value="LINCE 20">LINCE 20</option></select></div>
                        <div class="col-md-2"><button class="btn btn-sm btn-primary w-100" onclick="app.calcStats()">APLICAR</button></div>
                    </div>
                </div>
            </div>

            <div class="card-gad mb-4">
                <div class="row g-0">
                    <div class="col-md-4 kpi-box"><div class="kpi-val" id="kpi-total">0</div><div class="kpi-lbl">Total</div></div>
                    <div class="col-md-4 kpi-box"><div class="kpi-val text-primary h3 mb-0" id="kpi-top-cat">-</div><div class="kpi-lbl">Concepto Top</div></div>
                    <div class="col-md-4 kpi-box"><div class="kpi-val text-success h3 mb-0" id="kpi-top-nac">-</div><div class="kpi-lbl">Nacionalidad Top</div></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4"><div class="card-gad h-100"><div class="card-header-gad">Distribución</div><div class="card-body"><canvas id="chart-pie"></canvas></div></div></div>
                <div class="col-md-6 mb-4"><div class="card-gad h-100"><div class="card-header-gad">Evolución</div><div class="card-body"><canvas id="chart-bar"></canvas></div></div></div>
            </div>

            <div class="card-gad">
                <div class="card-header-gad">Desglose Detallado</div>
                <div class="card-body p-0"><div class="table-responsive"><table class="table-gad table-sm table-striped mb-0"><thead class="bg-light"><tr><th>Detalle</th><th class="text-end">Cant.</th></tr></thead><tbody id="drill-table"></tbody></table></div></div>
            </div>
        </div>

        <div id="panel-cfg" class="main-panel">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card-gad h-100">
                        <div class="card-header-gad">1. Conceptos Operativos</div>
                        <div class="card-body">
                            <form id="f-add-cat" class="input-group mb-2">
                                <input id="new-cat" class="form-control form-control-sm" placeholder="Añadir..." required>
                                <button class="btn btn-sm btn-primary">+</button>
                            </form>
                            <div class="config-list-box"><ul id="list-cat" class="list-group list-group-flush"></ul></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-gad h-100">
                        <div class="card-header-gad">2. Tipos de Documento</div>
                        <div class="card-body">
                            <form id="f-add-doc" class="input-group mb-2">
                                <input id="new-doc" class="form-control form-control-sm" placeholder="Añadir..." required>
                                <button class="btn btn-sm btn-primary">+</button>
                            </form>
                            <div class="config-list-box"><ul id="list-doc" class="list-group list-group-flush"></ul></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-gad h-100 border-info">
                        <div class="card-header-gad text-info">3. Países Emisores</div>
                        <div class="card-body">
                            <form id="f-add-pai" class="input-group mb-2">
                                <input id="new-pai" class="form-control form-control-sm" placeholder="Añadir..." required>
                                <button class="btn btn-sm btn-info text-white">+</button>
                            </form>
                            <div class="config-list-box"><ul id="list-pai" class="list-group list-group-flush"></ul></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-gad h-100 border-danger">
                        <div class="card-header-gad text-danger">4. Nacionalidades</div>
                        <div class="card-body">
                            <form id="f-add-nac" class="input-group mb-2">
                                <input id="new-nac" class="form-control form-control-sm" placeholder="Añadir..." required>
                                <button class="btn btn-sm btn-danger text-white">+</button>
                            </form>
                            <div class="config-list-box"><ul id="list-nac" class="list-group list-group-flush"></ul></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                 <button class="btn btn-outline-danger" onclick="app.factoryReset()"><i class="fas fa-trash-restore me-2"></i> Restaurar Fábrica</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG FIREBASE
        const config = {
            apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDz4",
            authDomain: "gad-alicante-v3.firebaseapp.com",
            databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v3",
            storageBucket: "gad-alicante-v3.firebasestorage.app",
            messagingSenderId: "906986258369",
            appId: "1:906986258369:web:21a7ea29a33b5f395e3940",
            measurementId: "G-Q0E3H1996K"
        };

        const db = getDatabase(initializeApp(config));
        const R = { 
            reg: ref(db,'memoria_anual/registros'), 
            cat: ref(db,'memoria_anual/categorias'), 
            doc: ref(db,'memoria_anual/tipos_documento'),
            pai: ref(db,'memoria_anual/paises'),          
            nac: ref(db,'memoria_anual/nacionalidades')   
        };

        let DATA = [];
        let LISTS = { paises: [], nacionalidades: [] }; // Cache local para autolearn
        let CHARTS = { p: null, b: null };

        const App = {
            go: (id) => {
                document.querySelectorAll('.main-panel').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
                event.target.closest('.nav-link').classList.add('active');
                if(id === 'panel-diario') App.renderDiary();
                if(id === 'panel-bal') App.calcStats();
            },

            renderContext: () => {
                const cat = document.getElementById('inp-cat').value.toLowerCase();
                document.querySelectorAll('.form-section').forEach(e => e.style.display = 'none');
                
                let isOps = false;
                if(cat.includes('documento')) { document.getElementById('ctx-doc').style.display='block'; isOps=true; }
                else if(cat.includes('detenido')) { document.getElementById('ctx-det').style.display='block'; isOps=true; }
                else if(cat.includes('veh')) { document.getElementById('ctx-veh').style.display='block'; isOps=true; }
                
                if(isOps) {
                    document.getElementById('box-lince').classList.remove('d-none');
                    document.getElementById('box-agente').classList.add('d-none');
                } else {
                    document.getElementById('box-lince').classList.add('d-none');
                    document.getElementById('box-agente').classList.remove('d-none');
                }
            },

            // AUTO-APRENDIZAJE AL GUARDAR
            save: (e) => {
                e.preventDefault();
                const cat = document.getElementById('inp-cat').value;
                const catL = cat.toLowerCase();
                const id = document.getElementById('edit-id').value;

                let agente = "";
                if(!document.getElementById('box-lince').classList.contains('d-none')) agente = document.getElementById('sel-lince').value;
                else agente = "Agente " + document.getElementById('inp-agente-num').value;

                const data = {
                    fecha: document.getElementById('inp-fecha').value,
                    categoria: cat,
                    obs: document.getElementById('inp-obs').value,
                    ref: document.getElementById('inp-ref').value,
                    agente: agente,
                    timestamp: Date.now()
                };

                if(catL.includes('doc')) {
                    data.d1 = document.getElementById('inp-doc-tipo').value;
                    data.d2 = document.getElementById('inp-doc-pais').value.toUpperCase().trim();
                    // AUTO LEARN PAIS
                    if(data.d2 && !LISTS.paises.includes(data.d2)) push(R.pai, {nombre: data.d2});
                } else if(catL.includes('det')) {
                    data.d1 = document.getElementById('inp-det-nac').value.toUpperCase().trim();
                    data.d2 = document.getElementById('inp-det-sit').value;
                    // AUTO LEARN NAC
                    if(data.d1 && !LISTS.nacionalidades.includes(data.d1)) push(R.nac, {nombre: data.d1});
                } else if(catL.includes('veh')) {
                    document.getElementsByName('rad-veh').forEach(r=>{if(r.checked) data.d1=r.value});
                }

                if(id) set(ref(db, `memoria_anual/registros/${id}`), data);
                else push(R.reg, data);
                
                alert("Guardado");
                App.reset();
            },

            edit: (id) => {
                const r = DATA.find(x => x.id === id);
                if(!r) return;
                
                App.go('panel-reg');
                document.getElementById('edit-id').value = id;
                document.getElementById('inp-fecha').value = r.fecha;
                document.getElementById('inp-cat').value = r.categoria;
                document.getElementById('inp-obs').value = r.obs || '';
                document.getElementById('inp-ref').value = r.ref || '';
                
                App.renderContext();

                if(r.agente && r.agente.includes('Agente')) document.getElementById('inp-agente-num').value = r.agente.replace('Agente ','');
                else document.getElementById('sel-lince').value = r.agente;

                const catL = r.categoria.toLowerCase();
                setTimeout(() => {
                    if(catL.includes('doc')) { document.getElementById('inp-doc-tipo').value=r.d1; document.getElementById('inp-doc-pais').value=r.d2; }
                    else if(catL.includes('det')) { document.getElementById('inp-det-nac').value=r.d1; document.getElementById('inp-det-sit').value=r.d2; }
                    else if(catL.includes('veh')) { document.getElementsByName('rad-veh').forEach(rd=>{if(rd.value===r.d1) rd.checked=true}); }
                }, 50);

                document.getElementById('form-title').innerHTML = '<span class="text-warning">EDITANDO REGISTRO</span>';
                document.getElementById('btn-save').innerText = 'ACTUALIZAR DATOS';
                document.getElementById('btn-save').classList.replace('btn-primary','btn-warning');
                document.getElementById('btn-cancel').classList.remove('d-none');
            },

            reset: () => {
                document.getElementById('form-main').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('inp-fecha').valueAsDate = new Date();
                document.querySelectorAll('.form-section').forEach(e => e.style.display = 'none');
                document.getElementById('form-title').innerHTML = '<i class="fas fa-file-signature me-2"></i> Registrar Intervención';
                document.getElementById('btn-save').innerText = 'GUARDAR DATOS';
                document.getElementById('btn-save').classList.replace('btn-warning','btn-primary');
                document.getElementById('btn-cancel').classList.add('d-none');
            },

            renderDiary: () => {
                const box = document.getElementById('diary-feed'); box.innerHTML = '';
                if(!DATA.length) { box.innerHTML = '<div class="text-center p-5 text-muted">Sin datos</div>'; return; }
                const groups = {};
                DATA.forEach(r => { if(!groups[r.categoria]) groups[r.categoria]=[]; groups[r.categoria].push(r); });

                Object.keys(groups).sort().forEach(cat => {
                    const recs = groups[cat]; const catL = cat.toLowerCase();
                    let bgClass = 'bg-header-def';
                    if(catL.includes('doc')) bgClass = 'bg-header-doc';
                    if(catL.includes('det')) bgClass = 'bg-header-det';
                    if(catL.includes('veh')) bgClass = 'bg-header-veh';

                    let h1 = "Detalle", h2 = "Extra";
                    if(catL.includes('doc')) { h1="TIPO"; h2="PAÍS"; }
                    else if(catL.includes('det')) { h1="NACIONALIDAD"; h2="SITUACIÓN"; }
                    else if(catL.includes('veh')) { h1="ESTADO"; h2="-"; }

                    let html = `<div class="group-header ${bgClass}"><span>${cat}</span><span class="badge bg-white text-dark">${recs.length}</span></div>
                        <table class="table-gad"><thead><tr><th width="15%">FECHA</th><th width="30%">${h1}</th><th width="20%">${h2}</th><th width="20%">AGENTE</th><th width="15%" class="text-end">GESTIÓN</th></tr></thead><tbody>`;

                    recs.forEach(r => {
                        html += `<tr><td>${r.fecha.split('-').reverse().join('/')}</td><td class="fw-bold text-dark">${r.d1 || '-'}</td><td>${r.d2 || '-'}</td><td class="small text-muted fw-bold">${r.agente || ''}</td>
                        <td class="text-end"><button class="btn btn-sm btn-link text-warning p-0 me-2" onclick="app.edit('${r.id}')"><i class="fas fa-pencil-alt"></i></button><button class="btn btn-sm btn-link text-danger p-0" onclick="window.delReg('${r.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                    html += `</tbody></table>`; box.innerHTML += html;
                });
            },

            calcStats: () => {
                const fCat = document.getElementById('f-cat').value; const fMes = document.getElementById('f-mes').value; const fNac = document.getElementById('f-nac').value; const fAge = document.getElementById('f-age').value;
                const res = DATA.filter(r => {
                    const m = new Date(r.fecha).getMonth().toString();
                    const nac = r.d2 || r.d1 || ''; 
                    return (fCat==='ALL'||r.categoria===fCat) && (fMes==='ALL'||m===fMes) && (fNac==='ALL'|| (r.d1===fNac || r.d2===fNac)) && (fAge==='' || (r.agente && r.agente.includes(fAge)));
                });

                document.getElementById('kpi-total').innerText = res.length;
                const cCat = {}; const cNac = {}; const cMes = Array(12).fill(0); const drill = {};
                res.forEach(r => {
                    cCat[r.categoria] = (cCat[r.categoria]||0)+1;
                    if(r.categoria.toLowerCase().includes('doc')) { if(r.d2) cNac[r.d2]=(cNac[r.d2]||0)+1; }
                    else if(r.categoria.toLowerCase().includes('det')) { if(r.d1) cNac[r.d1]=(cNac[r.d1]||0)+1; }
                    cMes[new Date(r.fecha).getMonth()]++;
                    const k = `${r.categoria} - ${r.d1||''} ${r.d2||''}`; drill[k] = (drill[k]||0)+1;
                });

                const getTop = o => Object.entries(o).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
                document.getElementById('kpi-top-cat').innerText = getTop(cCat);
                document.getElementById('kpi-top-nac').innerText = getTop(cNac);

                if(CHARTS.p) CHARTS.p.destroy();
                CHARTS.p = new Chart(document.getElementById('chart-pie'), {type:'doughnut', data:{labels:Object.keys(cCat), datasets:[{data:Object.values(cCat), backgroundColor:['#0f172a','#3b82f6','#ef4444','#10b981','#f59e0b']}]}, options:{maintainAspectRatio:false, plugins:{legend:{position:'right'}}}});

                if(CHARTS.b) CHARTS.b.destroy();
                CHARTS.b = new Chart(document.getElementById('chart-bar'), {type:'bar', data:{labels:['E','F','M','A','M','J','J','A','S','O','N','D'], datasets:[{label:'Intervenciones', data:cMes, backgroundColor:'#0f172a', borderRadius:4}]}, options:{maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}});

                const dt = document.getElementById('drill-table'); dt.innerHTML = '';
                Object.entries(drill).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => dt.innerHTML += `<tr><td>${k}</td><td class="text-end fw-bold">${v}</td></tr>`);
            },

            resetFilters: () => { document.getElementById('f-cat').value='ALL'; document.getElementById('f-mes').value='ALL'; document.getElementById('f-nac').value='ALL'; document.getElementById('f-age').value=''; App.calcStats(); },

            renderList: (snap, elId, btnFn, cacheArray) => {
                const el = document.getElementById(elId); el.innerHTML = '';
                if(cacheArray) cacheArray.length = 0; // Clear cache
                if(snap) Object.entries(snap).forEach(([k,v]) => {
                    if(cacheArray) cacheArray.push(v.nombre); // Populate cache
                    el.innerHTML += `<li class="list-group-item">${v.nombre} <button class="btn btn-sm text-danger" onclick="${btnFn}('${k}')"><i class="fas fa-trash"></i></button></li>`;
                });
            },
            
            fillSelect: (snap, elId) => {
                const el = document.getElementById(elId); const old = el.value;
                el.innerHTML = elId==='f-cat'||elId==='f-nac' ? '<option value="ALL">TODOS</option>' : '<option value="">Seleccione...</option>';
                if(snap) { const vals=new Set(); Object.values(snap).forEach(v=>vals.add(v.nombre)); Array.from(vals).sort().forEach(v=>el.innerHTML+=`<option value="${v}">${v}</option>`); }
                el.value = old; 
            },
            
            // Llenar Datalists
            fillDatalist: (snap, elId) => {
                const el = document.getElementById(elId); el.innerHTML = '';
                if(snap) { const vals=new Set(); Object.values(snap).forEach(v=>vals.add(v.nombre)); Array.from(vals).sort().forEach(v=>el.innerHTML+=`<option value="${v}">`); }
            },

            exportExcel: () => {
                if(!DATA.length) { alert("Sin datos"); return; }
                const d = DATA.map(r => ({
                    "FECHA": r.fecha.split('-').reverse().join('/'),
                    "CONCEPTO": r.categoria,
                    "DETALLE 1 (Tipo/Nac/Estado)": r.d1 || '-',
                    "DETALLE 2 (País/Sit)": r.d2 || '-',
                    "AGENTE/INDICATIVO": r.agente || '',
                    "REFERENCIA": r.ref || '',
                    "OBSERVACIONES": r.obs || ''
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(d);
                // Ajustar columnas
                ws['!cols'] = [{wch:12}, {wch:30}, {wch:25}, {wch:20}, {wch:15}, {wch:15}, {wch:40}];
                XLSX.utils.book_append_sheet(wb, ws, "GAD_DIARIO");
                XLSX.writeFile(wb, "GAD_Reporte_Oficial.xlsx");
            },

            factoryReset: () => {
                if(confirm("¿Restaurar?")) {
                    ["Documento Falso Intervenido", "Detenido", "Vehículo Robado Recuperado", "Diligencias Prevención", "Informe Pericial"].forEach(x => push(R.cat, {nombre:x}));
                    ["PERMISO CONDUCIR", "DNI / CARTA", "PASAPORTE", "ITV", "SEGURO"].forEach(x => push(R.doc, {nombre:x}));
                }
            }
        };

        // LISTENERS
        window.app = App;
        window.delReg = (id) => confirm("¿Borrar?") && remove(ref(db, `memoria_anual/registros/${id}`));
        window.delCat = (id) => confirm("¿Borrar?") && remove(ref(db, `memoria_anual/categorias/${id}`));
        window.delDoc = (id) => confirm("¿Borrar?") && remove(ref(db, `memoria_anual/tipos_documento/${id}`));
        window.delPai = (id) => confirm("¿Borrar?") && remove(ref(db, `memoria_anual/paises/${id}`));
        window.delNac = (id) => confirm("¿Borrar?") && remove(ref(db, `memoria_anual/nacionalidades/${id}`));

        document.getElementById('form-main').addEventListener('submit', App.save);
        
        // ADD HANDLERS CONFIG
        const addH = (fid, inpId, refNode) => document.getElementById(fid).addEventListener('submit', e=>{e.preventDefault(); push(refNode, {nombre:document.getElementById(inpId).value.toUpperCase()}); e.target.reset();});
        addH('f-add-cat','new-cat',R.cat); addH('f-add-doc','new-doc',R.doc);
        addH('f-add-pai','new-pai',R.pai); addH('f-add-nac','new-nac',R.nac);

        // DATA SYNC
        onValue(R.cat, s => { App.renderList(s.val(), 'list-cat', 'delCat'); App.fillSelect(s.val(), 'inp-cat'); App.fillSelect(s.val(), 'f-cat'); });
        onValue(R.doc, s => { App.renderList(s.val(), 'list-doc', 'delDoc'); App.fillSelect(s.val(), 'inp-doc-tipo'); });
        
        // Nuevas listas Auto-Learn
        onValue(R.pai, s => { App.renderList(s.val(), 'list-pai', 'delPai', LISTS.paises); App.fillDatalist(s.val(), 'dl-paises'); });
        onValue(R.nac, s => { App.renderList(s.val(), 'list-nac', 'delNac', LISTS.nacionalidades); App.fillDatalist(s.val(), 'dl-nacionalidades'); App.fillSelect(s.val(), 'f-nac'); });

        onValue(R.reg, s => {
            document.getElementById('loader').style.display='none';
            DATA = [];
            if(s.val()) Object.entries(s.val()).forEach(([k,v]) => DATA.push({id:k, ...v}));
            DATA.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            App.renderDiary(); App.calcStats();
        });

        document.getElementById('inp-fecha').valueAsDate = new Date();
    </script>
</body>
</html>
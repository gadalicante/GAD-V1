<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACTA INFRACCI√ìN ADUANERA (IA INTEGRADA)</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ESTILOS B√ÅSICOS (Heredados del Dise√±o 2 - Aduanas) */
        * { box-sizing: border-box; }
        body { background-color: #374151; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
        
        /* HOJA A4 */
        .page-a4 {
            width: 210mm; height: 297mm; background: white; margin: 20px auto; padding: 10mm;
            box-shadow: 0 0 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: all 0.2s;
        }

        /* REJILLA Y CELDAS */
        .form-container { border: 2px solid black; width: 100%; display: flex; flex-direction: column; }
        .acta-row { display: flex; width: 100%; border-bottom: 1px solid black; }
        .acta-row:last-child { border-bottom: none; }
        .field-container { position: relative; display: flex; flex-direction: column; padding: 2px 5px; min-width: 0; border-right: 1px solid black; overflow: hidden; }
        .field-container.is-last { border-right: none; flex-grow: 1 !important; width: auto !important; }

        /* TEXTOS */
        .label { font-size: 10px; font-weight: bold; margin-bottom: 1px; white-space: nowrap; overflow: hidden; color: #000; }
        .input-data { width: 100%; font-family: 'Courier New', monospace; font-weight: bold; outline: none; background: transparent; border: none; padding: 0; color: #000; }
        textarea.input-data { resize: none; overflow: hidden; line-height: 1.2; }
        
        .section-bar { background-color: #d1d5db; border-top: 1px solid black; border-bottom: 1px solid black; font-weight: bold; text-align: center; font-size: 11px; padding: 3px; text-transform: uppercase; width: 100%; margin-top: -1px; z-index: 2; position: relative; display: flex; justify-content: center; align-items: center;}
        
        /* ESTILOS ADUANAS (Checkboxes y Legal) */
        .legal-block { margin-top: 10px; border: 1px solid #000; padding: 5px; font-size: 9px; }
        .checkbox-row { display: flex; align-items: flex-start; margin-bottom: 6px; cursor: pointer; }
        .checkbox-box { width: 14px; height: 14px; border: 1px solid #000; margin-right: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .checkbox-text { text-align: justify; line-height: 1.1; color: #000; flex-grow: 1; }
        .summons-text { margin-top: 10px; font-size: 10px; font-weight: bold; text-align: justify; border: 1px solid #000; padding: 5px; background: #f3f4f6; }
        .docs-text { margin-top: 5px; font-size: 9px; font-style: italic; text-align: justify; }

        /* MODIFICACIONES IA Y VISUALIZACI√ìN */
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.96); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODO EDICI√ìN */
        .editing .field-container { background: rgba(59, 130, 246, 0.05); box-shadow: inset 0 0 0 1px #3b82f6; cursor: default; }
        .editing { user-select: none; } 
        .editing .input-data { pointer-events: none; opacity: 0.5; }
        .resizer { position: absolute; right: -5px; top: 0; bottom: 0; width: 10px; cursor: col-resize; z-index: 50; display: flex; justify-content: center; align-items: center; }
        .resizer::after { content: ''; width: 1px; height: 100%; background: #3b82f6; display: none; }
        .editing .resizer:hover::after { display: block; }
        .edit-controls { position: absolute; top: 0; right: 0; display: none; background: white; border: 1px solid #ccc; z-index: 60; }
        .editing .field-container:hover .edit-controls { display: flex; }

        /* ZONAS IA (Del archivo 1) */
        .drop-zone-conductor { outline: 2px solid transparent; transition: all 0.2s; }
        .drop-zone-vehicle { outline: 2px solid transparent; transition: all 0.2s; } /* Renombrado de titular a vehicle para l√≥gica */

        .drop-zone-conductor:focus-within, .drop-zone-conductor.drag-active {
            background-color: rgba(34, 197, 94, 0.05);
            outline: 2px dashed #22c55e;
            outline-offset: -2px;
        }
        
        .drop-zone-vehicle:focus-within, .drop-zone-vehicle.drag-active {
            background-color: rgba(59, 130, 246, 0.05);
            outline: 2px dashed #3b82f6;
            outline-offset: -2px;
        }

        .context-menu {
            position: fixed; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            z-index: 1000; padding: 5px 0; border-radius: 4px; font-size: 12px; min-width: 150px;
        }
        .context-menu-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .context-menu-item:hover { background-color: #f3f4f6; }

        /* IMPRESI√ìN */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body * { visibility: hidden; }
            body { margin: 0; padding: 0; overflow: hidden !important; background: white; height: 100%; }
            .page-a4, .page-a4 * { visibility: visible; }
            .page-a4 { position: absolute; left: 0; top: 0; width: 210mm !important; height: 297mm !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .form-container, .legal-block, .summons-text, .checkbox-box { border-color: black !important; }
            .acta-row { border-bottom: 1px solid black !important; }
            .field-container { border-right: 1px solid black !important; }
            .field-container.is-last { border-right: none !important; }
            .section-bar { background-color: #d1d5db !important; border-top: 1px solid black !important; border-bottom: 1px solid black !important; }
            .summons-text { background-color: #f3f4f6 !important; }
            .no-print, .edit-controls, .resizer, .loading-overlay, .context-menu, .paste-btn { display: none !important; }
            .editing .field-container { background: transparent !important; box-shadow: none !important; }
            .drop-zone-conductor, .drop-zone-vehicle { background: transparent !important; outline: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ESTRUCTURA DEL ARCHIVO 2 (ADUANAS) ---
        const initialTemplate = [
            // FILA 1: Contexto general
            { 
                type: 'row', 
                id: 'r1', 
                fields: [
                    {id:'expediente', label:'Eurocop N¬∞:', width:20}, 
                    {id:'fecha', label:'Fecha:', width:15, isDate: true}, 
                    {id:'hora', label:'Hora:', width:10}, 
                    {id:'agente1', label:'Agente 1 (NIP):', width:27.5}, 
                    {id:'agente2', label:'Agente 2 (NIP):', width:27.5}
                ] 
            },
            // FILA 2: Lugar
            { type: 'row', id: 'r2', fields: [{id:'lugar', label:'Lugar de la infracci√≥n:', width:100}] },
            
            // SECCI√ìN CONDUCTOR (ZONA IA 1)
            { type: 'section', title: 'IDENTIFICACI√ìN DEL CONDUCTOR', zone: 'conductor' },
            { type: 'row', id: 'r3', zone: 'conductor', fields: [{id:'c_ape', label:'Apellidos', width:50}, {id:'c_nom', label:'Nombre', width:30}, {id:'c_doc', label:'NIE/PSP/Otro', width:20}] },
            { 
                type: 'row', 
                id: 'r4', 
                zone: 'conductor',
                fields: [
                    {id:'c_nac', label:'Nacionalidad', width:30}, 
                    {id:'c_lug', label:'Lugar Nac.', width:30}, 
                    {id:'c_fna', label:'F. Nacimiento', width:20, isDate: true}, 
                    {id:'c_tel', label:'Tlf/Mail', width:20}
                ] 
            },
            { type: 'row', id: 'r5', zone: 'conductor', fields: [{id:'c_dom', label:'Domicilio', width:50}, {id:'c_ciu', label:'Ciudad', width:30}, {id:'c_pai', label:'Pa√≠s', width:20}] },

            // SECCI√ìN VEH√çCULO (ZONA IA 2)
            { type: 'section', title: 'DATOS DEL VEH√çCULO', zone: 'vehicle' },
            { type: 'row', id: 'r6', zone: 'vehicle', fields: [{id:'v_nac', label:'Nacionalidad', width:20}, {id:'v_mar', label:'Marca', width:30}, {id:'v_mod', label:'Modelo', width:50}] },
            { type: 'row', id: 'r7', zone: 'vehicle', fields: [{id:'v_mat', label:'Matr√≠cula', width:30}, {id:'v_bas', label:'N.¬∫ Bastidor', width:40}, {id:'v_col', label:'Color', width:30}] },
            { 
                type: 'row', 
                id: 'r8', 
                zone: 'vehicle',
                fields: [
                    {id:'v_cil', label:'Cilindrada', width:15},   
                    {id:'v_com', label:'Combustible', width:15},  
                    {id:'v_1ma', label:'Fecha 1¬™ Matric.', width:15, isDate: true}, 
                    {id:'v_tit', label:'Titular', width:55}      
                ] 
            },

            // SECCI√ìN OBSERVACIONES
            { type: 'section', title: 'OBSERVACIONES' },
            { 
                type: 'row', 
                id: 'r_obs', 
                customHeight: '80px', 
                fields: [{id:'observaciones', label:'Observaciones adicionales:', width:100, isMultiline: true}] 
            }
        ];

        // --- COMPONENTE INPUT AUTO-AJUSTABLE (Fusi√≥n de l√≥gica) ---
        const AutoResizingInput = ({ value, onChange, disabled, widthDependency, isMultiline, isDate }) => {
            const inputRef = React.useRef(null);
            const [fontSize, setFontSize] = React.useState(12);

            const adjustSingleLine = () => {
                const input = inputRef.current;
                if (!input || !value) { setFontSize(12); return; }
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                context.font = "bold 12px 'Courier New', monospace";
                const textWidthAt12 = context.measureText(value).width;
                const availableWidth = input.clientWidth;

                if (textWidthAt12 <= availableWidth) {
                    setFontSize(12);
                } else {
                    const ratio = availableWidth / textWidthAt12;
                    setFontSize(Math.max(8, Math.floor(12 * ratio)));
                }
            };

            const adjustMultiLine = () => {
                const input = inputRef.current;
                if (!input) return;
                input.style.fontSize = '12px';
                let currentSize = 12;
                while (input.scrollHeight > input.clientHeight && currentSize > 7) {
                    currentSize--;
                    input.style.fontSize = `${currentSize}px`;
                }
                setFontSize(currentSize);
            };

            const handleChange = (e) => {
                let finalValue = e.target.value;
                if (isDate) {
                    const digits = finalValue.replace(/\D/g, '').slice(0, 8);
                    if (digits.length >= 5) finalValue = `${digits.slice(0,2)}/${digits.slice(2,4)}/${digits.slice(4)}`;
                    else if (digits.length >= 3) finalValue = `${digits.slice(0,2)}/${digits.slice(2)}`;
                    else finalValue = digits;
                }
                onChange({ target: { value: finalValue } });
            };

            React.useLayoutEffect(() => {
                if (isMultiline) adjustMultiLine();
                else adjustSingleLine();
            }, [value, widthDependency, isMultiline]);

            if (isMultiline) {
                return <textarea ref={inputRef} className="input-data" value={value || ''} onChange={handleChange} disabled={disabled} spellCheck="false" style={{ fontSize: `${fontSize}px`, height: '100%', whiteSpace: 'pre-wrap' }} />;
            }

            return <input ref={inputRef} className="input-data" value={value || ''} onChange={handleChange} disabled={disabled} autoComplete="off" style={{ fontSize: `${fontSize}px` }} />;
        };

        const App = () => {
            const [template, setTemplate] = React.useState(initialTemplate);
            const [formData, setFormData] = React.useState({});
            const [actas, setActas] = React.useState({});
            const [isEditMode, setIsEditMode] = React.useState(false);
            const [logos, setLogos] = React.useState({ left: 'AYUNTAMIENTO.png', right: 'POLICIA.png' });
            const [checkState, setCheckState] = React.useState(0);
            
            // ESTADOS IA (Del archivo 1)
            const [processing, setProcessing] = React.useState({active: false, msg: ''});
            const [dragTarget, setDragTarget] = React.useState(null); 
            const [dragState, setDragState] = React.useState(null); 
            const [contextMenu, setContextMenu] = React.useState(null);
            
            // CONFIGURACI√ìN API
            const [apiKey, setApiKey] = React.useState(localStorage.getItem('ai_api_key') || '');
            const [geminiModelName, setGeminiModelName] = React.useState(localStorage.getItem('gemini_model_name') || 'gemini-2.5-flash');
            const [showKeyInput, setShowKeyInput] = React.useState(false);

            React.useEffect(() => {
                // Usamos una nueva clave para localStorage para no mezclar con las otras plantillas
                const stored = JSON.parse(localStorage.getItem('mis_actas_aduanas_ai') || "{}");
                setActas(stored);
                const l = JSON.parse(localStorage.getItem('mis_logos_aduanas_v2'));
                if(l) setLogos(l);
                
                if (!localStorage.getItem('ai_provider')) localStorage.setItem('ai_provider', 'gemini');
                if (!localStorage.getItem('gemini_model_name')) localStorage.setItem('gemini_model_name', geminiModelName);

                autoFillData();
                const closeMenu = () => setContextMenu(null);
                window.addEventListener('click', closeMenu);
                return () => window.removeEventListener('click', closeMenu);
            }, []);

            const autoFillData = () => {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                
                setFormData(prev => {
                    if (Object.keys(prev).length === 0) {
                        return {
                            ...prev,
                            fecha: `${day}/${month}/${year}`, 
                            hora: now.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'}),
                            agente1: (now.getHours() < 14) ? "G-118" : "G-279",
                            agente2: (now.getHours() < 14) ? "G-448" : "G-496",
                            lugar: "ALICANTE, "
                        };
                    }
                    return prev;
                });
            };

            const saveSettings = (key, geminiModel) => {
                setApiKey(key); setGeminiModelName(geminiModel);
                localStorage.setItem('ai_api_key', key);
                localStorage.setItem('gemini_model_name', geminiModel);
            };

            // --- L√ìGICA DE PROMPTS ACTUALIZADA PARA CAMPOS DE ADUANAS ---
            const getPromptForZone = (zone) => {
                if (zone === 'conductor') {
                    // Mapeo a ids del template: c_ape, c_nom, c_doc, c_nac, c_lug, c_fna, c_tel, c_dom, c_ciu, c_pai
                    return `Analiza esta imagen (DNI, Pasaporte, Carnet). Extrae datos del CONDUCTOR. JSON keys exactas: { 
                        "c_nom": "Nombre (sin apellidos)", 
                        "c_ape": "Apellidos", 
                        "c_doc": "DNI/NIE/Pasaporte", 
                        "c_nac": "Nacionalidad",
                        "c_lug": "Lugar de nacimiento",
                        "c_fna": "Fecha nacimiento (DD/MM/AAAA)", 
                        "c_tel": "Tel√©fono",
                        "c_dom": "Domicilio/Direcci√≥n", 
                        "c_ciu": "Ciudad/Municipio",
                        "c_pai": "Pa√≠s direcci√≥n"
                    }. Formatea fechas a DD/MM/AAAA.`;
                } else {
                    // Mapeo a ids del template: v_nac, v_mar, v_mod, v_mat, v_bas, v_col, v_cil, v_com, v_1ma, v_tit
                    return `Analiza esta imagen (Permiso Circulaci√≥n, Ficha T√©cnica). Extrae datos del VEH√çCULO. JSON keys exactas: { 
                        "v_nac": "Nacionalidad del veh√≠culo (E, F, D...)", 
                        "v_mar": "Marca", 
                        "v_mod": "Modelo", 
                        "v_mat": "Matr√≠cula", 
                        "v_bas": "N√∫mero de Bastidor/VIN", 
                        "v_col": "Color", 
                        "v_cil": "Cilindrada",
                        "v_com": "Combustible",
                        "v_1ma": "Fecha 1¬™ Matriculaci√≥n (DD/MM/AAAA)", 
                        "v_tit": "Nombre completo del Titular" 
                    }. Formatea fechas a DD/MM/AAAA.`;
                }
            };

            const callAI = async (base64Image, zone) => {
                const PROMPT = getPromptForZone(zone);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModelName}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    const extractedData = JSON.parse(rawText);

                    setFormData(prev => {
                        const newData = { ...prev };
                        Object.keys(extractedData).forEach(key => {
                            const val = extractedData[key];
                            if (val && String(val).trim().length > 0) {
                                newData[key] = val;
                            }
                        });
                        return newData;
                    });

                } catch (error) {
                    alert(`Error Gemini: ` + error.message);
                }
            };

            const processImage = async (file, zone) => {
                if (!apiKey) { alert("¬°FALTA LA CLAVE API! Config√∫rala en el men√∫ lateral."); return; }
                setProcessing({active: true, msg: `Analizando para ${zone.toUpperCase()}...`});
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.toString().replace(/^data:(.*,)?/, '');
                    try { await callAI(base64, zone); } finally { setProcessing({active: false, msg: ''}); setDragTarget(null); }
                };
            };

            const pasteFromClipboard = async (zone) => {
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        const type = item.types.find(t => t.startsWith('image/'));
                        if (type) {
                            const blob = await item.getType(type);
                            const file = new File([blob], "clipboard.png", { type });
                            processImage(file, zone);
                            return;
                        }
                    }
                    alert("No hay im√°genes en el portapapeles.");
                } catch (err) {
                    console.error(err);
                    alert("Por seguridad del navegador, haz clic en la zona " + zone.toUpperCase() + " y pulsa Ctrl+V.");
                }
            };

            const handleDragOver = (e, zone) => { e.preventDefault(); e.stopPropagation(); if (dragTarget !== zone) setDragTarget(zone); };
            const handleDrop = (e, zone) => { e.preventDefault(); e.stopPropagation(); setDragTarget(null); if (e.dataTransfer.files[0]) processImage(e.dataTransfer.files[0], zone); };
            
            const handleGlobalPaste = (e) => {
                const activeEl = document.activeElement;
                let targetZone = 'conductor'; 
                if (activeEl && activeEl.closest('.drop-zone-vehicle')) { targetZone = 'vehicle'; }
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf("image") === 0) {
                        processImage(item.getAsFile(), targetZone);
                        return;
                    }
                }
            };

            const handleContextMenu = (e, zone) => {
                e.preventDefault();
                setContextMenu({ x: e.clientX, y: e.clientY, zone });
            };

            // L√≥gica redimensionamiento (del archivo 2, adaptada)
            React.useEffect(() => {
                const handleMove = (e) => { if (!dragState) return; e.preventDefault(); const row = document.getElementById(`row-${dragState.rIdx}`); if(!row) return; const delta = ((e.clientX - dragState.startX) / row.offsetWidth) * 100; setTemplate(prev => { const n = [...prev]; n[dragState.rIdx].fields[dragState.fIdx].width = Math.max(5, dragState.startW + delta); return n; }); };
                const handleUp = () => setDragState(null);
                if(dragState) { window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleUp); }
                return () => { window.removeEventListener('mousemove', handleMove); window.removeEventListener('mouseup', handleUp); };
            }, [dragState]);

            const startResize = (e, rIdx, fIdx, w) => { e.preventDefault(); e.stopPropagation(); setDragState({rIdx, fIdx, startX: e.clientX, startW: w}); };
            const duplicateField = (r, f) => { const t=[...template]; const o=t[r].fields[f]; t[r].fields.splice(f+1,0,{...o, id:Date.now(), label:o.label+' (C)', width:15}); o.width-=15; setTemplate(t); };
            const deleteField = (r, f) => { const t=[...template]; const w=t[r].fields[f].width; t[r].fields.splice(f,1); if(t[r].fields[0]) t[r].fields[0].width+=w; setTemplate(t); };
            
            const saveActa = () => { 
                const defaultName = formData['expediente'] || formData['v_mat'] || "Acta "+Date.now();
                const id=prompt("Nombre para guardar:", defaultName); 
                if(!id) return; 
                const n={...actas, [id]:{id, nombre:id, fecha:new Date(), data:formData, template, checkState}}; 
                setActas(n); 
                localStorage.setItem('mis_actas_aduanas_ai',JSON.stringify(n)); 
            };

            const loadActa = (id) => { const a=actas[id]; if(a){ setFormData(a.data); if(a.template) setTemplate(a.template); if(a.checkState !== undefined) setCheckState(a.checkState); } };
            const deleteActa = (e,id) => { e.stopPropagation(); const n={...actas}; delete n[id]; setActas(n); localStorage.setItem('mis_actas_aduanas_ai',JSON.stringify(n)); };

            // Renderizado de filas
            const renderRow = (item, rIdx) => (
                <div key={item.id} id={`row-${rIdx}`} className="acta-row" style={item.customHeight ? {height: item.customHeight} : {}}>
                    {item.fields.map((f, fIdx) => {
                        const isLast = fIdx === item.fields.length - 1;
                        return (
                            <div key={f.id} className={`field-container ${isLast ? 'is-last' : ''}`} style={{ width: isLast ? 'auto' : `${f.width}%` }}>
                                <div className="label" contentEditable={isEditMode} suppressContentEditableWarning>{f.label}</div>
                                <AutoResizingInput 
                                    value={formData[f.id]} 
                                    onChange={(e) => setFormData({...formData, [f.id]:e.target.value})} 
                                    disabled={isEditMode}
                                    widthDependency={f.width}
                                    isMultiline={f.isMultiline}
                                    isDate={f.isDate}
                                />
                                {isEditMode && (
                                    <>
                                        <div className="edit-controls">
                                            <button onClick={()=>duplicateField(rIdx,fIdx)} className="bg-blue-100 text-blue-700 text-[10px] px-1.5 py-0.5 hover:bg-blue-200 border-r border-blue-200">+</button>
                                            <button onClick={()=>deleteField(rIdx,fIdx)} className="bg-red-100 text-red-700 text-[10px] px-1.5 py-0.5 hover:bg-red-200">x</button>
                                        </div>
                                        {!isLast && <div className="resizer" onMouseDown={(e)=>startResize(e, rIdx, fIdx, f.width)}></div>}
                                    </>
                                )}
                            </div>
                        );
                    })}
                </div>
            );

            const SectionHeaderWithPaste = ({ title, zone }) => (
                <div className="section-bar relative group" contentEditable={isEditMode} suppressContentEditableWarning>
                    {title}
                    <button onClick={(e) => { e.stopPropagation(); pasteFromClipboard(zone); }} className="paste-btn absolute right-2 top-0.5 bg-gray-600 hover:bg-gray-800 text-white text-[9px] px-2 py-0.5 rounded shadow flex items-center gap-1 opacity-60 hover:opacity-100 transition-opacity" title="Pegar imagen">üìã PEGAR IA</button>
                </div>
            );

            return (
                <div className="flex h-screen" onPaste={handleGlobalPaste}>
                    {/* MEN√ö CONTEXTUAL */}
                    {contextMenu && (
                        <div className="context-menu" style={{ top: contextMenu.y, left: contextMenu.x }}>
                            <div className="context-menu-item" onClick={() => pasteFromClipboard(contextMenu.zone)}><span>üìã</span> Pegar imagen en {contextMenu.zone.toUpperCase()}</div>
                        </div>
                    )}

                    {/* SIDEBAR */}
                    <div className="w-64 bg-gray-900 text-white p-4 no-print flex flex-col gap-2 overflow-y-auto shrink-0 border-r border-gray-700">
                        <h2 className="text-lg font-bold text-blue-400">üìÇ Aduanas + IA</h2>
                        <button onClick={()=>{setFormData({});setTemplate(initialTemplate);setCheckState(0);autoFillData()}} className="bg-green-600 p-2 rounded text-xs font-bold hover:bg-green-700 w-full mb-4">NUEVA ACTA</button>
                        
                        <div className="mt-2 border-t border-gray-700 pt-4">
                            <button onClick={()=>setShowKeyInput(!showKeyInput)} className="text-xs text-yellow-400 hover:text-yellow-300 font-bold w-full text-left flex justify-between">
                                ‚öôÔ∏è CONFIGURAR IA <span>{showKeyInput ? '‚ñº' : '‚ñ∂'}</span>
                            </button>
                            {showKeyInput && (
                                <div className="mt-2 bg-gray-800 p-2 rounded border border-gray-600 space-y-2">
                                    <div className="text-xs text-gray-400">Proveedor: Google Gemini</div> 
                                    <input type="password" value={apiKey} onChange={(e)=>saveSettings(e.target.value, geminiModelName)} className="w-full bg-gray-900 text-white text-xs p-1 rounded border border-gray-700" placeholder="Pegar API Key aqu√≠..." />
                                    <input type="text" value={geminiModelName} onChange={(e)=>saveSettings(apiKey, e.target.value)} className="w-full bg-gray-900 text-white text-xs p-1 rounded border border-gray-700" placeholder="gemini-1.5-pro" />
                                </div>
                            )}
                        </div>

                        <div className="flex-1 space-y-1 overflow-y-auto mt-4">
                            {Object.values(actas).map(a=>(
                                <div key={a.id} onClick={()=>loadActa(a.id)} className="p-2 bg-gray-800 hover:bg-gray-700 rounded flex justify-between cursor-pointer text-xs border border-gray-700 items-center">
                                    <span className="truncate flex-1">{a.nombre}</span>
                                    <span onClick={(e)=>deleteActa(e,a.id)} className="text-red-400 font-bold px-2 hover:bg-red-900/50 rounded ml-2">x</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-1 bg-gray-200 flex flex-col overflow-hidden">
                        <div className="bg-white p-2 shadow flex justify-between items-center no-print z-50 shrink-0 h-14">
                            <div className="font-bold text-gray-700 text-sm flex items-center gap-2">
                                <span>ACTA ADUANAS - RELLENABLE POR ZONAS CON INTELIGENCIA ARTIFICIAL (Arrastra o pega datos a las areas "CONDUCTOR" o "VEH√çCULO"</span>
                                <span className={`text-[9px] px-1.5 py-0.5 rounded border ${apiKey ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'}`}>
                                    {geminiModelName.toUpperCase()}
                                </span>
                            </div>
                            <div className="flex gap-2 items-center">
                                <button onClick={()=>setIsEditMode(!isEditMode)} className={`px-3 py-1.5 rounded text-sm font-medium transition-colors ${isEditMode ? 'bg-yellow-500 text-black shadow-inner' : 'bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-300'}`}>
                                    {isEditMode ? 'üîí Terminar' : 'üõ†Ô∏è Editar'}
                                </button>
                                <div className="w-px h-6 bg-gray-300 mx-1"></div>
                                <button onClick={saveActa} className="bg-blue-600 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-700 shadow-sm font-medium">Guardar</button>
                                <button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-1.5 rounded text-sm hover:bg-gray-900 shadow-sm font-medium">üñ®Ô∏è Imprimir</button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto p-8 flex justify-center bg-gray-500">
                            <div className={`page-a4 ${isEditMode?'editing':''}`} tabIndex="0">
                                
                                {processing.active && (<div className="loading-overlay"><div className="spinner"></div><h3 className="text-green-600 font-bold text-lg animate-pulse">{processing.msg}</h3></div>)}

                                {/* CABECERA */}
                                <div className="flex justify-between items-center mb-1 h-20 shrink-0 select-none">
                                    <div className="w-24 h-24 flex items-center justify-center relative cursor-pointer hover:bg-gray-50 transition-colors group">
                                        {!logos.left ? <span className="text-[9px] text-gray-400">AYTO</span> : <img src={logos.left} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=(ev)=>{setLogos(p=>({...p,left:ev.target.result}));localStorage.setItem('mis_logos_aduanas_v2',JSON.stringify({...logos,left:ev.target.result}));};r.readAsDataURL(f)}}}/>
                                    </div>
                                    <div className="text-center font-bold text-sm flex-1 mx-4 leading-tight" contentEditable={isEditMode} suppressContentEditableWarning>
                                        EXCMO. AYUNTAMIENTO DE ALICANTE<br/>POLIC√çA LOCAL
                                    </div>
                                    <div className="w-24 h-24 flex items-center justify-center relative cursor-pointer hover:bg-gray-50 transition-colors group">
                                        {!logos.right ? <span className="text-[9px] text-gray-400">POLIC√çA</span> : <img src={logos.right} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=(ev)=>{setLogos(p=>({...p,right:ev.target.result}));localStorage.setItem('mis_logos_aduanas_v2',JSON.stringify({...logos,right:ev.target.result}));};r.readAsDataURL(f)}}}/>
                                    </div>
                                </div>

                                <div className="text-center font-bold underline mb-3 text-sm uppercase" contentEditable={isEditMode} suppressContentEditableWarning>
                                    ACTA DE INFRACCI√ìN ADUANERA EN MATERIA DE TR√ÅFICO
                                </div>

                                <div className="mb-2 text-justify text-[10px]" contentEditable={isEditMode} suppressContentEditableWarning>
                                    Se procede por parte de los agentes de esta polic√≠a con n√∫mero de identificaci√≥n profesional indicados a la pr√°ctica de la presente acta de infracci√≥n, haciendo constar lo siguiente:
                                </div>

                                <div className="form-container">
                                    {/* FILAS GENERALES (NO IA) */}
                                    {renderRow(template[0], 0)}
                                    {renderRow(template[1], 1)}

                                    {/* ZONA 1: CONDUCTOR (IA) */}
                                    <div 
                                        className={`drop-zone-conductor ${dragTarget === 'conductor' ? 'drag-active' : ''}`}
                                        onDragOver={(e) => handleDragOver(e, 'conductor')}
                                        onDrop={(e) => handleDrop(e, 'conductor')}
                                        onContextMenu={(e) => handleContextMenu(e, 'conductor')}
                                    >
                                        <SectionHeaderWithPaste title="IDENTIFICACI√ìN DEL CONDUCTOR" zone="conductor" />
                                        {renderRow(template[3], 3)}
                                        {renderRow(template[4], 4)}
                                        {renderRow(template[5], 5)}
                                    </div>

                                    {/* ZONA 2: VEH√çCULO (IA) */}
                                    <div 
                                        className={`drop-zone-vehicle ${dragTarget === 'vehicle' ? 'drag-active' : ''}`}
                                        onDragOver={(e) => handleDragOver(e, 'vehicle')}
                                        onDrop={(e) => handleDrop(e, 'vehicle')}
                                        onContextMenu={(e) => handleContextMenu(e, 'vehicle')}
                                    >
                                        <SectionHeaderWithPaste title="DATOS DEL VEH√çCULO" zone="vehicle" />
                                        {renderRow(template[7], 7)}
                                        {renderRow(template[8], 8)}
                                        {renderRow(template[9], 9)}
                                    </div>

                                    {/* OBSERVACIONES */}
                                    {template.map((item, i) => {
                                        if (i > 9 && item.type === 'section') return <div key={i} className="section-bar" contentEditable={isEditMode} suppressContentEditableWarning>{item.title}</div>;
                                        if (i > 9 && item.type === 'row') return renderRow(item, i);
                                        return null;
                                    })}
                                </div>

                                <div className="mt-4 mb-2 font-bold text-[10px] uppercase">
                                    Que la infracci√≥n presuntamente cometida resulta ser:
                                </div>

                                {/* SECCI√ìN DE CHECKS DE INFRACCI√ìN (Del archivo 2) */}
                                <div className="legal-block">
                                    <div className="checkbox-row" onClick={()=>!isEditMode && setCheckState(1)}>
                                        <div className="checkbox-box">{checkState===1 ? 'X' : ''}</div>
                                        <div className="checkbox-text" contentEditable={isEditMode} suppressContentEditableWarning>
                                            Conductor/a NO propietario/a del veh√≠culo, utilizando en el Territorio Aduanero Comunitario un veh√≠culo matriculado fuera de dicho territorio, no realizando un uso a t√≠tulo ocasional, encontr√°ndose el/la titular del veh√≠culo fuera del Territorio Aduanero Comunitario. (Art. 215 del Reglamento Delegado (UE) 2015/2446).
                                        </div>
                                    </div>
                                    <div className="checkbox-row" onClick={()=>!isEditMode && setCheckState(2)}>
                                        <div className="checkbox-box">{checkState===2 ? 'X' : ''}</div>
                                        <div className="checkbox-text" contentEditable={isEditMode} suppressContentEditableWarning>
                                            Conductor/a propietario/a del veh√≠culo matriculado en un pa√≠s fuera del Territorio Aduanero Comunitario, siendo residente en Territorio Comunitario Aduanero, sin haber satisfecho los derechos aduaneros de importaci√≥n del medio de transporte. (Art. 212 del Reglamento Delegado (UE) 2015/2446).
                                        </div>
                                    </div>
                                    <div className="checkbox-row" onClick={()=>!isEditMode && setCheckState(3)}>
                                        <div className="checkbox-box">{checkState===3 ? 'X' : ''}</div>
                                        <div className="checkbox-text" contentEditable={isEditMode} suppressContentEditableWarning>
                                            Conductor/a propietario/a del veh√≠culo matriculado en un pa√≠s fuera del Territorio Aduanero Comunitario, siendo residente en Territorio Comunitario Aduanero, habiendo transcurrido los plazos establecidos para regularizar el medio de transporte. (Art. 217 del Reglamento Delegado (UE) 2015/2446).
                                        </div>
                                    </div>
                                </div>

                                {/* CITACI√ìN (Del archivo 2) */}
                                <div className="summons-text" contentEditable={isEditMode} suppressContentEditableWarning>
                                    S√≠rvase la presente para comparecer, a efectos de practicar las diligencias oportunas, en la Dependencia de Aduanas e Impuestos Especiales de Alicante, sita en Plaza Puerta del Mar s/n, tel√©fono de contacto 965146295/fax 965210066.
                                </div>
                                <div className="docs-text" contentEditable={isEditMode} suppressContentEditableWarning>
                                    Deber√° acudir provisto de toda su documentaci√≥n tanto personal como del veh√≠culo (pasaporte, carta de identidad, permiso de residencia, baja consular, permiso de circulaci√≥n, tarjeta de inspecci√≥n t√©cnica y aquellos otros documentos o medios que estime oportunos).
                                </div>

                                <div className="mt-auto pt-6 flex justify-between text-xs font-bold select-none" style={{ paddingBottom: '2.5cm' }}>
                                    <div className="w-1/3 text-center flex flex-col items-center">
                                        <div className="mb-2 w-full" contentEditable={isEditMode} suppressContentEditableWarning>Fdo.- El conductor</div>
                                    </div>
                                    <div className="w-1/3 text-center flex flex-col items-center">
                                        <div className="mb-2 w-full">Fdo. El Agente {formData.agente1}</div>
                                    </div>
                                    <div className="w-1/3 text-center flex flex-col items-center">
                                        <div className="mb-2 w-full">Fdo. El Agente {formData.agente2}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador GAD - Versi√≥n Definitiva</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .infraction-item { transition: all 0.3s ease; }
    .infraction-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .highlight { background-color: #bbf7d0; padding: 0 2px; border-radius: 2px; }
    .regulation-code { font-weight: bold; color: #1e40af; font-size: 1rem; }
    .article-info { font-weight: bold; font-size: 0.95rem; margin-top: 0.25rem; }
    .article-part { color: #dc2626; font-weight: 800; }
    .section-part { color: #059669; font-weight: 800; }
    .option-part { color: #7c3aed; font-weight: 800; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar-container { width: 100%; background-color: #1f2937; border-radius: 9999px; height: 16px; margin-top: 10px; overflow: hidden; border: 1px solid #4b5563; position: relative; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); width: 0%; transition: width 0.3s ease; }
    .progress-text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; text-shadow: 0 1px 2px black; }
    .drag-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; transform: scale(1.02); }
    #dropZone { transition: all 0.2s ease-in-out; }
    #aiTextInput { resize: vertical; min-height: 80px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col pb-16">

  <header class="bg-blue-600 w-full flex justify-center items-center py-2">
    <div class="w-40 h-40 rounded-full overflow-hidden shadow-lg bg-white">
      <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-cover block" onerror="this.src='https://via.placeholder.com/150?text=GAD'">
    </div>
  </header>
  <h1 class="text-black text-center mt-6 text-xl font-bold px-4">
    CODIFICADO INFRACCIONES (Entrada Universal)
  </h1>
  <hr class="w-11/12 max-w-md mx-auto my-4 border-t border-gray-300">

  <div id="mainContent" class="w-11/12 max-w-md mx-auto mt-4 bg-white p-4 rounded-lg shadow-md relative">
    </div>

  <div id="searchResults" class="w-11/12 max-w-md mx-auto mt-4 bg-white p-4 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">Listado</h2>
        <div class="flex items-center gap-2">
            <span id="countDisplay" class="text-xs text-gray-500 font-bold"></span>
            <button id="deleteAllBtn" class="bg-red-100 hover:bg-red-200 text-red-700 text-xs font-bold px-2 py-1 rounded border border-red-300 transition">
                <i class="fas fa-trash-alt mr-1"></i> BORRAR TODO
            </button>
        </div>
    </div>
    <div id="deleteProgressArea" class="hidden mb-2">
        <p class="text-xs text-red-600 font-bold text-center animate-pulse">Eliminando...</p>
        <div class="progress-bar-container h-2 mt-1 bg-red-100 border-red-200">
            <div id="deleteProgressBar" class="h-full bg-red-600 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>
    
    <div id="resultsContainer" class="space-y-3 max-h-96 overflow-y-auto min-h-[100px]">
      <div class="loading-spinner"></div>
      <p class="text-center text-gray-500 py-4">Cargando base de datos...</p>
    </div>
    <div id="statusMessage" class="hidden text-center py-2 font-bold text-sm bg-red-100 text-red-700 rounded p-2 mb-2"></div>
    <p id="noResults" class="hidden text-center text-gray-500 py-4">Sin resultados.</p>
  </div>

  <div class="mt-4 flex flex-col items-center space-y-4 mb-8">
    <div class="w-11/12 max-w-md flex gap-2">
         <button id="aiImportBtn" class="flex-1 p-4 bg-indigo-600 text-white font-bold rounded-lg shadow-md transition hover:bg-indigo-500 flex justify-center items-center">
            <i class="fas fa-robot mr-2"></i> IMPORTAR CON IA (Universal)
        </button>
        <button id="addInfractionBtn" class="flex-1 p-4 bg-green-600 text-white font-bold rounded-lg shadow-md transition hover:bg-green-500 flex justify-center items-center">
            <i class="fas fa-pen mr-2"></i> MANUAL / EDITAR
        </button>
    </div>
  </div>

  <div id="aiModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex justify-center items-center p-4 hidden z-50 transition-opacity duration-300">
    <div class="bg-gray-800 w-full max-w-lg p-6 rounded-xl shadow-2xl border border-gray-700 text-white max-h-screen overflow-y-auto relative">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-xl font-bold text-indigo-400"><i class="fas fa-brain mr-2"></i>Importador Universal</h2>
            <button id="stopProcessBtn" class="hidden bg-red-600 hover:bg-red-700 text-white text-xs font-bold px-3 py-1 rounded shadow-lg animate-pulse">DETENER</button>
        </div>
        
        <div class="bg-indigo-900 bg-opacity-30 p-3 rounded-lg border border-indigo-700 mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">üí° Datos de Entrada (Texto, URL, HTML, CSV)</label>
            <textarea id="aiTextInput" placeholder="Pega aqu√≠ el texto desordenado, JSON, CSV o una URL con datos..." 
                   class="w-full h-24 bg-gray-900 border border-indigo-500 rounded px-3 py-2 text-sm text-white focus:ring-1 focus:ring-indigo-400 leading-relaxed"></textarea>
        </div>

        <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center transition-colors bg-gray-700 relative group cursor-pointer hover:border-indigo-500">
            <input type="file" id="aiFileInput" accept="image/*,application/pdf, .xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
            <div id="dropZoneContent" class="pointer-events-none">
                <i class="fas fa-file-upload text-4xl text-gray-400 mb-2 group-hover:text-indigo-400 transition-colors"></i>
                <p class="text-sm text-gray-300 font-bold">O Arrastra PDF / Imagen / Excel (.xlsx, .csv)</p>
                <p class="text-xs text-gray-400 mt-1">(La IA determinar√° el tipo de archivo)</p>
            </div>
            <div id="filePreviewArea" class="hidden mt-2 pointer-events-none flex flex-col items-center">
                 <i id="fileIcon" class="fas fa-file-pdf text-red-500 text-4xl hidden mb-2"></i>
                 <img id="imagePreview" src="" class="hidden w-full max-h-32 object-contain rounded border border-gray-600 mx-auto" />
                 <p id="fileNameDisplay" class="text-sm text-white mt-2 font-bold truncate max-w-full"></p>
                 <p id="pageCountDisplay" class="text-xs text-green-400 mt-1 font-bold"></p>
            </div>
        </div>


        <div id="aiProgressArea" class="hidden mt-4 bg-gray-900 p-3 rounded border border-gray-700">
            <div class="flex justify-between text-xs text-gray-300 mb-1">
                <span id="progressText">Iniciando...</span>
                <span id="recordsCount" class="text-green-400 font-bold">0 Regs</span>
            </div>
            <div class="progress-bar-container">
                <div id="progressBarFill" class="progress-bar-fill"></div>
                <div id="progressPercent" class="progress-text-overlay">0%</div>
            </div>
            <p id="batchStatus" class="text-center text-xs text-yellow-400 mt-2 font-mono truncate">Esperando...</p>
        </div>

        <div id="aiLogArea" class="text-xs text-gray-400 mt-2 max-h-48 overflow-y-auto font-mono bg-black p-2 rounded hidden border border-gray-700"></div>

        <div class="flex justify-end gap-3 mt-4 border-t border-gray-700 pt-3">
            <button type="button" id="closeAiModalBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white text-sm font-bold">Cerrar</button>
            <button type="button" id="aiSubmitBtn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white font-bold shadow-lg text-sm">Analizar y Guardar</button>
        </div>
    </div>
  </div>

  <div id="addInfractionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md max-h-screen overflow-y-auto">
      <div class="p-4 border-b">
        <h2 class="text-xl font-bold text-blue-800" id="modalTitleManual">Gesti√≥n de Infracci√≥n</h2>
      </div>
      <form id="infractionForm" class="p-4 space-y-4">
        <input type="hidden" id="editKey">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Normativa</label>
          <input list="regulationsList" id="formRegulation" class="w-full p-2 border border-gray-300 rounded-lg">
          <datalist id="regulationsList">
              <option value="Ley de Seguridad Vial">
              <option value="Reglamento General de Circulaci√≥n">
              <option value="Reglamento General de Conductores">
              <option value="Reglamento General de Veh√≠culos">
              <option value="Real Decreto 8/2004 del SOA">
              <option value="Escuelas Particulares de Conductores">
              <option value="Centro de Reconocimiento de Conductores">
          </datalist>
        </div>

        <div class="flex gap-2">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Art.</label><input type="text" id="formArticle" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="w-1/4"><label class="block text-sm font-medium text-gray-700 mb-1">Apt.</label><input type="text" id="formSection" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="w-1/4"><label class="block text-sm font-medium text-gray-700 mb-1">Opc.</label><input type="text" id="formOption" class="w-full p-2 border border-gray-300 rounded-lg"></div>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Hecho Infringido</label><textarea id="formDescription" required rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea></div>
        
        <div class="flex gap-2">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Total (‚Ç¨)</label><input type="number" id="formTotalAmount" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Reducido (‚Ç¨)</label><input type="number" id="formReducedAmount" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg"></div>
        </div>
        
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Responsable</label><input type="text" id="formResponsable" class="w-full p-2 border border-gray-300 rounded-lg"></div>

        <div class="flex gap-2">
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Puntos</label><input type="number" id="formPuntos" class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Calif.</label><select id="formType" class="w-full p-2 border border-gray-300 rounded-lg"><option value="leve">Leve</option><option value="grave">Grave</option><option value="muy grave">Muy grave</option></select></div>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Keywords</label><input type="text" id="formKeywords" class="w-full p-2 border border-gray-300 rounded-lg"></div>
      </form>
      <div class="p-4 border-t flex justify-end space-x-2">
        <button id="cancelManualBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">Cancelar</button>
        <button id="saveManualBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
      </div>
    </div>
  </div>

  <footer class="mt-auto text-center py-6 bg-gray-200">
    <p class="font-bold">GRUPO DE AN√ÅLISIS DOCUMENTAL</p>
    <p>&copy; GAD - Todos los derechos reservados</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
apiKey: "AIzaSyCY8V_P7m8lZUvGbMVlGaa-GVhbmyikmag",
  authDomain: "gad-alicante-v4.firebaseapp.com",
  databaseURL: "https://gad-alicante-v4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gad-alicante-v4",
  storageBucket: "gad-alicante-v4.firebasestorage.app",
  messagingSenderId: "119727545224",
  appId: "1:119727545224:web:36880c50d196c456cdb83d"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const INFRACTIONS_COLLECTION = collection(db, 'infracciones_gad_v3'); 

    let allInfractions = [];
    let isImporting = false;

    // üîë TU CLAVE INSERTADA PERMANENTEMENTE
    const GEMINI_API_KEY = "AIzaSyDFx0wBf0MC7dreCopgHckrp0-Dk1ZiGhc"; 

    onAuthStateChanged(auth, (user) => {
        if (user) { loadInfractions(); } 
        else { signInAnonymously(auth).catch(err => showError(`Error Auth: ${err.message}`)); }
    });

    const statusMessage = document.getElementById('statusMessage');
    const resultsContainer = document.getElementById('resultsContainer');

    function showError(msg) {
        statusMessage.textContent = msg;
        statusMessage.classList.remove('hidden');
    }

    function loadInfractions() {
        onSnapshot(query(INFRACTIONS_COLLECTION), (snapshot) => {
            statusMessage.classList.add('hidden');
            allInfractions = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const item = {
                    key: docSnap.id,
                    regulation: normalizeSavedRegulation(data.norma),
                    article: String(data.articulo || '').trim(),
                    section: String(data.apartado || '').trim(),
                    option: String(data.opcion || '').trim(),
                    description: data.descripcion || '',
                    totalAmount: parseFloat(data.importe) || 0,
                    reducedAmount: parseFloat(data.importeReducido) || 0,
                    type: (data.tipo || 'leve').toLowerCase(),
                    keywords: data.keywords || '',
                    puntos: parseInt(data.puntos) || 0,
                    responsable: data.responsable || 'No especificado'
                };
                allInfractions.push(item);
            });
            allInfractions.sort((a, b) => (parseInt((a.article || "0").match(/\d+/)) || 0) - (parseInt((b.article || "0").match(/\d+/)) || 0));
            document.getElementById('countDisplay').textContent = `${allInfractions.length} regs`;
            searchInfractions(); 
        }, (error) => {
            console.error(error);
            showError("Error conectando a Firebase: " + error.message);
            resultsContainer.innerHTML = '';
        });
    }

    function searchInfractions() {
        const term = normalizeText(document.getElementById('searchInput').value.toLowerCase().trim());
        const filter = document.getElementById('regulationFilter').value;
        const filtered = allInfractions.filter(i => {
            const regNorm = i.regulation; 
            if(filter !== 'todas' && regNorm !== filter) return false;
            if(!term) return true;
            const content = normalizeText(`${i.description} ${i.article} ${i.keywords} ${i.regulation} ${i.responsable}`).toLowerCase(); 
            return content.includes(term);
        });
        renderResults(filtered);
    }

    function renderResults(items) {
        resultsContainer.innerHTML = '';
        if(items.length === 0) {
            document.getElementById('noResults').classList.remove('hidden');
            return;
        }
        document.getElementById('noResults').classList.add('hidden');
        const term = document.getElementById('searchInput').value.trim();
        items.forEach(i => {
            const div = document.createElement('div');
            div.className = 'infraction-item bg-blue-50 p-3 rounded-lg border border-blue-100';
            const aptHtml = i.section ? `, <span class="section-part">Apt. ${highlight(i.section, term)}</span>` : '';
            const opcHtml = i.option ? `, <span class="option-part">Op. ${highlight(i.option, term)}</span>` : '';
            const ptosHtml = i.puntos > 0 ? `<span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full font-bold border border-red-200">-${i.puntos} PTOS</span>` : '';
            const redHtml = i.reducedAmount ? `<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full font-bold border border-yellow-200">Red: ${i.reducedAmount}‚Ç¨</span>` : '';
            const respHtml = i.responsable && i.responsable !== 'No especificado' ? `<span class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-full font-bold"><i class="fas fa-user-tag"></i> ${highlight(i.responsable, term)}</span>` : '';

            div.innerHTML = `
                <div class="w-full">
                    <div class="regulation-code text-sm text-indigo-800 uppercase">${highlight(i.regulation, term)}</div>
                    <div class="article-info">
                        <span class="article-part">Art. ${highlight(i.article, term)}</span>
                        ${aptHtml}
                        ${opcHtml}
                    </div>
                    <p class="text-sm mt-2 text-gray-800">${highlight(i.description, term)}</p>
                    <div class="flex flex-wrap gap-2 mt-2 items-center">
                        <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded uppercase font-bold">${i.type}</span>
                        <span class="text-sm font-bold text-green-700">${i.totalAmount}‚Ç¨</span>
                        ${redHtml}
                        ${ptosHtml}
                        ${respHtml}
                    </div>
                    <div class="flex gap-2 mt-3 pt-2 border-t border-blue-200">
                        <button class="text-blue-600 hover:text-blue-800 text-xs font-bold btn-edit" data-key="${i.key}"><i class="fas fa-edit"></i> EDITAR</button>
                        <button class="text-red-500 hover:text-red-700 text-xs font-bold btn-del" data-key="${i.key}"><i class="fas fa-trash"></i> BORRAR</button>
                    </div>
                </div>`;
            resultsContainer.appendChild(div);
        });
        document.querySelectorAll('.btn-edit').forEach(b => b.onclick = (e) => openModal(e.target.closest('button').dataset.key));
        document.querySelectorAll('.btn-del').forEach(b => b.onclick = (e) => deleteItem(e.target.closest('button').dataset.key));
    }

    function normalizeText(t) { return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""; }
    function highlight(text, term) {
        if(!term || !text) return text;
        const cleanTerm = normalizeText(term).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const pattern = cleanTerm.split('').map(c => "aeiou".includes(c) ? "[a√°√†√§√¢e√©√®√´√™i√≠√¨√Ø√Æo√≥√≤√∂√¥u√∫√π√º√ªn√±]" : c).join('');
        const regex = new RegExp(`(${pattern})`, 'gi');
        return String(text).replace(regex, `<span class="highlight">$1</span>`);
    }
    function normalizeSavedRegulation(norma) {
        if(!norma) return 'Desconocida';
        const n = normalizeText(norma).toUpperCase().trim();
        // Mantenemos la l√≥gica de normalizaci√≥n en el cliente
        if(n.includes('CONDUC') || n === 'CON' || n === 'RGC' || n.includes('CONDUCTORES')) return 'Reglamento General de Conductores';
        if(n.includes('SEGURIDAD VIAL') || n === 'LSV') return 'Ley de Seguridad Vial';
        if(n.includes('CIRCULAC') || n === 'CIR') return 'Reglamento General de Circulaci√≥n';
        if(n.includes('VEHICULOS') || n === 'VEH' || n.includes('RGV')) return 'Reglamento General de Veh√≠culos';
        if(n === 'SOA' || n.includes('SEGURO OBLIGATORIO')) return 'Real Decreto 8/2004 del SOA';
        if(n.includes('ESCUELA')) return 'Escuelas Particulares de Conductores';
        if(n.includes('RECONOCIMIENTO') || n === 'CRC') return 'Centro de Reconocimiento de Conductores';
        if(n.includes('ORDENANZA MUNICIPAL')) return 'Ordenanza Municipal';
        return norma; 
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        document.getElementById('clearButton').classList.toggle('hidden', !e.target.value);
        searchInfractions();
    });
    document.getElementById('clearButton').onclick = () => {
        document.getElementById('searchInput').value = '';
        searchInfractions();
        document.getElementById('clearButton').classList.add('hidden');
    };
    document.getElementById('regulationFilter').onchange = searchInfractions;

    const modal = document.getElementById('addInfractionModal');
    function openModal(key = null) {
        document.getElementById('infractionForm').reset();
        document.getElementById('editKey').value = '';
        document.getElementById('modalTitleManual').textContent = "Nueva Infracci√≥n";
        if(key) {
            const i = allInfractions.find(x => x.key === key);
            if(i) {
                document.getElementById('modalTitleManual').textContent = "Editar Infracci√≥n";
                document.getElementById('editKey').value = i.key;
                document.getElementById('formRegulation').value = i.regulation;
                document.getElementById('formArticle').value = i.article;
                document.getElementById('formSection').value = i.section;
                document.getElementById('formOption').value = i.option;
                document.getElementById('formDescription').value = i.description;
                document.getElementById('formTotalAmount').value = i.totalAmount;
                document.getElementById('formReducedAmount').value = i.reducedAmount;
                document.getElementById('formPuntos').value = i.puntos;
                document.getElementById('formType').value = i.type;
                document.getElementById('formKeywords').value = i.keywords;
                document.getElementById('formResponsable').value = i.responsable;
            }
        }
        modal.classList.remove('hidden');
    }
    document.getElementById('addInfractionBtn').onclick = () => openModal();
    document.getElementById('cancelManualBtn').onclick = () => modal.classList.add('hidden');
    document.getElementById('saveManualBtn').onclick = async (e) => {
        e.preventDefault();
        const key = document.getElementById('editKey').value;
        const regRaw = document.getElementById('formRegulation').value;
        const data = {
            norma: normalizeSavedRegulation(regRaw),
            articulo: document.getElementById('formArticle').value,
            apartado: document.getElementById('formSection').value,
            opcion: document.getElementById('formOption').value,
            descripcion: document.getElementById('formDescription').value,
            importe: parseFloat(document.getElementById('formTotalAmount').value) || 0,
            importeReducido: parseFloat(document.getElementById('formReducedAmount').value) || 0,
            puntos: parseInt(document.getElementById('formPuntos').value) || 0,
            tipo: document.getElementById('formType').value,
            keywords: document.getElementById('formKeywords').value,
            responsable: document.getElementById('formResponsable').value || 'No especificado'
        };
        try {
            if(key) await updateDoc(doc(INFRACTIONS_COLLECTION, key), data);
            else await addDoc(INFRACTIONS_COLLECTION, data);
            modal.classList.add('hidden');
        } catch(err) { alert("Error al guardar en Firebase: " + err.message); }
    };
    async function deleteItem(key) { if(confirm("¬øBorrar definitivamente?")) { await deleteDoc(doc(INFRACTIONS_COLLECTION, key)); }}

    document.getElementById('deleteAllBtn').onclick = async () => {
        if(!confirm("‚ö†Ô∏è ¬øELIMINAR TODA LA BASE DE DATOS?")) return;
        const deleteArea = document.getElementById('deleteProgressArea');
        const deleteBar = document.getElementById('deleteProgressBar');
        deleteArea.classList.remove('hidden');
        document.getElementById('deleteAllBtn').disabled = true;
        try { await deleteAllRecursive(deleteBar); alert("Base de datos limpia."); } 
        catch (error) { alert("Error: " + error.message); } 
        finally { deleteArea.classList.add('hidden'); document.getElementById('deleteAllBtn').disabled = false; }
    };
    async function deleteAllRecursive(progressBar) {
        const q = query(INFRACTIONS_COLLECTION, limit(400));
        const snapshot = await getDocs(q);
        if (snapshot.size === 0) { progressBar.style.width = "100%"; return; }
        const batch = writeBatch(db);
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        let currentW = parseFloat(progressBar.style.width) || 0;
        if(currentW < 90) progressBar.style.width = (currentW + 10) + "%";
        await deleteAllRecursive(progressBar);
    }

    // --- PARSERS DE ARCHIVOS ---
    async function parseExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                let resultText = "";
                workbook.SheetNames.forEach(sheetName => {
                    const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
                    resultText += `\n--- SHEET: ${sheetName} ---\n${csv}`;
                });
                resolve(resultText);
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }
    
    async function parsePDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(item => item.str).join(' '); 
        }
        return fullText;
    }


    // --- IA LOGIC ---
    const aiModal = document.getElementById('aiModal');
    const dropZone = document.getElementById('dropZone');
    const aiFileInput = document.getElementById('aiFileInput');
    const filePreviewArea = document.getElementById('filePreviewArea');
    const imagePreview = document.getElementById('imagePreview');
    const fileIcon = document.getElementById('fileIcon');
    const dropZoneContent = document.getElementById('dropZoneContent');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const pageCountDisplay = document.getElementById('pageCountDisplay');
    const aiProgressArea = document.getElementById('aiProgressArea');
    const progressBarFill = document.getElementById('progressBarFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressText = document.getElementById('progressText');
    const batchStatus = document.getElementById('batchStatus');
    const aiLogArea = document.getElementById('aiLogArea');
    const aiSubmitBtn = document.getElementById('aiSubmitBtn');
    const stopProcessBtn = document.getElementById('stopProcessBtn');
    const recordsCount = document.getElementById('recordsCount');

    document.getElementById('aiImportBtn').onclick = () => { aiModal.classList.remove('hidden'); resetAiModal(); };
    document.getElementById('closeAiModalBtn').onclick = () => { isImporting = false; aiModal.classList.add('hidden'); };
    stopProcessBtn.onclick = () => { isImporting = false; logToUi("üõë PROCESO DETENIDO.", true); stopProcessBtn.classList.add('hidden'); aiSubmitBtn.disabled = false; };
    
    function resetAiModal() {
        document.getElementById('aiTextInput').value = '';
        aiFileInput.value = '';
        filePreviewArea.classList.add('hidden');
        dropZoneContent.classList.remove('hidden');
        aiProgressArea.classList.add('hidden');
        aiLogArea.classList.add('hidden');
        aiLogArea.innerHTML = '';
        stopProcessBtn.classList.add('hidden');
        window.currentFile = null;
        window.pdfDoc = null;
        isImporting = false;
    }

    ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('drag-active'); }));
    ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.remove('drag-active'); }));
    dropZone.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files[0]));
    aiFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));

    async function handleFileSelect(file) {
        if(!file) return;
        window.currentFile = file;
        
        const fileName = file.name.toLowerCase();
        const isPdf = file.type === 'application/pdf' || fileName.endsWith('.pdf');
        const isImage = file.type.startsWith('image/');
        const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

        dropZoneContent.classList.add('hidden');
        filePreviewArea.classList.remove('hidden');
        fileNameDisplay.textContent = file.name;
        
        if (isPdf) {
            const arrayBuffer = await file.arrayBuffer();
            window.pdfDoc = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            pageCountDisplay.textContent = `${window.pdfDoc.numPages} p√°ginas (PDF)`;
        } else if (isImage) {
            window.pdfDoc = null; 
            pageCountDisplay.textContent = "Imagen cargada";
        } else if (isExcel) {
            window.pdfDoc = null; 
            pageCountDisplay.textContent = "Excel cargado";
        }
    }

    function logToUi(msg, isError = false) {
        aiLogArea.classList.remove('hidden');
        const p = document.createElement('div');
        p.textContent = `> ${msg}`;
        p.className = isError ? "text-red-400" : "text-green-400";
        aiLogArea.appendChild(p);
        aiLogArea.scrollTop = aiLogArea.scrollHeight;
    }

    aiSubmitBtn.onclick = async () => {
        let userKey = GEMINI_API_KEY.trim();
        if(userKey === "TU_CLAVE_AIZA_AQUI") {
            return alert("‚ö†Ô∏è La clave API no ha sido insertada. Por favor, edita la l√≠nea 326.");
        }

        const textInput = document.getElementById('aiTextInput').value.trim();
        const file = window.currentFile;

        if(!textInput && !file) return;
        
        aiSubmitBtn.disabled = true;
        stopProcessBtn.classList.remove('hidden');
        aiProgressArea.classList.remove('hidden');
        let totalRecords = 0;
        isImporting = true;
        
        try {
            let processedText = textInput;
            let base64Image = null;

            // 1. PROCESAMIENTO DE ENTRADA UNIVERSAL
            if (file && !textInput) { // Si hay archivo Y NO HAY texto pegado, procesar archivo
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
                    logToUi("Procesando Excel/CSV...");
                    processedText = await parseExcel(file);
                } else if (window.pdfDoc) {
                    // Procesar PDF, acumulando todo el texto en una sola string
                    const totalPages = window.pdfDoc.numPages;
                    logToUi(`Procesando PDF (${totalPages} p√°ginas)...`);
                    
                    let fullPdfText = "";
                    for (let i = 1; i <= totalPages; i++) {
                        const page = await window.pdfDoc.getPage(i);
                        const content = await page.getTextContent();
                        fullPdfText += content.items.map(item => item.str).join(' '); // Lectura Simple
                    }
                    processedText = fullPdfText; 

                } else if (file.type.startsWith('image/')) {
                    base64Image = await new Promise(r => {
                        const reader = new FileReader();
                        reader.onload = () => r(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                }
            } else if (textInput) {
                logToUi("Procesando texto pegado...");
                // Si el usuario pega texto, se asume que quiere procesar solo ese texto.
            }
            

            // 2. ENV√çO A GEMINI
            logToUi("Analizando datos con IA. Esto puede tardar...");
            
            const results = await callGeminiAPI(processedText, base64Image, file ? file.type : 'text/plain', userKey);
            
            const safeResults = Array.isArray(results) ? results : [];

            if (safeResults.length > 0) {
                const added = await saveToFirebaseWithDeduplication(safeResults);
                totalRecords += added;
                recordsCount.textContent = `${totalRecords} Registros`;
                logToUi(`‚úî FINALIZADO: Se a√±adieron +${added} registros nuevos.`);
            } else {
                logToUi(`‚ö† FINALIZADO: 0 registros nuevos. La IA no encontr√≥ un patr√≥n v√°lido en los datos de entrada.`);
            }
            
            updateProgress(100, `¬°Fin! Total: ${totalRecords} registros.`);

        } catch(err) {
            console.error(err);
            batchStatus.textContent = "Error: " + err.message;
            batchStatus.classList.add("text-red-500");
        } finally {
            aiSubmitBtn.disabled = false;
            stopProcessBtn.classList.add('hidden');
            isImporting = false;
        }
    };

    function updateProgress(percent, text) {
        progressBarFill.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressText.textContent = text;
    }

    async function fileToBase64(file) {
        return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = () => res(r.result.split(',')[1]);
            r.onerror = rej;
            r.readAsDataURL(file);
        });
    }

    // --- API GEMINI CON FALLBACK DE MODELOS Y PROMPT DE L√ìGICA PURA ---
    async function callGeminiAPI(text, base64ImageData, mimeType, key) {
        const models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'];
        
        // **SCHEMA FINAL CON COMENTARIO SEPARADO**
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "NORMA": { "type": "STRING", "description": "Abreviatura de la normativa (CIR, LSV, CON, VEH, CRC, etc.)." },
                    "ART": { "type": "STRING" },
                    "APT": { "type": "STRING" },
                    "OPC": { "type": "STRING" },
                    "PTOS": { "type": "NUMBER", "description": "Puntos que se restan (0 si no aplica)." },
                    "CALIF": { "type": "STRING", "description": "Calificaci√≥n (Leve, Grave o Muy Grave)." },
                    "TEXTO_HECHO_INFRINGIDO": { "type": "STRING", "description": "La descripci√≥n detallada del hecho que constituye la infracci√≥n." },
                    "MULTA_IMP_Total": { "type": "NUMBER", "description": "Importe total de la sanci√≥n." },
                    "MULTA_IMP_Reducido": { "type": "NUMBER", "description": "Importe reducido de la sanci√≥n (si aplica)." },
                    "RESPONS": { "type": "STRING", "description": "Qui√©n es el responsable (Conductor, Titular, Usuario)." },
                    "COMENTARIO": { "type": "STRING", "description": "La informaci√≥n adicional o notas que aparezcan en la columna de comentarios." }
                },
                required: ["NORMA", "ART", "TEXTO_HECHO_INFRINGIDO", "MULTA_IMP_Total"]
            }
        };

        const systemPrompt = `
        ERES UN ANALISTA DE DATOS. Tu objetivo es examinar el texto de entrada y extraer ABSOLUTAMENTE TODO EL CONTENIDO estructuralmente, siguiendo el ESQUEMA de salida.
        
        REGLAS DE EXTRACCI√ìN:
        1. Devuelve SOLO un array JSON v√°lido, usando el formato exacto de las claves del esquema.
        2. EXTRACCI√ìN TOTAL: Si ves m√∫ltiples c√≥digos de norma/art√≠culo asociados al mismo bloque descriptivo, GENERA DOS OBJETOS SEPARADOS.
        3. El texto de entrada est√° desordenado o es un CSV/Tabla. Localiza los patrones de columna.
        
        Texto de entrada (Data Source):\n${text}
        `;

        const userParts = [];
        if (text) userParts.push({ text: systemPrompt });
        if (base64ImageData) {
            userParts.push({ text: "Analiza esta tabla/texto de una imagen y extrae todos los campos." });
            userParts.push({ inlineData: { mimeType: mimeType, data: base64ImageData } });
        }

        const payload = {
            contents: [{ role: "user", parts: userParts }],
            generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema } 
        };
        
        for (const model of models) {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content) {
                        let rawText = result.candidates[0].content.parts[0].text;
                        rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                        try {
                            return JSON.parse(rawText);
                        } catch (e) {
                            console.error(`Error parseando JSON del modelo ${model}:`, e);
                            return [];
                        }
                    }
                    return []; 
                } 
             } catch (e) {
                 console.warn(`Fallo modelo ${model}`, e);
                 if(model === models[models.length-1]) return []; 
             }
        }
        return []; 
    }

    async function saveToFirebaseWithDeduplication(data) {
        if (!Array.isArray(data)) return 0;

        const batch = writeBatch(db);
        let count = 0;
        const existingSignatures = new Set(allInfractions.map(i => 
            `${i.regulation}|${i.article}|${i.section}|${i.option}`.toUpperCase().replace(/\s+/g, '')
        ));

        data.forEach(item => {
            // Mapping schema keys to internal database names (adjusting to original storage names)
            const normaRaw = item.NORMA || '';
            const art = String(item.ART || '').trim();
            const apt = String(item.APT || '').trim();
            const opc = String(item.OPC || '').trim();

            const normalizedNorma = normalizeSavedRegulation(normaRaw);
            const candidateSignature = `${normalizedNorma}|${art}|${apt}|${opc}`.toUpperCase().replace(/\s+/g, '');

            if (!existingSignatures.has(candidateSignature)) {
                const ref = doc(INFRACTIONS_COLLECTION);
                batch.set(ref, {
                    norma: normalizedNorma,
                    articulo: art,
                    apartado: apt,
                    opcion: opc,
                    // Combinamos descripci√≥n + comentario en el campo 'descripcion' del DB, y usamos 'keywords' para el comentario
                    descripcion: (item.TEXTO_HECHO_INFRINGIDO || '') + (item.COMENTARIO ? ' (NOTA: ' + item.COMENTARIO + ')' : ''),
                    importe: parseFloat(item.MULTA_IMP_Total) || 0,
                    importeReducido: parseFloat(item.MULTA_IMP_Reducido) || 0,
                    puntos: parseInt(item.PTOS) || 0,
                    tipo: (item.CALIF || 'leve').toLowerCase(),
                    keywords: item.COMENTARIO || '', // Usamos el comentario como keyword si existe
                    responsable: item.RESPONS || 'No especificado'
                });
                existingSignatures.add(candidateSignature);
                count++;
            }
        });

        if (count > 0) await batch.commit();
        return count;
    }
  </script>
</body>
</html>
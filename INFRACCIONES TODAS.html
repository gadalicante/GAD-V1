<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador GAD - Gesti√≥n Avanzada</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --primary-color: #1e40af;
        }

        body { background-color: var(--bg-color); font-family: 'Segoe UI', system-ui, sans-serif; }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 6px solid #ccc;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        /* Colores de borde seg√∫n gravedad */
        .card.muy-grave { border-left-color: var(--danger-color); }
        .card.grave { border-left-color: var(--warning-color); }
        .card.leve { border-left-color: var(--success-color); }

        .card-header {
            padding: 10px 15px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .article-tag { font-weight: 800; color: #1e40af; font-size: 0.95rem; }

        .card-actions { display: flex; gap: 10px; align-items: center; }
        .icon-btn { cursor: pointer; transition: transform 0.2s; font-size: 1.1rem; border: none; background: none; }
        .icon-btn:hover { transform: scale(1.1); }
        .wa-icon { color: #25D366; }
        .tg-icon { color: #0088cc; }
        .edit-icon { color: #4b5563; }

        .card-body { padding: 16px; flex-grow: 1; }
        .normativa-text { font-size: 0.75rem; text-transform: uppercase; color: #6b7280; margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px; }
        .description-text { font-size: 1rem; color: #1f2937; margin-bottom: 12px; line-height: 1.5; }

        /* Estilo para el resaltado de b√∫squeda */
        .highlight-match {
            background-color: #fef08a; /* Amarillo suave */
            color: #000;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .details-box {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.85rem;
        }
        
        .details-row-inline {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
        }

        .label-detail { color: #6b7280; font-weight: 600; }
        
        .money-total { color: #dc2626 !important; font-weight: 800 !important; } 
        .money-reduced { color: #059669 !important; font-weight: 800 !important; } 
        .money-sep { color: #9ca3af; margin: 0 2px; }
        .points-val { color: #dc2626; font-weight: 800; margin-left: 2px; }
        
        .resp-container {
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
            margin-top: 8px;
            white-space: normal;
            word-break: normal;
            line-height: 1.4;
        }
        .responsable-val { color: #1e40af; font-weight: 700; }

        #infractionCounter {
            background-color: var(--primary-color);
            color: white;
            padding: 6px 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            font-size: 0.9rem;
        }

        .drop-zone {
            border: 2px dashed #a78bfa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #7c3aed;
            background-color: #f5f3ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        .drop-zone.dragover { background-color: #ede9fe; border-color: #6d28d9; transform: scale(1.02); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-blue-600 w-full flex justify-center items-center py-4 shadow-md">
        <div class="w-32 h-32 rounded-full overflow-hidden shadow-lg bg-white">
            <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-cover block" onerror="this.src='https://via.placeholder.com/150/0000FF/FFFFFF?text=GAD'">
        </div>
    </header>

    <div class="container mx-auto px-4 flex-grow">
        <h1 class="text-center mt-6 text-2xl font-bold text-gray-800 uppercase tracking-wide">Codificado Infracciones GAD</h1>

        <div class="max-w-5xl mx-auto mt-6 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <div class="w-full md:w-1/3">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Filtrar Normativa</label>
                    <select id="normativaFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="todas">Todas las normativas</option>
                    </select>
                </div>
                <div class="w-full md:w-2/3">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buscador</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Ej: alcoholemia, velocidad, art 12..." class="w-full p-3 border border-gray-300 rounded-lg pl-10 focus:outline-none focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-4 border-t pt-4">
                <div id="infractionCounter">Cargando...</div>
                <div class="flex flex-wrap justify-center md:justify-end gap-2 w-full md:w-auto">
                    <button id="btnOpenImport" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold shadow transition text-sm">Importar</button>
                    <button id="btnUndo" onclick="undoLastImport()" class="hidden px-3 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 font-semibold shadow transition text-sm">Deshacer √öltima</button>
                    <button onclick="repairFirebaseClean()" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 font-semibold shadow transition text-sm">Reparar Firebase</button>
                    <button onclick="cleanDuplicates()" class="px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 font-semibold shadow transition text-sm">Limpiar Duplicados</button>
                    <button onclick="deleteAllInfracciones()" class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold shadow text-sm">Borrar Todo</button>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="results-grid max-w-7xl mx-auto">
            <div class="col-span-full text-center py-10">Conectando...</div>
        </div>
        <div id="noResults" class="hidden text-center py-10"><p class="text-gray-500 text-lg">No se encontraron resultados.</p></div>
    </div>

    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col">
            <div class="bg-purple-700 p-4 rounded-t-xl text-white font-bold flex justify-between shrink-0">
                <span>Importar JSON</span>
                <button id="btnCloseImport" class="hover:text-gray-200"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="dropZone" class="drop-zone"><i class="fas fa-cloud-upload-alt text-3xl mb-2"></i><br><span class="font-bold">Arrastra JSON aqu√≠</span><br><input type="file" id="fileInput" class="hidden" accept=".json"></div>
                <textarea id="jsonPasteArea" rows="8" class="w-full p-2 border mt-4 rounded text-sm font-mono" placeholder='Pega aqu√≠ tu c√≥digo JSON...'></textarea>
                <button id="btnConfirmImport" class="w-full py-3 bg-purple-600 text-white rounded font-bold mt-4 shadow-lg hover:bg-purple-700 transition-colors">Procesar Importaci√≥n</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-screen">
            <div class="bg-blue-600 p-4 rounded-t-xl flex justify-between items-center text-white">
                <h2 id="modalTitle" class="font-bold text-lg">Edici√≥n</h2>
                <button onclick="closeEditModal()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="editForm" class="p-6 space-y-3">
                <input type="hidden" id="editPath">
                
                <div>
                    <label class="block text-xs font-bold text-purple-600 uppercase">Palabra Clave (Buscador)</label>
                    <input type="text" id="editPalabraClave" class="w-full p-2 border-2 border-purple-100 rounded focus:border-purple-500 focus:outline-none" placeholder="Ej: grua, alcoholemia...">
                </div>

                <div><label class="block text-xs font-bold text-gray-600">Normativa</label><input type="text" id="editNormativa" class="w-full p-2 border rounded"></div>
                <div class="flex gap-2">
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Art.</label><input type="text" id="editArticulo" class="w-full p-2 border rounded"></div>
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Ap.</label><input type="text" id="editApartado" class="w-full p-2 border rounded"></div>
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Op.</label><input type="text" id="editOpcion" class="w-full p-2 border rounded"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-600">Hecho</label><textarea id="editDescripcion" rows="3" class="w-full p-2 border rounded"></textarea></div>
                <div class="flex gap-2">
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Total (‚Ç¨)</label><input type="number" id="editImporte" class="w-full p-2 border rounded"></div>
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Red. (‚Ç¨)</label><input type="number" id="editImporteReducido" class="w-full p-2 border rounded"></div>
                    <div class="w-1/3"><label class="block text-xs font-bold text-gray-600">Ptos</label><input type="number" id="editPuntos" class="w-full p-2 border rounded"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-600">Resp.</label><input type="text" id="editResponsable" class="w-full p-2 border rounded"></div>
            </form>
            <div class="p-4 border-t flex justify-between gap-3">
                <button id="btnDeleteSpecific" onclick="deleteInfractionFromEdit()" class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 font-bold transition">Eliminar</button>
                <div class="flex gap-2"><button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 rounded font-bold">Cerrar</button><button onclick="saveEdit()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Guardar</button></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBu5ALRVJ5aDzuU9YIAQD_9KMgR6ZwttpU", 
            authDomain: "gad-alicante-v1.firebaseapp.com",
            databaseURL: "https://gad-alicante-v1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v1",
            storageBucket: "gad-alicante-v1.appspot.com",
            messagingSenderId: "545835357966",
            appId: "1:545835357966:web:6351ec6c0d3c8e69eb695f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
    const db = firebase.database();
        const rootRef = db.ref('infracciones_todas');

        let allInfracciones = [];
        let lastBatchPaths = []; 

        function normalizeLawName(name) {
            if (!name) return "Varios";
            const n = name.replace(/_/g, ' ').toLowerCase().trim();
            if (n.includes("seguro") || n.includes("responsabilidad civil") || n === "soa") return "SOA";
            if (n.includes("trafico") || n.includes("tr√°fico") || n.includes("seguridad vial") || n.includes("lsv") || n.includes("circulacion")) {
                if (!n.includes("reglamento") && !n.includes("reglam.")) return "Ley de Seguridad Vial";
            }
            if (n === "cir" || (n.includes("reglamento") && n.includes("circulacion"))) return "Reglamento General de Circulaci√≥n";
            if (n.includes("reglamento") && n.includes("conductores")) return "Reglamento General de Conductores";
            if (n.includes("reglamento") && n.includes("vehiculos")) return "Reglamento General de Veh√≠culos";
            return name;
        }

        function areAlmostSame(text1, text2) {
            const clean = (s) => String(s || "").toLowerCase().replace(/[^a-z0-9]/g, '');
            const s1 = clean(text1); const s2 = clean(text2);
            if (s1 === s2) return true;
            if (Math.abs(s1.length - s2.length) > Math.max(s1.length, s2.length) * 0.02) return false;
            let matches = 0; const len = Math.min(s1.length, s2.length);
            for (let i = 0; i < len; i++) { if (s1[i] === s2[i]) matches++; }
            return (matches / Math.max(s1.length, s2.length)) >= 0.98;
        }

        function generateUniqueSignature(item) {
            const clean = (str) => String(str || "").toLowerCase().trim().replace(/[^a-z0-9]/g, '');
            const textHash = clean(item.descripcion).split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
            return `${clean(item.articulo)}_${clean(item.apartado)}_${clean(item.opcion)}_${Math.abs(textHash)}`;
        }

        function flattenData(node, parentPath = "infracciones_todas", list = []) {
            if (!node) return list;
            const isInfraction = node.articulo || node.normativa || node.texto_hecho_infringido || node.multa || node.importe_multa;
            if (isInfraction) {
                let item = normalizeInfraction(node);
                item.fullPath = parentPath;
                list.push(item);
            } else {
                Object.keys(node).forEach(key => { if (typeof node[key] === 'object') flattenData(node[key], `${parentPath}/${key}`, list); });
            }
            return list;
        }

        function normalizeInfraction(data) {
            let importe = parseFloat(data.multa_total || data.multa || data.importe_multa || data.importe_total || 0);
            let calif = data.calificacion || data.tipoFalta || "Leve";

            // L√≥gica autom√°tica de severidad seg√∫n precio
            if (importe === 200) {
                calif = "Grave";
            } else if (importe === 500) {
                calif = "Muy grave";
            } else {
                if (calif.toLowerCase().includes("muy grave")) calif = "Muy grave";
                else if (calif.toLowerCase().includes("grave")) calif = "Grave";
                else calif = "Leve";
            }

            return {
                normativa: normalizeLawName(data.normativa || data.norma || data.ley),
                articulo: (data.articulo || data.art || "").toString(),
                apartado: (data.apartado || data.ap || "").toString(),
                opcion: (data.opcion || data.op || "").toString(),
                descripcion: data.texto_hecho_infringido || data.textoInfraccion || data.hecho || data.descripcion || "",
                calificacion: calif,
                importe_total: importe,
                importe_reducido: parseFloat(data.importe_reducido || data.importeReducido || 0),
                puntos: parseInt(data.puntos || data.pto || 0),
                responsable: data.responsable || data.responsables || "Conductor",
                palabra_clave: data.palabra_clave || "" 
            };
        }

        rootRef.on('value', (snapshot) => {
            allInfracciones = flattenData(snapshot.val());
            populateFilter(allInfracciones); 
            filterData(); 
        });

        function highlightMatch(text, query) {
            if (!query || query.length < 2) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight-match">$1</span>');
        }

        // --- CONSTRUCTOR DEL TEXTO DE COMPARTIR CON UNICODE ---
        function buildShareText(item) {
            // Usamos \uXXXX para asegurar que los emojis se ven en cualquier codificaci√≥n
            const police = "\uD83D\uDC6E";      // üëÆ‚Äç‚ôÇÔ∏è
            const car = "\uD83D\uDE94";         // üöî
            const flagES = "\uD83C\uDDEA\uD83C\uDDF8"; // üá™üá∏
            const scroll = "\uD83D\uDCDC";      // üìú
            const bookmark = "\uD83D\uDD16";    // üîñ
            const memo = "\uD83D\uDCDD";        // üìù
            const money = "\uD83D\uDCB6";       // üí∂
            const card = "\uD83D\uDCB3";        // üí≥
            const person = "\uD83D\uDC64";      // üë§

            return `${police}${car} *GRUPO DE AN√ÅLISIS DOCUMENTAL* ${car}${police}\n` +
                   `${flagES} *GAD ALICANTE* ${flagES}\n` +
                   `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                   `${scroll} *NORMA:* ${item.normativa}\n` +
                   `${bookmark} *ART:* ${item.articulo}  *AP:* ${item.apartado}  *OP:* ${item.opcion}\n\n` +
                   `${memo} *HECHO DENUNCIADO:*\n` +
                   `${item.descripcion}\n\n` +
                   `${money} *MULTA:* ${item.importe_total}‚Ç¨  (Reducida: ${item.importe_reducido}‚Ç¨)\n` +
                   `${card} *PUNTOS:* ${item.puntos}\n` +
                   `${person} *RESPONSABLE:* ${item.responsable}\n` +
                   `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
        }

        function renderCards(data, total, query) {
            const container = document.getElementById('resultsContainer');
            const counter = document.getElementById('infractionCounter');
            container.innerHTML = '';
            counter.textContent = query ? `Mostrando: ${data.length} / Total: ${total}` : `Total: ${total} Infracciones`;
            
            data.forEach(item => {
                let severity = item.calificacion.toLowerCase().includes('muy grave') ? 'muy-grave' : (item.calificacion.toLowerCase().includes('grave') ? 'grave' : 'leve');
                
                const displayDesc = query ? highlightMatch(item.descripcion, query) : item.descripcion;
                const displayKeyword = (query && item.palabra_clave) ? highlightMatch(item.palabra_clave, query) : (item.palabra_clave || '');

                // Codificamos el objeto para pasarlo por onClick
                const itemStr = encodeURIComponent(JSON.stringify(item));

                const card = document.createElement('div');
                card.className = `card ${severity}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="article-tag">Art. ${item.articulo} ${item.apartado ? 'Ap. '+item.apartado : ''} | Op. ${item.opcion}</span>
                        <div class="card-actions">
                            <button onclick="handleWhatsappClick('${itemStr}')" class="icon-btn wa-icon" title="Enviar por WhatsApp"><i class="fab fa-whatsapp"></i></button>
                            <button onclick="handleTelegramClick('${itemStr}')" class="icon-btn tg-icon" title="Enviar por Telegram"><i class="fab fa-telegram-plane"></i></button>
                            <div class="w-px h-4 bg-gray-300 mx-1"></div>
                            <button onclick="openEditModal('${itemStr}')" class="icon-btn edit-icon" title="Editar"><i class="fas fa-edit"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <span class="normativa-text">${item.normativa}</span>
                        <div class="description-text">${displayDesc}</div>
                        
                        ${item.palabra_clave ? `<div class="text-xs text-purple-600 font-bold mb-2 uppercase"><i class="fas fa-tag mr-1"></i>${displayKeyword}</div>` : ''}

                        <div class="details-box">
                            <div class="details-row-inline"><span class="label-detail">Multa:</span><span class="money-total">${item.importe_total}‚Ç¨</span><span class="money-sep">/</span><span class="money-reduced">${item.importe_reducido}‚Ç¨</span><span class="label-detail ml-4">Ptos:</span><span class="points-val">${item.puntos}</span></div>
                            <div class="resp-container"><span class="label-detail">Resp:</span><span class="responsable-val">${item.responsable}</span></div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- MANEJADORES DE CLIC (SEGUROS) ---
        
        function handleWhatsappClick(itemStr) {
            const item = JSON.parse(decodeURIComponent(itemStr));
            const text = buildShareText(item);
            // Usamos api.whatsapp.com que es m√°s compatible
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
        }

        function handleTelegramClick(itemStr) {
            const item = JSON.parse(decodeURIComponent(itemStr));
            const text = buildShareText(item);
            navigator.clipboard.writeText(text).then(() => { 
                Toastify({ text: "Copiado. Abre Telegram.", duration: 2000, style: { background: "#0088cc" } }).showToast(); 
                window.open(`tg://msg?text=${encodeURIComponent(text)}`); 
            }); 
        }

        function openEditModal(itemStr = null) {
            document.getElementById('editModal').classList.remove('hidden'); document.getElementById('editModal').classList.add('flex');
            const del = document.getElementById('btnDeleteSpecific');
            if(itemStr) {
                const item = JSON.parse(decodeURIComponent(itemStr));
                document.getElementById('editPath').value = item.fullPath; 
                document.getElementById('editNormativa').value = item.normativa;
                document.getElementById('editArticulo').value = item.articulo; 
                document.getElementById('editApartado').value = item.apartado;
                document.getElementById('editOpcion').value = item.opcion; 
                document.getElementById('editDescripcion').value = item.descripcion;
                document.getElementById('editImporte').value = item.importe_total; 
                document.getElementById('editImporteReducido').value = item.importe_reducido;
                document.getElementById('editPuntos').value = item.puntos; 
                document.getElementById('editResponsable').value = item.responsable;
                document.getElementById('editPalabraClave').value = item.palabra_clave || ""; 
                del.classList.remove('hidden');
            } else { document.getElementById('editForm').reset(); del.classList.add('hidden'); }
        }

        // --- FUNCIONES DE GESTI√ìN DE DATOS ---

        function repairFirebaseClean() {
            if (!confirm("‚ö†Ô∏è REPARACI√ìN TOTAL\n\nEste proceso descargar√° todos tus datos, eliminar√° los nodos basura y guiones bajos, y unificar√° las infracciones duplicadas al 98%.\n\n¬øDeseas continuar?")) return;

            rootRef.once('value').then(snapshot => {
                const raw = snapshot.val();
                if (!raw) return alert("Base de datos vac√≠a.");
                const cleanObject = {}; 
                const flatList = flattenData(raw);
                let processed = 0;
                flatList.forEach(item => {
                    const norm = item.normativa; 
                    const art = `Art_${item.articulo}`;
                    const sig = `Fact_${generateUniqueSignature(item)}`;
                    if (!cleanObject[norm]) cleanObject[norm] = {};
                    if (!cleanObject[norm][art]) cleanObject[norm][art] = {};
                    const isDup = Object.values(cleanObject[norm][art]).some(existing => areAlmostSame(existing.descripcion, item.descripcion));
                    if (!isDup) { cleanObject[norm][art][sig] = item; processed++; }
                });
                return rootRef.set(cleanObject).then(() => processed);
            }).then((count) => {
                alert(`‚úÖ REPARACI√ìN EXITOSA\nSe han unificado y limpiado ${count} registros.`);
                window.location.reload();
            }).catch(err => alert("Error: " + err.message));
        }

        function processDataBatch(inputData) {
            let arrayData = Array.isArray(inputData) ? inputData : flattenData(inputData, "import");
            const updates = {}; const initialCount = allInfracciones.length;
            let added = 0; let skipped = 0; const currentBatchPaths = [];
            arrayData.forEach(raw => {
                const item = normalizeInfraction(raw);
                const isDuplicate = allInfracciones.some(existing => existing.articulo === item.articulo && areAlmostSame(existing.descripcion, item.descripcion));
                if (isDuplicate) { skipped++; } 
                else {
                    const sig = generateUniqueSignature(item);
                    const path = `${item.normativa}/Art_${item.articulo}/Fact_${sig}`;
                    updates[path] = item; currentBatchPaths.push(path); added++;
                }
            });
            if (added > 0) {
                rootRef.update(updates).then(() => {
                    lastBatchPaths = currentBatchPaths; document.getElementById('btnUndo').classList.remove('hidden');
                    alert(`‚úÖ IMPORTACI√ìN COMPLETADA\nNuevas: ${added} | Omitidas: ${skipped}\nTotal Global: ${initialCount + added}`);
                    document.getElementById('importModal').classList.add('hidden');
                });
            } else alert(`NADA QUE A√ëADIR\nLas infracciones ya existen (>98%).`);
        }

        function undoLastImport() {
            if (confirm(`¬øBorrar los √∫ltimos ${lastBatchPaths.length} registros?`)) {
                const undo = {}; lastBatchPaths.forEach(p => undo[p] = null);
                rootRef.update(undo).then(() => { alert("Deshecho."); lastBatchPaths = []; document.getElementById('btnUndo').classList.add('hidden'); });
            }
        }

        function cleanDuplicates() {
            if(!confirm("¬øLimpiar duplicados del 98%?")) return;
            const updates = {}; const seen = [];
            allInfracciones.forEach(item => {
                const dup = seen.find(s => s.articulo === item.articulo && areAlmostSame(s.descripcion, item.descripcion));
                if (dup) updates[item.fullPath.replace('infracciones_todas/','')] = null;
                else seen.push(item);
            });
            rootRef.update(updates).then(() => alert("Limpieza lista."));
        }

        function deleteAllInfracciones() { if(confirm("‚ö†Ô∏è ¬øBORRAR TODO?") && prompt("Escribe BORRAR:") === "BORRAR") rootRef.remove(); }
        
        function deleteInfractionFromEdit() { if(confirm("‚ö†Ô∏è ¬øEliminar?")) db.ref(document.getElementById('editPath').value).remove().then(closeEditModal); }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex'); }

        function saveEdit() {
            const importe = parseFloat(document.getElementById('editImporte').value);
            let califAuto = "Leve";
            if (importe === 200) califAuto = "Grave";
            else if (importe === 500) califAuto = "Muy grave";

            const data = normalizeInfraction({
                normativa: document.getElementById('editNormativa').value, 
                articulo: document.getElementById('editArticulo').value, 
                apartado: document.getElementById('editApartado').value, 
                opcion: document.getElementById('editOpcion').value,
                hecho: document.getElementById('editDescripcion').value, 
                multa: importe,
                importe_reducido: parseFloat(document.getElementById('editImporteReducido').value), 
                puntos: parseInt(document.getElementById('editPuntos').value),
                responsable: document.getElementById('editResponsable').value, 
                calificacion: califAuto, 
                palabra_clave: document.getElementById('editPalabraClave').value 
            });
            const path = document.getElementById('editPath').value;
            if (path === "" || !path.includes('/')) {
                const sig = generateUniqueSignature(data);
                rootRef.child(`${data.normativa}/Art_${data.articulo}/Fact_${sig}`).set(data).then(closeEditModal);
            } else db.ref(path).update(data).then(closeEditModal);
        }

        function filterData() {
            const text = document.getElementById('searchInput').value.toLowerCase();
            const selNorm = document.getElementById('normativaFilter').value;
            const filtered = allInfracciones.filter(i => (selNorm === 'todas' || i.normativa === selNorm) && 
                `${i.descripcion} ${i.articulo} ${i.responsable} ${i.palabra_clave || ''}`.toLowerCase().includes(text));
            renderCards(filtered, allInfracciones.filter(i => selNorm === 'todas' || i.normativa === selNorm).length, text);
        }

        function populateFilter(data) {
            const sel = document.getElementById('normativaFilter'); const current = sel.value;
            const normas = [...new Set(data.map(i => i.normativa))].sort();
            sel.innerHTML = '<option value="todas">Todas las normativas</option>';
            normas.forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`); sel.value = current;
        }

        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('normativaFilter').addEventListener('change', filterData);
        document.getElementById('btnOpenImport').onclick = () => { document.getElementById('jsonPasteArea').value = ''; importModal.classList.remove('hidden'); importModal.classList.add('flex'); };
        document.getElementById('btnCloseImport').onclick = () => { importModal.classList.add('hidden'); importModal.classList.remove('flex'); };
        document.getElementById('btnConfirmImport').onclick = () => { try { processDataBatch(JSON.parse(document.getElementById('jsonPasteArea').value)); } catch(e) { alert("Error JSON."); } };
    </script>
</body>
</html>
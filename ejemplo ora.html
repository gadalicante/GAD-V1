<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAD | Gesti√≥n Avanzada de Denuncias ORA</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --bg: #f4f6f8;
            --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--bg); color: #333;
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }

        /* CABECERA */
        .title-panel-blue {
            background-color: #3b82f6;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            padding: 15px 30px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .title-panel-blue h1 {
            color: white; margin: 0; font-size: 1.5em; flex-grow: 1; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .header-logo-container { width: 60px; height: 60px; flex-shrink: 0; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; }
        .header-logo-container img { width: 100%; height: 100%; object-fit: contain; }

        /* LAYOUT */
        main { flex: 1; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; }
        .dashboard-grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; align-items: start; }

        /* PANELES */
        .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eaecf0; }
        .panel h3 { margin-top: 0; font-size: 0.9rem; color: #888; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }

        /* CONTROLES */
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.85em; font-weight: 600; color: #666; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; }
        
        .filter-buttons-container { display: flex; flex-direction: column; gap: 10px; }

        #drop-zone {
            border: 2px dashed #cbd5e0; border-radius: 8px; padding: 25px 20px; text-align: center;
            background: #f8fafc; cursor: pointer; transition: all 0.2s;
        }
        #drop-zone.dragover { border-color: var(--accent); background: #ebf8ff; transform: scale(1.02); }

        /* BOTONES GLOBALES */
        .btn {
            border: none; padding: 12px 15px; border-radius: 6px; font-weight: 700; cursor: pointer;
            font-size: 0.85em; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-transform: uppercase; letter-spacing: 0.5px; margin: 0;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:active { transform: translateY(1px); }
        
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #333; }
        .btn-dark { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; }
        .btn-eurocop { background: linear-gradient(135deg, #fbc531, #e1b12c); color: #333; }

        /* --- ESTILOS TARJETA --- */
        .vehicle-list { display: flex; flex-direction: column; gap: 10px; }
        
        .vehicle-card {
            background: white; border: 1px solid #e1e4e8; border-radius: 8px; overflow: hidden;
            transition: all 0.2s;
        }
        .vehicle-card:hover { border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .card-header {
            padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; background: #fff;
        }
        
        /* GRID DE LA CABECERA */
        .left-col {
            display: grid; 
            /* Bot√≥nCopiar(40px) | Matr√≠cula(240px) | Contador(100px) | Fecha(Resto) */
            grid-template-columns: 40px 240px 100px 1fr; 
            gap: 10px; align-items: center;
        }

        /* Botones Mini */
        .btn-copy-mini {
            background: #e8f5e9; color: #2ecc71; border: 1px solid #2ecc71;
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-copy-mini:hover { background: #2ecc71; color: white; }

        .btn-trash-mini {
            background: transparent; color: #e74c3c; border: none;
            width: 30px; height: 30px; cursor: pointer; font-size: 1.1em;
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px; opacity: 0.6;
        }
        .btn-trash-mini:hover { opacity: 1; transform: scale(1.1); }

        .plate-number {
            font-family: 'Roboto', monospace; font-size: 1.3em; font-weight: 900; color: #2d3436;
            background: #f1f2f6; padding: 5px 0; border-radius: 6px; border: 1px solid #ced6e0;
            text-align: center; width: 100%; display: block; letter-spacing: 1px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        
        .count-badge {
            background: #dfe6e9; color: #636e72; font-size: 0.8em; font-weight: 700;
            padding: 6px 0; border-radius: 20px; text-align: center; width: 100%; display: block;
        }
        .count-badge.reincident { background: #e74c3c; color: white; box-shadow: 0 2px 5px rgba(231, 76, 60, 0.4); }

        .last-date-info {
            font-size: 0.85em; color: #7f8c8d; font-weight: 600; text-align: left;
            display: flex; align-items: center; gap: 5px;
        }

        /* CHIPS */
        .status-actions { display: flex; align-items: center; gap: 8px; }
        .status-chip {
            padding: 6px 15px; border-radius: 20px; font-size: 0.75em; font-weight: 700; text-transform: uppercase;
            border: 2px solid transparent; cursor: pointer; opacity: 0.4; filter: grayscale(100%); transition: all 0.2s;
            background: #eee; color: #555;
        }
        .status-chip:hover { opacity: 0.7; filter: grayscale(0%); transform: scale(1.05); }
        .status-chip.active { opacity: 1; filter: grayscale(0%); box-shadow: 0 2px 8px rgba(0,0,0,0.15); transform: scale(1.05); }
        .chip-eurocop.active { background: #ffeb3b; color: #000; border-color: #fbc531; }
        .chip-alert.active { background: #ff5252; color: white; border-color: #d32f2f; }
        .chip-notified.active { background: #4CAF50; color: white; border-color: #2e7d32; }

        /* DETALLES */
        .card-details { background: #f8fafc; border-top: 1px solid #eee; padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .card-details.open { max-height: 600px; overflow-y: auto; padding: 15px; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }

        /* MODALES */
        #legend-panel {
            position: fixed; top: 0; left: 0; width: 100%; max-height: 80vh; background: rgba(255,255,255,0.99);
            border-bottom: 5px solid #8e44ad; z-index: 3000; display: none; overflow-y: auto; box-shadow: 0 10px 100px rgba(0,0,0,0.5);
        }
        #legend-panel.visible { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* ESTILOS DEL MODAL DE NOTIFICACI√ìN */
        #modal-overlay-bg {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000;
        }
        #notification-modal {
            display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
            z-index: 2001; width: 90%; max-width: 450px;
        }
        
        /* Estilos Ayuda */
        .help-step { margin-bottom: 20px; border-left: 4px solid #ddd; padding-left: 15px; }
        .help-step h4 { margin: 0 0 5px 0; color: #2c3e50; }
        .help-step p { margin: 0; color: #666; font-size: 0.95em; }
        .tag-help { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        @media (max-width: 1100px) { 
            .dashboard-grid { grid-template-columns: 1fr; } 
            .left-col { grid-template-columns: 40px 1fr 100px 1fr; } 
        }
    </style>
</head>
<body>

    <div class="title-panel-blue">
        <div class="header-logo-container"><img src="logoora.png" onerror="this.style.display='none'"></div>
        <h1><i class="fas fa-file-invoice-dollar"></i> Listado de denuncias ORA</h1>
        <div class="header-logo-container"><img src="logogad.png" onerror="this.style.display='none'"></div>
    </div>

    <main>
        <div class="dashboard-grid">
            <aside class="panel">
                <h3><i class="fas fa-sliders-h"></i> Panel de Control</h3>
                
                <div class="control-group">
                    <label>Buscador R√°pido</label>
                    <input type="text" id="search-input" placeholder="Escribe matr√≠cula...">
                </div>

                <div class="control-group filter-buttons-container">
                    <button id="undo-btn" class="btn btn-dark"><i class="fas fa-undo"></i> Deshacer √öltima Subida</button>
                    <button id="toggle-help-btn" class="btn btn-purple"><i class="fas fa-book"></i> Ver Manual de Ayuda</button>
                </div>

                <div class="control-group" style="border-top: 1px solid #eee; padding-top: 15px;">
                    <label>Filtros de Estado</label>
                    <div class="filter-buttons-container">
                        <button id="filter-all-btn" class="btn btn-primary" style="opacity:0.9"><i class="fas fa-list"></i> Ver Todos</button>
                        <button id="filter-pending-btn" class="btn btn-warning"><i class="fas fa-hourglass-half"></i> Pendientes</button>
                        <button id="filter-reincident-btn" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Reincidentes</button>
                        <button id="filter-eurocop-btn" class="btn btn-eurocop"><i class="fas fa-check"></i> Sin Datos Eurocop</button>
                        <button id="filter-notified-btn" class="btn btn-success"><i class="fas fa-paper-plane"></i> Notificados</button>

                        <div style="font-size:0.8em; color:#999; margin:15px 0 5px 0; border-top:1px solid #eee; padding-top:10px;">ORDENAR VISTA ACTUAL POR:</div>
                        <button id="sort-date-btn" class="btn btn-dark"><i class="fas fa-clock"></i> Fecha (M√°s reciente)</button>
                        <button id="sort-plate-btn" class="btn btn-dark"><i class="fas fa-sort-alpha-down"></i> Matr√≠cula (A-Z)</button>
                    </div>
                </div>

                <div class="control-group" style="margin-top: 20px;">
                    <div id="drop-zone">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #a0aec0;"></i>
                        <p style="margin:5px 0; font-weight:bold; color:#555;">IMPORTAR EXCEL</p>
                        <p style="margin:0; font-size:0.8em; color:#999;">Arrastra archivo o haz clic</p>
                    </div>
                    <input type="file" id="file-input" accept=".xls, .xlsx" style="display: none;">
                </div>
                
                <div style="margin-top: 20px;">
                    <button id="delete-all-btn" class="btn btn-danger" style="opacity: 0.6; font-size: 0.75em;">üóëÔ∏è Borrar Base de Datos</button>
                </div>
            </aside>

            <section class="panel" style="background: transparent; border: none; box-shadow: none; padding: 0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span id="record-count" style="font-weight:bold; color:#666;">Cargando sistema...</span>
                    <span id="current-filter-label" style="font-size:0.85em; background:#eee; padding:2px 8px; border-radius:4px;">Vista: Todos</span>
                </div>
                <div id="vehicle-list" class="vehicle-list"></div>
            </section>
        </div>
    </main>

    <div id="modal-overlay-bg"></div>
    <div id="notification-modal">
        <div class="modal-header" style="background: #f1f1f1; padding: 10px; margin: -20px -20px 15px -20px; border-bottom: 1px solid #e0e0e0;">
            <h2 style="margin:0;"><i class="fas fa-paper-plane"></i> Notificar Datos Eurocop</h2>
        </div>
        
        <div class="modal-content" style="display: grid; gap: 10px;">
            <label>Nombre:</label> <input type="text" id="modal-nombre" placeholder="Nombre completo...">
            <label>DOI:</label> <input type="text" id="modal-doi" placeholder="N¬∫ de identificaci√≥n NIE, DNI, otros">
            <label>Direcci√≥n:</label> <input type="text" id="modal-direccion" placeholder="Direcci√≥n...">
            <label>Localidad:</label> <input type="text" id="modal-localidad" placeholder="Localidad...">
            <label>Fecha de Nacimiento:</label> <input type="date" id="modal-fecha-nacimiento">
            <label>Tel√©fono:</label> <input type="text" id="modal-telefono" placeholder="Tel√©fono...">
        </div>

        <div class="modal-buttons" style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
            <button id="modal-cancel-btn" style="padding:10px; cursor:pointer;">Cancelar</button>
            <button id="modal-accept-btn" style="background: #2ecc71; color: white; border: none; padding: 10px; border-radius: 5px; cursor:pointer;">Aceptar y Enviar</button>
        </div>
    </div>

    <div id="legend-panel">
        <div style="padding: 15px 30px; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; position:sticky; top:0; z-index:10;">
            <h4 style="margin:0; color:#8E24AA; font-size: 1.2em;"><i class="fas fa-book-open"></i> Manual de Procedimiento ORA</h4>
            <div style="display:flex; gap:10px;">
                <button id="edit-help-btn" class="btn btn-warning" style="width:auto; padding: 5px 15px; margin:0;">Editar Texto</button>
                <button id="save-help-btn" class="btn btn-success" style="width:auto; padding: 5px 15px; margin:0; display:none;">Guardar Cambios</button>
                <button id="close-help-btn" class="btn btn-danger" style="width:auto; padding: 5px 15px; margin:0;">Cerrar</button>
            </div>
        </div>
        <div id="legend-content-area" style="padding: 30px; line-height: 1.6; font-size: 1.0em; color: #444;"></div>
    </div>

    <script>
        // CONFIGURACI√ìN DE CORREO DE DESTINO
        const CORREO_SANCIONES = "unidad.sanciones@alicante.es";

        const firebaseConfig = {
            apiKey: "AIzaSyBu5ALRVJ5aDzuU9YIAQD_9KMgR6ZwttpU", 
            authDomain: "gad-alicante-v1.firebaseapp.com",
            databaseURL: "https://gad-alicante-v1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gad-alicante-v1",
            storageBucket: "gad-alicante-v1.appspot.com",
            messagingSenderId: "545835357966",
            appId: "1:545835357966:web:6351ec6c0d3c8e69eb695f"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const DB_REF = 'denuncias_ORA';

        let allDenuncias = [];
        let historyStack = [];
        let currentFilter = 'all'; 
        let currentSort = 'date'; 

        // ------------------------------------
        // FUNCI√ìN COPY (OBLIGATORIA)
        // ------------------------------------
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                let textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) resolve();
                        else reject(new Error("Fallback copy failed"));
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }

        // ------------------------------------
        // AYUDA DEFAULT
        // ------------------------------------
        const DEFAULT_HELP_HTML = `
            <h2 style="color:#2980b9; border-bottom:2px solid #eee; padding-bottom:10px;">üìñ Gu√≠a de Uso Paso a Paso</h2>
            
            <div class="help-step" style="border-left-color: #3498db;">
                <h4>1. Importar Datos (Excel)</h4>
                <p>Arrastra tu archivo Excel al recuadro <strong>"IMPORTAR EXCEL"</strong>. El sistema:</p>
                <ul>
                    <li>A√±ade los nuevos registros.</li>
                    <li>Elimina autom√°ticamente matr√≠culas espa√±olas.</li>
                    <li>Detecta duplicados para no repetir la misma multa.</li>
                </ul>
            </div>

            <div class="help-step" style="border-left-color: #f1c40f;">
                <h4>2. Revisi√≥n de Pendientes</h4>
                <p>Pulsa el bot√≥n amarillo <strong><i class="fas fa-hourglass-half"></i> Pendientes</strong>. Ver√°s solo los veh√≠culos nuevos que no has revisado.</p>
                <p>Haz clic en la <strong>tarjeta del veh√≠culo</strong> para ver los detalles (fecha, hora, calle, marca...).</p>
            </div>

            <div class="help-step" style="border-left-color: #2c3e50;">
                <h4>3. Gestionar Estados (Botones de la Tarjeta)</h4>
                <p>Cada veh√≠culo tiene 3 botones de acci√≥n a la derecha:</p>
                <ul style="list-style:none; padding:0;">
                    <li style="margin-bottom:8px;">
                        <span class="tag-help" style="background:#ffeb3b; color:#000;">SIN DATOS</span> 
                        Si has buscado en Eurocop y no hay datos, pulsa este bot√≥n. Desaparecer√° de pendientes.
                    </li>
                    <li style="margin-bottom:8px;">
                        <span class="tag-help" style="background:#ff5252; color:white;">ALERTA</span> 
                        √ösalo para veh√≠culos de inter√©s. Copia el texto oficial de inmovilizaci√≥n autom√°ticamente.
                    </li>
                    <li>
                        <span class="tag-help" style="background:#4CAF50; color:white;">NOTIFICADO</span> 
                        Abre el formulario para rellenar Nombre, DNI, etc. <strong>Guarda los datos en la nube</strong> y abre Outlook autom√°ticamente para enviar el correo a Sanciones.
                    </li>
                </ul>
            </div>

            <div class="help-step" style="border-left-color: #e74c3c;">
                <h4>4. Reincidentes</h4>
                <p>Pulsa el bot√≥n rojo <strong>Reincidentes</strong>. Muestra veh√≠culos con m√°s de 1 denuncia, ordenados del que m√°s tiene al que menos.</p>
            </div>
        `;

        // --- FUNCIONES FECHA CONSISTENTE ---
        function formatJustDate(dateObj) {
            if (!dateObj || isNaN(dateObj)) return 'Sin fecha';
            // FUERZA FORMATO DD/MM/AAAA SIEMPRE
            return dateObj.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDate(isoStr) {
            if(!isoStr) return '-';
            const d = new Date(isoStr);
            if(isNaN(d)) return isoStr;
            // FUERZA FORMATO EN DETALLES
            return formatJustDate(d) + ' ' + d.toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
        }

        // --- EXTRACCI√ìN Y LIMPIEZA ---
        function sanitizeKey(key) {
            if (!key) return '';
            return key.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.$#\[\]\/]/g, '_').replace(/\s/g, '_');
        }

        function getCanonicalKey(sanitizedKey) {
            if (sanitizedKey === 'matricula') return 'matricula';
            if (sanitizedKey.includes('fecha')) return 'fecha';
            if (sanitizedKey === 'marca') return 'marca';
            if (sanitizedKey === 'modelo') return 'modelo';
            if (sanitizedKey === 'calle' || sanitizedKey === 'lugar' || sanitizedKey === 'ubicacion') return 'lugar';
            if (sanitizedKey === 'revisado') return 'revisado';
            if (sanitizedKey === 'eurocop') return 'eurocop';
            if (sanitizedKey === 'notificado') return 'notificado';
            if (sanitizedKey === 'alerta') return 'alerta';
            if (sanitizedKey === 'datos_notificacion') return 'datos_notificacion'; 
            return null; 
        }

        function extraerDatosExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                        const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        if (jsonData.length === 0) { reject("Excel vac√≠o."); return; }

                        const sanitized = jsonData.map(row => {
                            const newRow = {};
                            Object.keys(row).forEach(k => {
                                const ck = getCanonicalKey(sanitizeKey(k));
                                if (ck) {
                                    let v = row[k];
                                    if (ck === 'fecha' || ck === 'revisado') {
                                        if (v instanceof Date) newRow[ck] = v.toISOString();
                                        else if (typeof v === 'number') newRow[ck] = new Date(Math.round((v - 25569) * 86400 * 1000)).toISOString();
                                        else newRow[ck] = v;
                                    } else {
                                        newRow[ck] = v;
                                    }
                                }
                            });
                            return newRow;
                        });

                        const final = sanitized.filter(row => {
                            if (!row.matricula) return false;
                            const p = String(row.matricula).trim().replace(/\s/g, '');
                            return !/^\d{4}[A-Z]{3}$/i.test(p) && !/^[A-Z]{1,2}\d{4}[A-Z]{1,2}$/i.test(p);
                        });
                        resolve(final);
                    } catch (err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- GESTI√ìN INTERFAZ ---
        function pushHistory() {
            if(allDenuncias.length > 0) {
                historyStack.push(JSON.parse(JSON.stringify(allDenuncias)));
                if(historyStack.length > 20) historyStack.shift();
            }
        }
        function undoAction() {
            if(historyStack.length === 0) return alert("Nada que deshacer.");
            if(confirm("¬øRestaurar estado anterior?")) {
                allDenuncias = historyStack.pop();
                database.ref(DB_REF).set(allDenuncias);
            }
        }

        function loadData() {
            database.ref(DB_REF).once('value', snap => {
                const val = snap.val();
                let rawData = val ? (Array.isArray(val) ? val : Object.values(val)) : [];
                allDenuncias = rawData.map(d => {
                    d.alerta = !!d.alerta; d.notificado = !!d.notificado; d.eurocop = !!d.eurocop;
                    if(!d.fecha && d.fecha_de_creacion) d.fecha = d.fecha_de_creacion;
                    if(!d.datos_notificacion) d.datos_notificacion = {};
                    return d;
                });
                renderList();
            });
        }

        function buscarPorMatricula(todosLosDatos, textoInput) {
            const query = String(textoInput || '').trim().toUpperCase();
            if (!query) return null; 
            
            const groups = {};
            todosLosDatos.forEach(d => {
                const mat = String(d.matricula).toUpperCase();
                if(mat.includes(query)) {
                    if(!groups[d.matricula]) groups[d.matricula] = { matricula: d.matricula, items: [], alerta: false, notificado: false, eurocop: false };
                    groups[d.matricula].items.push(d);
                }
            });
            return Object.values(groups);
        }

        function renderList() {
            const listContainer = document.getElementById('vehicle-list');
            listContainer.innerHTML = '';
            
            const groups = {};
            allDenuncias.forEach(d => {
                if(!d.matricula) return;
                const mat = d.matricula;
                if(!groups[mat]) groups[mat] = { matricula: mat, items: [], alerta: false, notificado: false, eurocop: false };
                groups[mat].items.push(d);
            });

            Object.values(groups).forEach(g => {
                g.eurocop = g.items.every(i => i.eurocop);
                g.alerta = g.items.some(i => i.alerta);
                g.notificado = g.items.some(i => i.notificado);
                const dates = g.items.map(i => new Date(i.fecha || 0));
                g.maxDate = new Date(Math.max(...dates));
            });

            const totalVehiculos = Object.keys(groups).length;
            const totalInfracciones = allDenuncias.length;
            document.getElementById('record-count').innerText = 
                `Total Veh√≠culos √önicos: ${totalVehiculos} | Total Infracciones: ${totalInfracciones}`;

            let result = Object.values(groups);
            const term = document.getElementById('search-input').value;
            const searchResults = buscarPorMatricula(allDenuncias, term);
            
            if(searchResults !== null) {
                result = searchResults;
                result.forEach(g => {
                   g.eurocop = g.items.every(i => i.eurocop);
                   g.alerta = g.items.some(i => i.alerta);
                   g.notificado = g.items.some(i => i.notificado);
                   const dates = g.items.map(i => new Date(i.fecha || 0));
                   g.maxDate = new Date(Math.max(...dates));
                });
                document.getElementById('current-filter-label').innerText = "B√∫squeda: " + term;
            } else {
                let labelText = "Todos";
                if(currentFilter === 'pending') {
                    result = result.filter(g => !g.eurocop && !g.alerta && !g.notificado);
                    labelText = "Pendientes";
                }
                if(currentFilter === 'reincident') {
                    result = result.filter(g => g.items.length > 1);
                    labelText = "Reincidentes";
                    const numPlates = result.length;
                    const numRecords = result.reduce((acc, g) => acc + g.items.length, 0);
                    document.getElementById('record-count').innerText = 
                        `Se encontraron ${numRecords} registros de ${numPlates} matr√≠culas reincidentes.`;
                }
                if(currentFilter === 'eurocop') {
                    result = result.filter(g => g.eurocop && !g.alerta && !g.notificado);
                    labelText = "Sin Datos";
                }
                if(currentFilter === 'notified') {
                    result = result.filter(g => g.notificado);
                    labelText = "Notificados";
                }
                document.getElementById('current-filter-label').innerText = "Vista: " + labelText;
            }

            if(currentSort === 'plate') {
                result.sort((a,b) => String(a.matricula || '').localeCompare(String(b.matricula || '')));
            } else if (currentSort === 'count') {
                result.sort((a,b) => b.items.length - a.items.length);
            } else {
                result.sort((a,b) => b.maxDate - a.maxDate);
            }

            if(result.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:50px; color:#aaa;">No hay resultados con el filtro actual.</div>';
                return;
            }

            result.forEach(g => {
                const card = document.createElement('div');
                card.className = 'vehicle-card';
                // USO DE LA NUEVA FUNCI√ìN DE FORMATO
                const dateStr = g.maxDate.getTime() > 0 ? formatJustDate(g.maxDate) : 'Sin fecha';
                
                card.innerHTML = `
                    <div class="card-header" onclick="this.nextElementSibling.classList.toggle('open')">
                        <div class="left-col">
                            <button class="btn-copy-mini" onclick="event.stopPropagation(); copyMat('${g.matricula}')" title="Copiar Matr√≠cula">
                                <i class="fas fa-copy"></i>
                            </button>
                            <div class="plate-number" title="${g.matricula}">${g.matricula}</div>
                            <div class="count-badge ${g.items.length > 1 ? 'reincident' : ''}">
                                ${g.items.length} Exp.
                            </div>
                            <div class="last-date-info"><i class="far fa-clock"></i> ${dateStr}</div>
                        </div>

                        <div class="status-actions" onclick="event.stopPropagation()">
                            <button class="status-chip chip-eurocop ${g.eurocop ? 'active' : ''}" 
                                onclick="toggleState('${g.matricula}', 'eurocop')">Sin Datos</button>
                            
                            <button class="status-chip chip-alert ${g.alerta ? 'active' : ''}" 
                                onclick="toggleState('${g.matricula}', 'alerta')">ALERTA</button>
                            
                            <button class="status-chip chip-notified ${g.notificado ? 'active' : ''}" 
                                onclick="openNotifModal('${g.matricula}')">Notificado</button>
                            
                            <button class="btn-trash-mini" onclick="deleteVehicle('${g.matricula}')" title="Borrar veh√≠culo">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-details">
                        ${g.items.map(i => `
                            <div class="detail-row">
                                <span>
                                    <i class="far fa-calendar"></i> ${formatDate(i.fecha)}
                                    <span style="font-size:0.9em; color:#666; margin-left:10px;">
                                        <i class="fas fa-map-marker-alt"></i> ${i.lugar || 'Ubicaci√≥n desc.'}
                                    </span>
                                </span>
                                <span style="font-weight:bold; color:#555;">${i.marca || ''} ${i.modelo || ''}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }

        window.copyMat = (mat) => {
            copyToClipboard(mat).then(() => {});
        };

        window.deleteVehicle = (mat) => {
            event.stopPropagation();
            if(confirm(`¬øSeguro que quieres borrar TODOS los registros de la matr√≠cula ${mat}?`)) {
                pushHistory();
                allDenuncias = allDenuncias.filter(d => d.matricula !== mat);
                database.ref(DB_REF).set(allDenuncias);
                renderList();
            }
        };

        window.toggleState = (matricula, type) => {
            pushHistory();
            const targets = allDenuncias.filter(d => d.matricula === matricula);
            if(targets.length === 0) return;

            if(type === 'eurocop') {
                const currentVal = targets.every(t => t.eurocop);
                const newVal = !currentVal;
                targets.forEach(d => { 
                    d.eurocop = newVal; 
                    if(newVal) { d.alerta = false; d.notificado = false; }
                });
            } else {
                const anyActive = targets.some(d => d[type]);
                const newVal = !anyActive;
                targets.forEach(d => {
                    d[type] = newVal;
                    if(newVal) d.eurocop = false;
                });
                if(type === 'alerta' && newVal) {
                    const alertText = 'INMOVILIZAR A DISPOSICI√ìN DEL GAD POR REINCIDENCIA EN INFRACCIONES Art 87.5 LSV (CAUCI√ìN).  Este veh√≠culo es de inter√©s para el negociado de sanciones del Ayuntamiento de Alicante. Se trata de un veh√≠culo reincidente en infracciones de estacionamiento ORA. Realizar incidencia en Eurocop con seguimiento al GAD para su tramitaci√≥n.';
                    copyToClipboard(alertText).then(() => alert("üö® ALERTA ACTIVA. Texto copiado."));
                }
            }
            database.ref(DB_REF).set(allDenuncias);
            renderList();
        };

        function handleFile(file) {
            pushHistory(); 

            extraerDatosExcel(file).then(newRows => {
                let addedCount = 0;
                let duplicateCount = 0;

                newRows.forEach(n => {
                    const isExactDuplicate = allDenuncias.some(old => 
                        old.matricula === n.matricula && 
                        old.fecha === n.fecha && 
                        (old.lugar || '') === (n.lugar || '')
                    );

                    if (isExactDuplicate) {
                        duplicateCount++;
                    } else {
                        const existingPlate = allDenuncias.find(old => old.matricula === n.matricula);
                        if(existingPlate) { 
                            n.eurocop = existingPlate.eurocop; 
                            n.alerta = existingPlate.alerta; 
                            n.notificado = existingPlate.notificado; 
                            if(existingPlate.datos_notificacion) n.datos_notificacion = existingPlate.datos_notificacion;
                        } else {
                            n.eurocop = false; n.alerta = false; n.notificado = false;
                            n.datos_notificacion = {};
                        }
                        allDenuncias.push(n);
                        addedCount++;
                    }
                });

                if(addedCount > 0) database.ref(DB_REF).set(allDenuncias);
                
                let msg = `‚úÖ IMPORTACI√ìN COMPLETADA\n\n- Registros NUEVOS: ${addedCount}`;
                if(duplicateCount > 0) msg += `\n‚ö†Ô∏è Registros DUPLICADOS (Ignorados): ${duplicateCount}`;
                alert(msg);
                
                renderList();
            }).catch(err => {
                historyStack.pop(); 
                alert("‚ùå ERROR: " + err);
            });
        }

        const dz = document.getElementById('drop-zone');
        const fi = document.getElementById('file-input');
        dz.onclick = () => fi.click();
        fi.onchange = (e) => { if(e.target.files[0]) handleFile(e.target.files[0]); };
        dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
        dz.ondragleave = () => dz.classList.remove('dragover');
        dz.ondrop = (e) => { e.preventDefault(); dz.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };

        document.getElementById('search-input').addEventListener('input', renderList);
        
        const setFilter = (f) => { 
            currentFilter = f; 
            currentSort = 'date'; 
            if(f === 'reincident') currentSort = 'count'; 
            renderList(); 
        };

        document.getElementById('filter-all-btn').onclick = () => setFilter('all');
        document.getElementById('filter-pending-btn').onclick = () => setFilter('pending');
        
        document.getElementById('filter-reincident-btn').onclick = () => {
            currentFilter = 'reincident';
            currentSort = 'count'; 
            renderList();
        };

        document.getElementById('filter-eurocop-btn').onclick = () => setFilter('eurocop');
        document.getElementById('filter-notified-btn').onclick = () => setFilter('notified');

        document.getElementById('sort-date-btn').onclick = () => { currentSort = 'date'; renderList(); };
        document.getElementById('sort-plate-btn').onclick = () => { currentSort = 'plate'; renderList(); };

        document.getElementById('undo-btn').onclick = undoAction;
        document.getElementById('delete-all-btn').onclick = () => {
             if(prompt("Escribe BORRAR para eliminar todo:") === "BORRAR") {
                 pushHistory(); allDenuncias = []; database.ref(DB_REF).set([]); renderList();
             }
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const savedHelp = localStorage.getItem('gadHelpText_FINAL_V2');
            document.getElementById('legend-content-area').innerHTML = savedHelp || DEFAULT_HELP_HTML;
        });

        const hp = document.getElementById('legend-panel');
        document.getElementById('toggle-help-btn').onclick = () => hp.classList.add('visible');
        document.getElementById('close-help-btn').onclick = () => hp.classList.remove('visible');
        
        document.getElementById('edit-help-btn').onclick = () => {
            document.getElementById('legend-content-area').contentEditable="true";
            document.getElementById('save-help-btn').style.display="inline-block";
        };
        document.getElementById('save-help-btn').onclick = () => {
            document.getElementById('legend-content-area').contentEditable="false";
            document.getElementById('save-help-btn').style.display="none";
            localStorage.setItem('gadHelpText_FINAL_V2', document.getElementById('legend-content-area').innerHTML);
            alert("Ayuda personalizada guardada.");
        };

        let targetMat = null;
        
        window.openNotifModal = (m) => { 
            targetMat = m; 
            document.getElementById('notification-modal').style.display='block'; 
            document.getElementById('modal-overlay-bg').style.display='block';
            
            document.getElementById('modal-nombre').value = '';
            document.getElementById('modal-doi').value = '';
            document.getElementById('modal-direccion').value = '';
            document.getElementById('modal-localidad').value = '';
            document.getElementById('modal-fecha-nacimiento').value = '';
            document.getElementById('modal-telefono').value = '';

            const existingRecord = allDenuncias.find(d => d.matricula === m && d.datos_notificacion && Object.keys(d.datos_notificacion).length > 0);
            
            if (existingRecord && existingRecord.datos_notificacion) {
                const saved = existingRecord.datos_notificacion;
                document.getElementById('modal-nombre').value = saved.nombre || '';
                document.getElementById('modal-doi').value = saved.doi || '';
                document.getElementById('modal-direccion').value = saved.direccion || '';
                document.getElementById('modal-localidad').value = saved.localidad || '';
                document.getElementById('modal-fecha-nacimiento').value = saved.fechaNac || '';
                document.getElementById('modal-telefono').value = saved.telefono || '';
            }
        };
        
        function closeModal() {
            document.getElementById('notification-modal').style.display='none'; 
            document.getElementById('modal-overlay-bg').style.display='none';
        }

        document.getElementById('modal-cancel-btn').onclick = closeModal;
        
        // --- GUARDADO + OUTLOOK AUTOM√ÅTICO (DESDE CUENTA ESPEC√çFICA) ---
        document.getElementById('modal-accept-btn').onclick = () => {
            pushHistory();
            
            const datosPersonales = {
                nombre: document.getElementById('modal-nombre').value,
                doi: document.getElementById('modal-doi').value,
                direccion: document.getElementById('modal-direccion').value,
                localidad: document.getElementById('modal-localidad').value,
                fechaNac: document.getElementById('modal-fecha-nacimiento').value,
                telefono: document.getElementById('modal-telefono').value
            };

            allDenuncias.forEach(d => {
                if(d.matricula === targetMat) {
                    d.notificado = true;
                    d.eurocop = false; 
                    d.alerta = false;  
                    d.datos_notificacion = datosPersonales; 
                }
            });
            database.ref(DB_REF).set(allDenuncias); 

            const denunciaRef = allDenuncias.find(d => d.matricula === targetMat) || {};
            
            const cuerpoMensaje = `
Grupo de An√°lisis Documental (GAD) Polic√≠a Local de Alicante
Le informamos de que disponemos de los siguientes datos en relaci√≥n a este veh√≠culo:

--- DENUNCIA ORA ---
- Matr√≠cula: ${denunciaRef.matricula || 'N/A'}
- Fecha: ${formatDate(denunciaRef.fecha) || 'N/A'}
- Marca: ${denunciaRef.marca || 'N/A'}
- Modelo: ${denunciaRef.modelo || 'N/A'}

--- DATOS PERSONALES ---
- Nombre: ${datosPersonales.nombre || 'N/A'}
- DOI: ${datosPersonales.doi || 'N/A'}
- Direcci√≥n: ${datosPersonales.direccion || 'N/A'}
- Localidad: ${datosPersonales.localidad || 'N/A'}
- F. Nacimiento: ${datosPersonales.fechaNac || 'N/A'}
- Tel√©fono: ${datosPersonales.telefono || 'N/A'}
            `.trim();

            copyToClipboard(cuerpoMensaje);

            const asunto = `DATOS GAD - Matr√≠cula: ${denunciaRef.matricula || ''}`;
            
            // --- URL ESPEC√çFICA CON CUENTA DE ORIGEN ---
            const urlOutlook = `https://outlook.office.com/mail/policia.gad@alicante.es/deeplink/compose?to=${CORREO_SANCIONES}&subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpoMensaje)}`;

            window.open(urlOutlook, '_blank');

            renderList(); 
            closeModal();
        };
    </script>
</body>
</html>
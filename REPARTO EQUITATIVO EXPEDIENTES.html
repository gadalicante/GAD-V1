<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel GAD Alicante - Reparto de Expedientes</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>

    <style>
        :root { --blue-main: #1a73e8; --blue-dark: #0d47a1; --success: #28a745; --danger: #d93025; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); padding: 20px; color: #333; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; }
        .help-btn { position: absolute; top: 20px; right: 20px; background: #5f6368; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 100; }
        .db-panel { background: #e8f0fe; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #c2d7fa; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .db-panel input { padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex-grow: 1; min-width: 200px; }
        .btn-db { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-load { background: var(--blue-main); color: white; }
        .setup-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; margin-bottom: 20px; }
        .ag-list input { width: 95%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 5px; display: block; }
        textarea { width: 100%; height: 120px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; }
        button#process-btn { width: 100%; padding: 15px; background: var(--blue-main); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; border: 1px solid #d1d9e0; overflow: hidden; transition: 0.3s; display: flex; flex-direction: column; }
        .card-header { background: var(--blue-main); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .card-body { padding: 15px; flex-grow: 1; }
        .task-segment { padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; border-left: 5px solid #ccc; cursor: pointer; position: relative; }
        .seg-others { background: #f0f4ff; border-left-color: var(--blue-main); }
        .seg-france { background: #fff9e6; border-left-color: #ffb300; }
        .folder-list { display: none; margin-top: 10px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 5px; max-height: 250px; overflow-y: auto; }
        .folder-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid #f9f9f9; font-size: 0.85em; user-select: none; }
        .folder-item.done { text-decoration: line-through; opacity: 0.4; background: #e8f5e9; }
        .status-area { background: #f1f3f4; border-top: 1px solid #eee; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .status-line { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.85em; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 80%; max-width: 500px; position: relative; }
        .count-badge { font-weight: bold; color: var(--danger); font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    <button class="help-btn" onclick="document.getElementById('helpModal').style.display='block'">?</button>
    <h1>GAD Alicante - Reparto de Expedientes</h1>

    <div class="db-panel">
        <strong>üìÅ Nodo: repartos</strong>
        <input type="text" id="saveName" placeholder="Nombre (Ej: Enero 2026)">
        <button class="btn-db btn-save" onclick="guardarReparto()">Guardar</button>
        <div style="border-left: 1px solid #c2d7fa; height: 30px; margin: 0 10px;"></div>
        <select id="historyList" style="padding: 8px; border-radius: 5px; max-width: 200px;" onchange="cargarReparto()"></select>
        <button class="btn-db btn-load" onclick="cargarReparto()">Cargar</button>
    </div>

    <div class="setup-grid">
        <div class="ag-list">
            <input type="text" value="Agente 1" class="ag-name"><input type="text" value="Agente 2" class="ag-name">
            <input type="text" value="Agente 3" class="ag-name"><input type="text" value="Agente 4" class="ag-name">
            <input type="text" value="Agente 5" class="ag-name">
        </div>
        <textarea id="dataInput" placeholder="Pega aqu√≠ los datos..."></textarea>
    </div>

    <button id="process-btn" onclick="procesar(true)">Dividir Tareas y Generar Reparto</button>
    <div id="results" class="results"></div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:24px;" onclick="document.getElementById('helpModal').style.display='none'">&times;</span>
        <h2>Ayuda PowerShell</h2>
        <p>1. Entra en la carpeta de los expedientes.</p>
        <p>2. Ejecuta el comando:</p>
        <code style="background:#eee; padding:5px; display:block;">Get-ChildItem -Recurse -File | Select-Object -ExpandProperty FullName | clip</code>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDz4",
        authDomain: "gad-alicante-v3.firebaseapp.com",
        databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "gad-alicante-v3",
        storageBucket: "gad-alicante-v3.firebasestorage.app",
        messagingSenderId: "906986258369",
        appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentData = null;
    let inicializado = false;
    let lastChecked = null; // Para la l√≥gica de Shift

    db.ref('repartos').on('value', (snapshot) => {
        const select = document.getElementById('historyList');
        const prev = select.value;
        select.innerHTML = '<option value="">Consultar anteriores...</option>';
        let claves = [];
        snapshot.forEach((child) => {
            claves.push(child.key);
            let opt = document.createElement('option');
            opt.value = child.key; opt.text = child.key;
            select.appendChild(opt);
        });
        if (!inicializado && claves.length > 0) {
            claves.sort();
            const ultimo = claves[claves.length - 1];
            select.value = ultimo;
            cargarReparto(); inicializado = true;
        } else { select.value = prev; }
    });

    function corregir(t) { return t.replace(/ESPA\?A/gi, "ESPA√ëA").replace(/cauci\?n/gi, "cauci√≥n"); }
    
    function extraerInfo(ruta) {
        const limpia = corregir(ruta);
        const partes = limpia.split('\\');
        let pais = "Otros", matricula = "S/M";
        for(let i=0; i < partes.length; i++) {
            const up = partes[i].toUpperCase();
            if(up.includes("SEMESTRE") || up.includes("EXPEDIENTES")) {
                pais = (partes[i+2] || "Otros").trim();
                matricula = (partes[i+3] || "S/M").trim();
                break;
            }
        }
        return { pais, matricula };
    }

    function agruparMatriculas(lineas) {
        let map = {};
        lineas.forEach(l => {
            const inf = extraerInfo(l);
            const key = `${inf.pais.toUpperCase()}|${inf.matricula.toUpperCase()}`;
            if (!map[key]) map[key] = { ...inf, archCount: 0, checked: false };
            map[key].archCount++;
        });
        return Object.values(map);
    }

    function procesar(esNuevo, datosCargados = null) {
        if(esNuevo) {
            const raw = document.getElementById('dataInput').value.trim();
            if(!raw) return;
            const lineas = raw.split('\n').filter(l => l.trim() !== "");
            const agentes = Array.from(document.querySelectorAll('.ag-name')).map(i => i.value);
            const frUnicos = agruparMatriculas(lineas.filter(l => extraerInfo(l).pais.toUpperCase().includes("FRANCIA")));
            const otUnicos = agruparMatriculas(lineas.filter(l => !extraerInfo(l).pais.toUpperCase().includes("FRANCIA")));

            const dividir = (arr, n) => {
                let res = Array.from({length: n}, () => []);
                arr.forEach((item, idx) => res[idx % n].push(item));
                return res;
            };

            currentData = { 
                agentes, bloqueOtros: dividir(otUnicos, 5), bloqueFrancia: dividir(frUnicos, 5),
                statusOtros: [false,false,false,false,false], statusFrancia: [false,false,false,false,false], statusTodo: [false,false,false,false,false]
            };
        } else { currentData = datosCargados; }
        renderizar();
    }

    function obtenerAgrupados(lista) {
        const agrupados = new Map();
        lista.forEach((item, originalIdx) => {
            const key = `${item.pais.toUpperCase()}|${item.matricula.toUpperCase()}`;
            if (!agrupados.has(key)) {
                agrupados.set(key, { ...item, indices: [], totalArchivos: 0, todoCheck: true });
            }
            const g = agrupados.get(key);
            g.indices.push(originalIdx);
            g.totalArchivos += (parseInt(item.archCount) || 1);
            if (!item.checked) g.todoCheck = false;
        });
        return Array.from(agrupados.values());
    }

    function renderizar() {
        const resDiv = document.getElementById('results');
        resDiv.innerHTML = "";
        if(!currentData) return;

        currentData.agentes.forEach((name, i) => {
            const card = document.createElement('div');
            card.className = 'card' + (currentData.statusTodo && currentData.statusTodo[i] ? ' done-all' : '');
            card.id = `card-agent-${i}`;
            
            const listaOt = obtenerAgrupados(currentData.bloqueOtros[i] || []);
            const listaFr = obtenerAgrupados(currentData.bloqueFrancia[i] || []);
            const totalAg = [...listaOt, ...listaFr].reduce((a, b) => a + b.totalArchivos, 0);
            const pendAg = [...listaOt, ...listaFr].reduce((a, b) => a + (b.todoCheck ? 0 : b.totalArchivos), 0);

            card.innerHTML = `
                <div class="card-header">
                    <span>${name}</span>
                    <span id="stat-total-${i}" style="font-size: 0.85em;">Restan: ${pendAg} de ${totalAg}</span>
                </div>
                <div class="card-body">
                    ${renderBloque(listaOt, i, 'ot', 'üåé OTROS')}
                    ${renderBloque(listaFr, i, 'fr', 'üá´üá∑ FRANCIA')}
                </div>
                <div class="status-area">
                    <label class="status-line"><input type="checkbox" id="gen-ot-${i}" ${currentData.statusOtros && currentData.statusOtros[i] ? 'checked' : ''} onchange="toggleGrupoPersistente(${i}, 'ot', this.checked)"> Realizado OTROS</label>
                    <label class="status-line"><input type="checkbox" id="gen-fr-${i}" ${currentData.statusFrancia && currentData.statusFrancia[i] ? 'checked' : ''} onchange="toggleGrupoPersistente(${i}, 'fr', this.checked)"> Realizado FRANCIA</label>
                    <label class="status-line"><input type="checkbox" id="gen-all-${i}" ${currentData.statusTodo && currentData.statusTodo[i] ? 'checked' : ''} onchange="saveGeneralStatus(${i}, 'statusTodo', this.checked)"> Realizado TODO</label>
                </div>
            `;
            resDiv.appendChild(card);
        });
    }

    function renderBloque(agrupados, agIdx, tipo, titulo) {
        if(!agrupados || !agrupados.length) return "";
        const pendBloque = agrupados.reduce((a, b) => a + (b.todoCheck ? 0 : b.totalArchivos), 0);
        const first = agrupados[0], last = agrupados[agrupados.length-1];

        return `
            <div class="task-segment seg-${tipo}" onclick="toggleFolders('${tipo}', ${agIdx}, event)">
                <div style="display:flex; justify-content:space-between;">
                    <strong>${titulo}</strong>
                    <span id="stat-bloque-${tipo}-${agIdx}" class="count-badge">${pendBloque} archivos</span>
                </div>
                <span style="font-size:0.8em;">Del ${first.matricula} al ${last.matricula}</span>
                <div class="folder-list" id="list-${tipo}-${agIdx}">
                    ${agrupados.map((g, gIdx) => `
                        <div class="folder-item ${g.todoCheck ? 'done' : ''}" id="item-${tipo}-${agIdx}-${gIdx}">
                            <input type="checkbox" id="chk-${tipo}-${agIdx}-${gIdx}" ${g.todoCheck ? 'checked' : ''} 
                                onchange="actualizarMatriculaAgrupada(${agIdx}, '${tipo}', ${gIdx}, this.checked)"
                                onclick="eventoShift(event, this, ${agIdx}, '${tipo}', ${gIdx})">
                            <span>${g.pais} - ${g.matricula} <strong>(${g.totalArchivos})</strong></span>
                        </div>`).join('')}
                </div>
            </div>`;
    }

    function toggleFolders(t, i, e) {
        const el = document.getElementById(`list-${t}-${i}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function actualizarContadoresVista(agIdx) {
        const listaOt = obtenerAgrupados(currentData.bloqueOtros[agIdx] || []);
        const listaFr = obtenerAgrupados(currentData.bloqueFrancia[agIdx] || []);
        
        const totalAg = [...listaOt, ...listaFr].reduce((a, b) => a + b.totalArchivos, 0);
        const pendAg = [...listaOt, ...listaFr].reduce((a, b) => a + (b.todoCheck ? 0 : b.totalArchivos), 0);
        const pendOt = listaOt.reduce((a, b) => a + (b.todoCheck ? 0 : b.totalArchivos), 0);
        const pendFr = listaFr.reduce((a, b) => a + (b.todoCheck ? 0 : b.totalArchivos), 0);

        document.getElementById(`stat-total-${agIdx}`).innerText = `Restan: ${pendAg} de ${totalAg}`;
        const bOt = document.getElementById(`stat-bloque-ot-${agIdx}`);
        if(bOt) bOt.innerText = `${pendOt} archivos`;
        const bFr = document.getElementById(`stat-bloque-fr-${agIdx}`);
        if(bFr) bFr.innerText = `${pendFr} archivos`;
    }

    function actualizarMatriculaAgrupada(agIdx, tipo, gIdx, val) {
        const bloqueStr = tipo === 'ot' ? 'bloqueOtros' : 'bloqueFrancia';
        const agrupados = obtenerAgrupados(currentData[bloqueStr][agIdx]);
        const itemG = agrupados[gIdx];
        const saveName = document.getElementById('saveName').value;

        itemG.indices.forEach(idxOriginal => {
            currentData[bloqueStr][agIdx][idxOriginal].checked = val;
            if(saveName) db.ref(`repartos/${saveName}/${bloqueStr}/${agIdx}/${idxOriginal}`).update({checked: val});
        });

        // UI local
        const elItem = document.getElementById(`item-${tipo}-${agIdx}-${gIdx}`);
        if(elItem) elItem.classList.toggle('done', val);
        const chk = document.getElementById(`chk-${tipo}-${agIdx}-${gIdx}`);
        if(chk) chk.checked = val;

        actualizarContadoresVista(agIdx);
    }

    function eventoShift(e, current, agIdx, tipo, gIdx) {
        e.stopPropagation();
        if (e.shiftKey && lastChecked && lastChecked.agIdx === agIdx && lastChecked.tipo === tipo) {
            let start = Math.min(gIdx, lastChecked.gIdx);
            let end = Math.max(gIdx, lastChecked.gIdx);
            
            for (let i = start; i <= end; i++) {
                actualizarMatriculaAgrupada(agIdx, tipo, i, current.checked);
            }
        }
        lastChecked = { agIdx, tipo, gIdx };
    }

    function toggleGrupoPersistente(agIdx, tipo, val) {
        const bloqueStr = tipo === 'ot' ? 'bloqueOtros' : 'bloqueFrancia';
        const saveName = document.getElementById('saveName').value;
        currentData[bloqueStr][agIdx].forEach((item, idx) => {
            item.checked = val;
            if(saveName) db.ref(`repartos/${saveName}/${bloqueStr}/${agIdx}/${idx}`).update({checked: val});
        });
        
        const agrupados = obtenerAgrupados(currentData[bloqueStr][agIdx]);
        agrupados.forEach((g, gIdx) => {
            const chk = document.getElementById(`chk-${tipo}-${agIdx}-${gIdx}`);
            if(chk) chk.checked = val;
            const item = document.getElementById(`item-${tipo}-${agIdx}-${gIdx}`);
            if(item) item.classList.toggle('done', val);
        });
        
        saveGeneralStatus(agIdx, tipo === 'ot' ? 'statusOtros' : 'statusFrancia', val, false);
        actualizarContadoresVista(agIdx);
    }

    function saveGeneralStatus(idx, campo, val, reRender = true) {
        const saveName = document.getElementById('saveName').value;
        if(!currentData[campo]) currentData[campo] = [false,false,false,false,false];
        currentData[campo][idx] = val;
        if(saveName) db.ref(`repartos/${saveName}/${campo}/${idx}`).set(val);
        
        if(campo === 'statusTodo') {
            document.getElementById(`card-agent-${idx}`).classList.toggle('done-all', val);
        }
        if(reRender) renderizar();
    }

    function cargarReparto() {
        const n = document.getElementById('historyList').value;
        if(!n) return;
        db.ref('repartos/' + n).once('value').then(s => { 
            if(s.exists()){ procesar(false, s.val()); document.getElementById('saveName').value = n; }
        });
    }

    function guardarReparto() {
        const n = document.getElementById('saveName').value.trim();
        if(!n || !currentData) return alert("Faltan datos.");
        db.ref('repartos/' + n).set(currentData).then(() => alert("Guardado con √©xito en repartos."));
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFICIO PADR칍N GAD - V3 FINAL</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- ESTILOS BASE --- */
        * { box-sizing: border-box; }
        body { background-color: #374151; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
        
        .page-a4 {
            width: 210mm; height: 297mm; background: white; margin: 20px auto; padding: 10mm;
            box-shadow: 0 0 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; position: relative; overflow: hidden;
        }

        .form-container { border: 2px solid black; width: 100%; display: flex; flex-direction: column; font-size: 11px; flex-shrink: 0; }
        .acta-row { display: flex; width: 100%; border-bottom: 1px solid black; position: relative; }
        .acta-row:last-child { border-bottom: none; }

        .field-container { position: relative; display: flex; flex-direction: column; padding: 2px 5px; min-width: 0; border-right: 1px solid black; justify-content: center; overflow: hidden; }
        .field-container.is-last { border-right: none; flex-grow: 1 !important; width: auto !important; }

        .label { font-size: 10px; font-weight: 800; margin-bottom: 1px; color: #000; white-space: pre-wrap; outline: none; }
        .input-data { width: 100%; font-family: 'Courier New', monospace; font-weight: bold; font-size: 13px; outline: none; background: transparent; border: none; padding: 0; color: #000; }
        
        .section-bar { background-color: #e5e7eb; border-bottom: 1px solid black; font-weight: 800; text-align: left; font-size: 11px; padding: 4px 8px; width: 100%; position: relative; font-style: italic; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

        /* TEXTO LEGAL AUMENTADO */
        .legal-text { 
            font-size: 13.5px; /* M치s grande */
            text-align: justify; 
            line-height: 1.6; /* M치s espaciado */
            color: #000; 
            margin-top: 15px; 
            margin-bottom: 15px; 
            outline: none; 
        }
        .legal-text p { margin-bottom: 12px; }
        .legal-bold { font-weight: bold; }
        
        .fill-space { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; }

        .header-text { font-size: 10px; line-height: 1.2; text-align: center; color: #000; outline: none; }
        .header-title { font-weight: bold; font-size: 12px; margin-bottom: 2px; outline: none; }

        .editing .field-container { background: rgba(59, 130, 246, 0.05); }
        .editing .section-bar { background: #dbeafe; cursor: text; }
        .editing .editable-block { border: 1px dashed blue; background-color: #eff6ff; cursor: text; }
        
        .resizer { position: absolute; right: -5px; top: 0; bottom: 0; width: 10px; cursor: col-resize; z-index: 50; display: flex; justify-content: center; align-items: center; }
        .resizer::after { content: ''; width: 2px; height: 100%; background: #3b82f6; display: none; }
        .editing .resizer:hover::after { display: block; }

        @media print {
            @page { size: A4 portrait; margin: 0; }
            body * { visibility: hidden; }
            .page-a4, .page-a4 * { visibility: visible; }
            .page-a4 { position: absolute; left: 0; top: 0; width: 210mm !important; height: 297mm !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, .resizer { display: none !important; }
            .input-data { color: #000 !important; }
            .editing .editable-block { border: none; background: transparent; }
            .section-bar { background-color: #e5e7eb !important; }
            .print-only { display: flex !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const EditableBlock = ({ html, tagName = "div", className, isEditMode, onChange }) => {
            const ContentTag = tagName;
            return (
                <ContentTag
                    className={`editable-block ${className || ''}`}
                    contentEditable={isEditMode}
                    suppressContentEditableWarning={true}
                    dangerouslySetInnerHTML={{ __html: html }}
                    onBlur={(e) => onChange && onChange(e.target.innerHTML)}
                />
            );
        };

        const EditableLabel = ({ text, onChange, isEditMode }) => {
            return (
                <div className="editable-block label" contentEditable={isEditMode} suppressContentEditableWarning={true} onBlur={(e) => onChange(e.target.innerText)}>
                    {text}
                </div>
            );
        };

        const App = () => {
            const storageKey = 'oficio_padron_gad_v3';
            const logoKey = 'logos_padron_gad_v3';

            const initialTexts = {
                header_info: `<div class="header-title">EXCMO. AYUNTAMIENTO DE ALICANTE</div>
                              <div class="header-title">POLIC칈A LOCAL</div>
                              <div class="header-text mt-2 font-bold">Grupo de An치lisis Documental</div>
                              <div class="header-text font-bold">Unidad Judicial de Tr치fico</div>
                              <div class="header-text mt-1">Av. Juli치n Besteiro 15</div>
                              <div class="header-text text-blue-800 underline">Email: policia.gad@alicante.es</div>
                              <div class="header-text">TEL: +34629111387 - Central PL 965107200</div>`,
                
                title: "OFICIO DE SOLICITUD DE DATOS DE EMPADRONAMIENTO",
                
                // Texto Ampliado y Profesionalizado
                body1: `<p>Los agentes del Grupo de An치lisis Documental G.A.D de la Polic칤a Local de Alicante por medio del presente exponen:</p>
                        <p>Con motivo del procedimiento administrativo abierto por presunta infracci칩n tributaria, solicitamos tenga a bien facilitar datos del padr칩n municipal con el fin de poder finalizar el procedimiento abierto, <span class="legal-bold">as칤 como datos del resto de miembros convivientes en el mismo domicilio</span>, ampar치ndose dicha solicitud seg칰n lo establecido en el apartado 5 del art칤culo 94 de la Ley General Tributaria 58/2003 de 17 de diciembre en relaci칩n con el art칤culo 11.2.a) de la LOPD 3/2018 de 5 de diciembre.</p>
                        <p>Asimismo, se invoca el <span class="legal-bold">deber de colaboraci칩n</span> y asistencia rec칤proca entre Administraciones P칰blicas, recogido en el art칤culo 141 de la Ley 40/2015, de 1 de octubre, de R칠gimen Jur칤dico del Sector P칰blico, rogando que la informaci칩n requerida sea remitida a esta Unidad a la mayor brevedad posible para su incorporaci칩n a las diligencias en curso.</p>`,

                sigAgente: "EL AGENTE SOLICITANTE:",
            };

            const initialTemplate = [
                // Ayuntamiento destino
                { type: 'row', id: 'r_ayto', fields: [{id: 'ayuntamiento_destino', label: 'ESCRITO DIRIGIDO AL AYUNTAMIENTO DE', width: 100}] },
                
                // R0: Fecha y Eurocop
                { type: 'row', id: 'r0', fields: [{id: 'fecha_oficio', label: 'Fecha:', width: 50}, {id: 'eurocop', label: 'Eurocop N.췈:', width: 50}] },
                
                // Secci칩n Persona
                { type: 'section', id: 's1', title: 'DATOS DE LA PERSONA INVESTIGADA' },
                { type: 'row', id: 'r1', fields: [{id: 'nombre_investigado', label: 'Nombre y Apellidos:', width: 100}] },
                
                // NUEVA FILA: DNI + FECHA NACIMIENTO
                { type: 'row', id: 'r1b', fields: [
                    {id: 'dni_investigado', label: 'DNI / NIE:', width: 50}, 
                    {id: 'fecha_nacimiento', label: 'Fecha de Nacimiento:', width: 50}
                ] },

                { type: 'row', id: 'r2', fields: [{id: 'domicilio', label: 'Domicilio objeto de comprobaci칩n:', width: 100}] },
                
                // Agente
                { type: 'row', id: 'r3', fields: [{id: 'agente', label: 'NIP Agente:', width: 30}, {id: 'unidad', label: 'Unidad:', width: 70}] },
            ];

            const [template, setTemplate] = React.useState(initialTemplate);
            const [texts, setTexts] = React.useState(initialTexts);
            const [formData, setFormData] = React.useState({});
            const [actas, setActas] = React.useState({});
            const [isEditMode, setIsEditMode] = React.useState(false);
            const [dragState, setDragState] = React.useState(null);
            const [logos, setLogos] = React.useState({ left: 'judicial.png', right: 'logogad.png' });

            React.useEffect(() => {
                const stored = JSON.parse(localStorage.getItem(storageKey) || "{}");
                setActas(stored);
                const l = JSON.parse(localStorage.getItem(logoKey));
                if(l) setLogos(l);
                autoFillData();
            }, []);

            const autoFillData = () => {
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hour = now.getHours();
                let agente = (hour >= 6 && hour < 14) ? "G-118" : "G-279";
                const todayStr = `${day}/${month}/${year}`;

                setFormData(prev => {
                    if (Object.keys(prev).length === 0) {
                        return {
                            ayuntamiento_destino: "",
                            fecha_oficio: todayStr,
                            eurocop: "",
                            nombre_investigado: "",
                            dni_investigado: "",
                            fecha_nacimiento: "", // Nuevo campo
                            domicilio: "",
                            agente: agente,
                            unidad: "Grupo de An치lisis Documental G.A.D - Unidad Judicial de Tr치fico"
                        };
                    }
                    return prev;
                });
            };

            // L칩gica Edici칩n y Redimensionado
            React.useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!dragState) return; e.preventDefault();
                    const row = document.getElementById(`row-${dragState.rIdx}`);
                    if (!row) return;
                    const deltaPixels = e.clientX - dragState.startX;
                    const deltaPercent = (deltaPixels / row.offsetWidth) * 100;
                    const newWidth = Math.max(5, dragState.startW + deltaPercent);
                    setTemplate(prev => {
                        const newT = [...prev]; newT[dragState.rIdx].fields[dragState.fIdx].width = newWidth;
                        return newT;
                    });
                };
                const handleMouseUp = () => setDragState(null);
                if (dragState) { document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); }
                return () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); };
            }, [dragState]);

            const startResize = (e, rIdx, fIdx, w) => { e.preventDefault(); e.stopPropagation(); setDragState({rIdx, fIdx, startX: e.clientX, startW: w}); };
            const updateLabel = (rIdx, fIdx, newText) => { setTemplate(prev => { const newT = [...prev]; newT[rIdx].fields[fIdx].label = newText; return newT; }); };
            const updateText = (key, newHtml) => { setTexts(prev => ({...prev, [key]: newHtml})); };
            const updateSectionTitle = (rIdx, newTitle) => { setTemplate(prev => { const newT = [...prev]; newT[rIdx].title = newTitle; return newT; }); };
            
            // --- L칍GICA DE FORMATEO DE FECHA (Aplicada a fecha_oficio Y fecha_nacimiento) ---
            const handleChange = (id, value) => { 
                let newValue = value;
                
                if (['fecha_oficio', 'fecha_nacimiento'].includes(id)) {
                    const cleanValue = value.replace(/[^0-9]/g, ''); 
                    
                    if (cleanValue.length === 8) {
                        newValue = `${cleanValue.substring(0, 2)}/${cleanValue.substring(2, 4)}/${cleanValue.substring(4, 8)}`;
                    } 
                    else if (cleanValue.length < 8) {
                        newValue = value.replace(/[^0-9/-]/g, ''); 
                    }
                    if (newValue.length > 10) {
                        newValue = newValue.slice(0, 10);
                    }
                }

                setFormData(prev => ({ ...prev, [id]: newValue })); 
            };
            
            const saveActa = () => { 
                const id = prompt("Nombre:", `Padr칩n ${formData.nombre_investigado || Date.now()}`); 
                if(!id) return; 
                const n = {...actas, [id]: {id, data: formData, template, texts}}; 
                setActas(n); 
                localStorage.setItem(storageKey, JSON.stringify(n)); 
            };
            const loadActa = (id) => { const a = actas[id]; if(a) { setFormData(a.data); if(a.template) setTemplate(a.template); if(a.texts) setTexts(a.texts); } };
            const handleLogoUpload = (e, key) => { const f = e.target.files[0]; if(f){ const r = new FileReader(); r.onload = (ev) => { const newLogos = {...logos, [key]: ev.target.result}; setLogos(newLogos); localStorage.setItem(logoKey, JSON.stringify(newLogos)); }; r.readAsDataURL(f); } };

            const renderFieldContent = (field) => {
                return <input className="input-data" value={formData[field.id] || ''} onChange={(e)=>handleChange(field.id, e.target.value)} />;
            };

            return (
                <div className="flex h-screen">
                    <div className="w-64 bg-gray-900 text-white p-4 no-print flex flex-col gap-2 overflow-y-auto shrink-0 border-r border-gray-700">
                        <h2 className="text-lg font-bold text-blue-400">游늭 Solicitudes Padr칩n</h2>
                        <button onClick={()=>{setFormData({}); setTemplate(initialTemplate); autoFillData()}} className="bg-green-600 p-2 rounded text-xs font-bold hover:bg-green-700 w-full mb-4">NUEVO OFICIO</button>
                        <div className="flex-1 space-y-1">
                            {Object.keys(actas).map(k => (
                                <div key={k} onClick={()=>loadActa(k)} className="p-2 bg-gray-800 hover:bg-gray-700 rounded cursor-pointer text-xs border border-gray-700 truncate">{k}</div>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 bg-gray-200 flex flex-col overflow-hidden">
                        <div className="bg-white p-2 shadow flex justify-between items-center no-print z-50 shrink-0 h-14">
                            <div className="font-bold text-gray-700 text-sm flex gap-2"><span>SOLICITUD PADR칍N</span>{isEditMode && <span className="bg-yellow-100 text-yellow-800 px-2 rounded border border-yellow-300">DISE칌O</span>}</div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsEditMode(!isEditMode)} className="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm border">Editar</button>
                                <button onClick={saveActa} className="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold">Guardar</button>
                                <button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-1 rounded text-sm font-bold">Imprimir</button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto p-8 flex justify-center bg-gray-500">
                            <div className={`page-a4 ${isEditMode?'editing':''}`}>
                                
                                <div className="flex justify-between items-start mb-2 relative">
                                    <div className="w-24 h-24 relative cursor-pointer hover:bg-gray-50 group flex items-center justify-center">
                                        {!logos.left ? <span className="text-[9px] text-gray-400">judicial.png</span> : <img src={logos.left} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>handleLogoUpload(e,'left')}/>
                                    </div>
                                    <div className="flex-1 px-2 text-center">
                                        <EditableBlock html={texts.header_info} isEditMode={isEditMode} onChange={(val)=>updateText('header_info', val)} />
                                    </div>
                                    <div className="w-24 h-24 relative cursor-pointer hover:bg-gray-50 group flex items-center justify-center">
                                        {!logos.right ? <span className="text-[9px] text-gray-400">logogad.png</span> : <img src={logos.right} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>handleLogoUpload(e,'right')}/>
                                    </div>
                                </div>

                                <EditableBlock tagName="div" className="text-center font-bold text-sm uppercase bg-gray-100 py-1 border-2 border-black border-solid mb-3" html={texts.title} isEditMode={isEditMode} onChange={(val) => updateText('title', val)} />

                                <div className="form-container mb-2 flex-shrink-0">
                                    {template.map((row, rIdx) => {
                                        if (row.type === 'section') {
                                            return <div key={row.id} className="section-bar" contentEditable={isEditMode} suppressContentEditableWarning onBlur={(e) => updateSectionTitle(rIdx, e.target.innerText)}>{row.title}</div>;
                                        }
                                        return (
                                            <div key={row.id} id={`row-${rIdx}`} className="acta-row">
                                                {row.fields.map((f, fIdx) => {
                                                    const isLast = fIdx === row.fields.length - 1;
                                                    return (
                                                        <div key={f.id} className={`field-container ${isLast ? 'is-last' : ''}`} style={{width: isLast ? 'auto' : `${f.width}%`}}>
                                                            <EditableLabel text={f.label} isEditMode={isEditMode} onChange={(val)=>updateLabel(rIdx, fIdx, val)} />
                                                            {renderFieldContent(f)}
                                                            {isEditMode && !isLast && <div className="resizer" onMouseDown={(e)=>startResize(e, rIdx, fIdx, f.width)}></div>}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })}
                                </div>

                                <EditableBlock tagName="div" className="legal-text fill-space" html={texts.body1} isEditMode={isEditMode} onChange={(val) => updateText('body1', val)} />

                                {/* ZONA INFERIOR FIRMAS (30% Agente / 70% Digital) */}
                                <div className="mt-auto flex h-52 border-t-2 border-black pt-4 relative flex-shrink-0">
                                    
                                    {/* COLUMNA IZQUIERDA: AGENTE MANUSCRITO */}
                                    <div className="w-[30%] flex flex-col pr-4 border-r-2 border-gray-300 border-dashed justify-between gap-10 pt-2 pb-4">
                                        <div className="flex flex-col">
                                            <div className="text-[11px] font-bold text-center">
                                                <EditableBlock tagName="span" html={texts.sigAgente} isEditMode={isEditMode} onChange={(val) => updateText('sigAgente', val)} /> {formData.agente}
                                            </div>
                                        </div>
                                        <div className="border-t border-black pt-1 text-[11px] text-center">
                                            Fdo.
                                        </div>
                                    </div>

                                    {/* COLUMNA DERECHA: FIRMA DIGITAL */}
                                    <div className="w-[70%] flex flex-col items-center justify-center pl-2 h-full pb-2 relative">
                                        
                                        {/* VERSI칍N PANTALLA */}
                                        <div className="w-full h-full border-2 border-dashed border-gray-400 rounded bg-gray-50 flex items-center justify-center text-center p-2 no-print">
                                            <span className="text-gray-400 text-sm font-bold transform -rotate-12 select-none">
                                                ESPACIO RESERVADO<br/>PARA FIRMA DIGITAL
                                            </span>
                                        </div>

                                        {/* VERSI칍N IMPRESI칍N - BAJADA 5MM */}
                                        <div className="w-full h-full flex-col justify-end items-center print-only hidden">
                                            <div className="text-[9px] text-gray-500 w-3/4 text-center border-t border-gray-400 pt-1 mb-0 transform translate-y-[5mm]">
                                                Espacio reservado para firma digital
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
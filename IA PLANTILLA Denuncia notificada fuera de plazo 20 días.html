<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFICIO JPT - IA MANUSCRITA</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- ESTILOS BASE --- */
        * { box-sizing: border-box; }
        body { background-color: #374151; height: 100vh; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
        
        .page-a4 {
            width: 210mm; height: 297mm; background: white; margin: 20px auto; padding: 10mm;
            box-shadow: 0 0 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: all 0.2s;
        }

        .form-container { border: 2px solid black; width: 100%; display: flex; flex-direction: column; font-size: 11px; flex-shrink: 0; }
        .acta-row { display: flex; width: 100%; border-bottom: 1px solid black; position: relative; }
        .acta-row:last-child { border-bottom: none; }

        .field-container { position: relative; display: flex; flex-direction: column; padding: 2px 5px; min-width: 0; border-right: 1px solid black; justify-content: center; overflow: hidden; }
        .field-container.is-last { border-right: none; flex-grow: 1 !important; width: auto !important; }

        .section-bar { 
            background-color: #e5e7eb; border-bottom: 1px solid black; font-weight: 800; 
            text-align: left; font-size: 11px; padding: 4px 8px; width: 100%; position: relative; 
            font-style: italic; -webkit-print-color-adjust: exact; print-color-adjust: exact;
            border-top: 1px solid black; margin-top: -1px;
        }

        .label { font-size: 10px; font-weight: 800; margin-bottom: 1px; color: #000; white-space: pre-wrap; outline: none; }
        .input-data { width: 100%; font-family: 'Courier New', monospace; font-weight: bold; font-size: 13px; outline: none; background: transparent; border: none; padding: 0; color: #000; }
        
        .legal-text { font-size: 13.5px; text-align: justify; line-height: 1.6; color: #000; margin-top: 10px; margin-bottom: 10px; outline: none; }
        .legal-text p { margin-bottom: 10px; }
        .legal-bold { font-weight: bold; }
        .fill-space { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; }

        .header-text { font-size: 10px; line-height: 1.2; text-align: center; color: #000; outline: none; }
        .header-title { font-weight: bold; font-size: 12px; margin-bottom: 2px; outline: none; }

        /* --- ZONA IA COMBINADA (VERDE) --- */
        .drop-zone-combined { 
            outline: 2px solid transparent; 
            transition: all 0.2s; 
            position: relative; 
            display: flex; 
            flex-direction: column;
        }
        
        /* Efecto Verde al Arrastrar */
        .drop-zone-combined:focus-within, .drop-zone-combined.drag-active {
            background-color: rgba(34, 197, 94, 0.05);
            outline: 2px dashed #22c55e;
            outline-offset: -2px;
            z-index: 10;
        }

        /* Loading */
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.96); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Edici√≥n */
        .editing .field-container { background: rgba(59, 130, 246, 0.05); }
        .editing .section-bar { background: #dbeafe; cursor: text; }
        .editing .editable-block { border: 1px dashed blue; background-color: #eff6ff; cursor: text; }
        .editing { user-select: none; }
        
        .resizer { position: absolute; right: -5px; top: 0; bottom: 0; width: 10px; cursor: col-resize; z-index: 50; display: flex; justify-content: center; align-items: center; }
        .resizer::after { content: ''; width: 2px; height: 100%; background: #3b82f6; display: none; }
        .editing .resizer:hover::after { display: block; }

        /* Men√∫ Contextual */
        .context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 1000; padding: 5px 0; border-radius: 4px; font-size: 12px; min-width: 150px; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .context-menu-item:hover { background-color: #f3f4f6; }

        @media print {
            @page { size: A4 portrait; margin: 0; }
            body * { visibility: hidden; }
            .page-a4, .page-a4 * { visibility: visible; }
            .page-a4 { position: absolute; left: 0; top: 0; width: 210mm !important; height: 297mm !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, .resizer, .loading-overlay, .context-menu, .paste-btn { display: none !important; }
            .input-data { color: #000 !important; }
            .editing .editable-block { border: none; background: transparent; }
            .section-bar { background-color: #e5e7eb !important; }
            .drop-zone-combined { background: transparent !important; outline: none !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Helper Fecha
        const formatToDate = (value) => {
            let cleaned = value.replace(/-/g, '/').replace(/\D/g, '').substring(0, 8);
            if (cleaned.length > 2 && cleaned.length <= 4) return `${cleaned.substring(0, 2)}/${cleaned.substring(2)}`;
            else if (cleaned.length > 4) return `${cleaned.substring(0, 2)}/${cleaned.substring(2, 4)}/${cleaned.substring(4)}`;
            return cleaned;
        };

        const EditableBlock = ({ html, tagName = "div", className, isEditMode, onChange }) => {
            const ContentTag = tagName;
            return (
                <ContentTag
                    className={`editable-block ${className || ''}`}
                    contentEditable={isEditMode}
                    suppressContentEditableWarning={true}
                    dangerouslySetInnerHTML={{ __html: html }}
                    onBlur={(e) => onChange && onChange(e.target.innerHTML)}
                />
            );
        };

        const EditableLabel = ({ text, onChange, isEditMode }) => (
            <div className="editable-block label" contentEditable={isEditMode} suppressContentEditableWarning={true} onBlur={(e) => onChange(e.target.innerText)}>{text}</div>
        );

        const App = () => {
            const storageKey = 'oficio_jpt_ia_final';
            const logoKey = 'logos_jpt_gad_v5';

            const initialTexts = {
                header_info: `<div class="header-title">EXCMO. AYUNTAMIENTO DE ALICANTE</div>
                              <div class="header-title">POLIC√çA LOCAL</div>
                              <div class="header-text mt-2 font-bold">Grupo de An√°lisis Documental</div>
                              <div class="header-text font-bold">Unidad Judicial de Tr√°fico</div>
                              <div class="header-text mt-1">Av. Juli√°n Besteiro 15</div>
                              <div class="header-text text-blue-800 underline">Email: policia.gad@alicante.es</div>
                              <div class="header-text">TEL: +34629111387 - Central PL 965107200</div>`,
                title: "OFICIO INFORMANDO SOBRE NOTIFICACI√ìN DE DENUNCIA PASADOS 20 D√çAS DE LA INFRACCI√ìN",
                body1: `<p>Se comunica a esa Jefatura Provincial de Tr√°fico que, por parte de agentes adscritos al Grupo de An√°lisis Documental de la Polic√≠a Local de Alicante, se ha procedido en el d√≠a de la fecha a la <span class="legal-bold">notificaci√≥n efectiva</span> del Bolet√≠n de Denuncia referenciado m√°s arriba.</p>
                        <p>Dicha infracci√≥n fue cometida con una anterioridad superior a 20 d√≠as naturales. No obstante, al tratarse de un infractor que <span class="legal-bold">no acredita residencia legal en territorio espa√±ol</span> (Art. 87.5 LSV) y debiendo procederse al cobro de la sanci√≥n para permitir la marcha del veh√≠culo, se ha instruido al interesado para que realice el pago a trav√©s del portal de la DGT.</p>
                        <p>A fin de evitar indefensi√≥n y permitir que el interesado pueda beneficiarse de la bonificaci√≥n del 50% por pronto pago a la que tiene derecho tras esta notificaci√≥n personal, se le ha indicado que consigne en la pasarela de pago la <span class="legal-bold">FECHA DE HOY (fecha de notificaci√≥n)</span> y no la fecha original de la infracci√≥n, dado que el sistema inform√°tico rechazar√≠a el descuento por estar fuera de plazo.</p>`,
                body2: `<p>Se extiende la presente diligencia para conocimiento de la Jefatura Provincial de Tr√°fico de Alicante, justificando as√≠ la discrepancia de fechas en el pago telem√°tico y confirmando la actuaci√≥n de los agentes conforme a lo establecido en la Ley de Seguridad Vial.</p>`,
                sigAgente: "EL AGENTE NOTIFICADOR:",
            };

            const initialTemplate = [
                // ZONA VERDE (0-4)
                { type: 'section', id: 's0', title: 'DATOS DEL BOLET√çN DE DENUNCIA' },
                { type: 'row', id: 'r0', fields: [{id: 'fecha_oficio', label: 'Fecha:', width: 20}, {id: 'jpt_n', label: 'BOLET√çN JPT N.¬∫:', width: 40}, {id: 'matricula', label: 'Matr√≠cula:', width: 40}] },
                { type: 'row', id: 'r1', fields: [{id: 'fecha_infraccion', label: 'Fecha de la denuncia:', width: 50}, {id: 'fecha_notificacion', label: 'Fecha de la notificaci√≥n:', width: 50}] },
                { type: 'section', id: 's1', title: 'DATOS DEL INFRACTOR / NOTIFICADO' },
                { type: 'row', id: 'r2', fields: [{id: 'doc_identidad', label: 'Documento de Identidad', width: 25}, {id: 'nombre_apellidos', label: 'Nombre y Apellidos', width: 50}, {id: 'fecha_nacimiento', label: 'Fecha Nacimiento', width: 25}] }
            ];

            const [template, setTemplate] = React.useState(initialTemplate);
            const [texts, setTexts] = React.useState(initialTexts);
            const [formData, setFormData] = React.useState({});
            const [actas, setActas] = React.useState({});
            const [isEditMode, setIsEditMode] = React.useState(false);
            const [logos, setLogos] = React.useState({ left: 'judicial.png', right: 'logogad.png' });
            
            // IA & INTERACCI√ìN
            const [apiKey, setApiKey] = React.useState(localStorage.getItem('ai_api_key') || '');
            const [geminiModelName, setGeminiModelName] = React.useState(localStorage.getItem('gemini_model_name') || 'gemini-2.5-flash');
            const [showKeyInput, setShowKeyInput] = React.useState(false);
            const [processing, setProcessing] = React.useState({active: false, msg: ''});
            const [dragState, setDragState] = React.useState(null);
            const [dragTarget, setDragTarget] = React.useState(null);
            const [contextMenu, setContextMenu] = React.useState(null);

            React.useEffect(() => {
                const stored = JSON.parse(localStorage.getItem(storageKey) || "{}");
                setActas(stored);
                const l = JSON.parse(localStorage.getItem(logoKey));
                if(l) setLogos(l);
                
                if (!localStorage.getItem('ai_provider')) localStorage.setItem('ai_provider', 'gemini');
                if (!localStorage.getItem('gemini_model_name')) localStorage.setItem('gemini_model_name', geminiModelName);

                autoFillData();
                setDragTarget(null);
                const closeMenu = () => setContextMenu(null);
                window.addEventListener('click', closeMenu);
                return () => window.removeEventListener('click', closeMenu);
            }, []);

            const autoFillData = () => {
                const now = new Date();
                const todayStr = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
                const hour = now.getHours();
                const agente = (hour >= 6 && hour < 14) ? "G-118" : "G-279";

                setFormData(prev => {
                    if (Object.keys(prev).length === 0) {
                        return {
                            fecha_oficio: todayStr, jpt_n: "", matricula: "", fecha_infraccion: "", 
                            fecha_notificacion: todayStr, doc_identidad: "", nombre_apellidos: "", 
                            fecha_nacimiento: "", agente: agente
                        };
                    } return prev;
                });
            };

            // --- L√ìGICA IA (MANUSCRITO) ---
            const callAI = async (base64Image) => {
                const PROMPT = `Analiza este BOLET√çN DE DENUNCIA DE TR√ÅFICO (MANUSCRITO). Extrae los datos con precisi√≥n.
                
                Mapeo de campos necesario:
                - "jpt_n": Extrae el N√öMERO DE EXPEDIENTE (suelen ser 12 d√≠gitos, ej: 030067720624) o N√∫mero de Bolet√≠n.
                - "matricula": La matr√≠cula del veh√≠culo.
                - "fecha_infraccion": La fecha de la denuncia (suele estar arriba a la izquierda). Formato DD/MM/AAAA.
                - "doc_identidad": DNI / NIE / Pasaporte del conductor/infractor (manuscrito).
                - "nombre_apellidos": Nombre y apellidos del conductor (manuscrito).
                - "fecha_nacimiento": Fecha de nacimiento del conductor.

                Devuelve SOLO un JSON v√°lido con estas claves.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModelName}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: PROMPT }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    const rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    const extractedData = JSON.parse(rawText);

                    setFormData(prev => {
                        const newData = { ...prev };
                        Object.keys(extractedData).forEach(key => {
                            const val = extractedData[key];
                            if (val && String(val).trim().length > 0) newData[key] = val;
                        });
                        return newData;
                    });
                } catch (error) { alert(`Error Gemini: ` + error.message); }
            };

            const processImage = async (file) => {
                if (!apiKey) { alert("¬°FALTA LA CLAVE API!"); return; }
                setProcessing({active: true, msg: `Leyendo manuscrito...`});
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.toString().replace(/^data:(.*,)?/, '');
                    try { await callAI(base64); } finally { setProcessing({active: false, msg: ''}); setDragTarget(null); }
                };
            };

            const pasteFromClipboard = async () => {
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        if (item.types.some(t => t.startsWith('image/'))) {
                            const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                            const file = new File([blob], "clipboard.png", { type: blob.type });
                            processImage(file); return;
                        }
                    }
                    alert("No hay imagen en portapapeles.");
                } catch (err) { alert("Usa Ctrl+V sobre la zona verde."); }
            };

            // HANDLERS DRAG
            const handleDragOver = (e, zone) => { e.preventDefault(); e.stopPropagation(); if (dragTarget !== zone) setDragTarget(zone); };
            const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); if (e.currentTarget.contains(e.relatedTarget)) return; setDragTarget(null); };
            const handleDrop = (e, zone) => { e.preventDefault(); e.stopPropagation(); setDragTarget(null); if (e.dataTransfer.files[0]) processImage(e.dataTransfer.files[0]); };
            const handleContextMenu = (e, zone) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, zone }); };
            const handleGlobalPaste = (e) => {
                const activeEl = document.activeElement;
                if (activeEl && activeEl.closest('.drop-zone-combined')) {
                    const items = e.clipboardData.items;
                    for (let item of items) { if (item.type.indexOf("image") === 0) { processImage(item.getAsFile()); return; } }
                }
            };

            // HANDLERS GENERALES
            const handleChange = (id, value) => { 
                let newValue = value;
                if (id.startsWith('fecha_')) newValue = formatToDate(value);
                setFormData(prev => ({ ...prev, [id]: newValue })); 
            };
            const updateLabel = (rIdx, fIdx, newText) => setTemplate(prev => { const n = [...prev]; n[rIdx].fields[fIdx].label = newText; return n; });
            const updateText = (key, val) => setTexts(prev => ({...prev, [key]: val}));
            const updateSectionTitle = (rIdx, val) => setTemplate(prev => { const n = [...prev]; n[rIdx].title = val; return n; });
            const startResize = (e, r, f, w) => { e.preventDefault(); e.stopPropagation(); setDragState({rIdx:r, fIdx:f, startX: e.clientX, startW: w}); };
            const saveSettings = (key, model) => { setApiKey(key); setGeminiModelName(model); localStorage.setItem('ai_api_key', key); localStorage.setItem('gemini_model_name', model); };
            
            const saveActa = () => { 
                const id = prompt("Nombre:", `Oficio JPT ${formData.jpt_n || Date.now()}`); 
                if(!id) return; 
                const n = {...actas, [id]: {id, data: formData, template, texts}}; 
                setActas(n); localStorage.setItem(storageKey, JSON.stringify(n)); 
            };
            const loadActa = (id) => { const a = actas[id]; if(a) { setFormData(a.data); if(a.template) setTemplate(a.template); if(a.texts) setTexts(a.texts); } };
            const handleLogoUpload = (e, key) => { const f = e.target.files[0]; if(f){ const r = new FileReader(); r.onload = (ev) => { const n = {...logos, [key]: ev.target.result}; setLogos(n); localStorage.setItem(logoKey, JSON.stringify(n)); }; r.readAsDataURL(f); } };

            // Resize Logic
            React.useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!dragState) return; e.preventDefault(); const row = document.getElementById(`row-${dragState.rIdx}`);
                    if (!row) return; const delta = ((e.clientX - dragState.startX) / row.offsetWidth) * 100;
                    setTemplate(prev => { const n = [...prev]; n[dragState.rIdx].fields[dragState.fIdx].width = Math.max(5, dragState.startW + delta); return n; });
                };
                const handleMouseUp = () => setDragState(null);
                if (dragState) { document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp); }
                return () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); };
            }, [dragState]);

            // JSX Helpers
            const renderFieldContent = (field) => {
                const centerClass = ['doc_identidad', 'nombre_apellidos', 'fecha_nacimiento'].includes(field.id) ? 'text-center' : '';
                return <input className={`input-data ${centerClass}`} value={formData[field.id] || ''} onChange={(e)=>handleChange(field.id, e.target.value)} />;
            };

            const SectionHeaderWithPaste = ({ title }) => (
                <div className="section-bar relative group" contentEditable={isEditMode} suppressContentEditableWarning onBlur={(e) => updateSectionTitle(template.findIndex(t => t.title === title), e.target.innerText)}>
                    {title}
                    <button onClick={(e) => { e.stopPropagation(); pasteFromClipboard(); }} className="paste-btn absolute right-2 top-0.5 bg-gray-600 hover:bg-gray-800 text-white text-[9px] px-2 py-0.5 rounded shadow flex items-center gap-1 opacity-60 hover:opacity-100 transition-opacity" title="Pegar imagen">üìã PEGAR BOLET√çN</button>
                </div>
            );

            return (
                <div className="flex h-screen" onPaste={handleGlobalPaste}>
                    {processing.active && (<div className="loading-overlay"><div className="spinner"></div><h3 className="text-green-600 font-bold text-lg animate-pulse">{processing.msg}</h3></div>)}
                    {contextMenu && <div className="context-menu" style={{ top: contextMenu.y, left: contextMenu.x }}><div className="context-menu-item" onClick={() => pasteFromClipboard()}><span>üìã</span> Pegar Bolet√≠n (IA)</div></div>}

                    <div className="w-64 bg-gray-900 text-white p-4 no-print flex flex-col gap-2 overflow-y-auto shrink-0 border-r border-gray-700">
                        <h2 className="text-lg font-bold text-green-400">üìÇ Oficios + IA</h2>
                        <button onClick={()=>{setFormData({}); setTemplate(initialTemplate); autoFillData()}} className="bg-green-600 p-2 rounded text-xs font-bold hover:bg-green-700 w-full mb-4">NUEVO OFICIO</button>
                        
                        <div className="mt-2 border-t border-gray-700 pt-4">
                            <button onClick={()=>setShowKeyInput(!showKeyInput)} className="text-xs text-yellow-400 hover:text-yellow-300 font-bold w-full text-left flex justify-between">‚öôÔ∏è CONFIGURAR IA <span>{showKeyInput ? '‚ñº' : '‚ñ∂'}</span></button>
                            {showKeyInput && <div className="mt-2 bg-gray-800 p-2 rounded border border-gray-600 space-y-2">
                                <input type="password" value={apiKey} onChange={(e)=>saveSettings(e.target.value, geminiModelName)} className="w-full bg-gray-900 text-white text-xs p-1 rounded border border-gray-700" placeholder="API Key..." />
                                <input type="text" value={geminiModelName} onChange={(e)=>saveSettings(apiKey, e.target.value)} className="w-full bg-gray-900 text-white text-xs p-1 rounded border border-gray-700" placeholder="gemini-1.5-pro" />
                            </div>}
                        </div>
                        <div className="flex-1 space-y-1">
                            {Object.keys(actas).map(k => (<div key={k} onClick={()=>loadActa(k)} className="p-2 bg-gray-800 hover:bg-gray-700 rounded cursor-pointer text-xs border border-gray-700 truncate">{k}</div>))}
                        </div>
                    </div>

                    <div className="flex-1 bg-gray-200 flex flex-col overflow-hidden">
                        <div className="bg-white p-2 shadow flex justify-between items-center no-print z-50 shrink-0 h-14">
                            <div className="font-bold text-gray-700 text-sm flex gap-2"><span>OFICIO JPT - IA MANUSCRITA</span><span className={`text-[9px] px-1.5 py-0.5 rounded border ${apiKey ? 'bg-green-100 text-green-700 border-green-300' : 'bg-red-100 text-red-700 border-red-300'}`}>{geminiModelName.toUpperCase()}</span></div>
                            <div className="flex gap-2">
                                <button onClick={()=>setIsEditMode(!isEditMode)} className="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm border">Editar</button>
                                <button onClick={saveActa} className="bg-blue-600 text-white px-4 py-1 rounded text-sm font-bold">Guardar</button>
                                <button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-1 rounded text-sm font-bold">Imprimir</button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto p-8 flex justify-center bg-gray-500">
                            <div className={`page-a4 ${isEditMode?'editing':''}`} tabIndex="0">
                                <div className="flex justify-between items-start mb-2 relative">
                                    <div className="w-24 h-24 relative cursor-pointer hover:bg-gray-50 group flex items-center justify-center">
                                        {!logos.left ? <span className="text-[9px] text-gray-400">judicial.png</span> : <img src={logos.left} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>handleLogoUpload(e,'left')}/>
                                    </div>
                                    <div className="flex-1 px-2 text-center">
                                        <EditableBlock html={texts.header_info} isEditMode={isEditMode} onChange={(val)=>updateText('header_info', val)} />
                                    </div>
                                    <div className="w-24 h-24 relative cursor-pointer hover:bg-gray-50 group flex items-center justify-center">
                                        {!logos.right ? <span className="text-[9px] text-gray-400">logogad.png</span> : <img src={logos.right} className="w-full h-full object-contain"/>}
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e)=>handleLogoUpload(e,'right')}/>
                                    </div>
                                </div>

                                <EditableBlock tagName="div" className="text-center font-bold text-sm uppercase bg-gray-100 py-1 border-2 border-black border-solid mb-3" html={texts.title} isEditMode={isEditMode} onChange={(val) => updateText('title', val)} />

                                <div className="form-container mb-2 flex-shrink-0">
                                    {/* ZONA UNIFICADA VERDE PARA ARRASTRAR BOLET√çN */}
                                    <div 
                                        className={`drop-zone-combined ${dragTarget === 'full_ticket' ? 'drag-active' : ''}`}
                                        onDragOver={(e) => handleDragOver(e, 'full_ticket')}
                                        onDragLeave={(e) => handleDragLeave(e)}
                                        onDrop={(e) => handleDrop(e, 'full_ticket')}
                                        onContextMenu={(e) => handleContextMenu(e, 'full_ticket')}
                                    >
                                        {template.map((row, rIdx) => {
                                            if (row.type === 'section') return <SectionHeaderWithPaste key={row.id} title={row.title} />;
                                            
                                            return (
                                                <div key={row.id} id={`row-${rIdx}`} className="acta-row">
                                                    {row.fields.map((f, fIdx) => {
                                                        const isLast = fIdx === row.fields.length - 1;
                                                        return (
                                                            <div key={f.id} className={`field-container ${isLast ? 'is-last' : ''}`} style={{width: isLast ? 'auto' : `${f.width}%`}}>
                                                                <EditableLabel text={f.label} isEditMode={isEditMode} onChange={(val)=>updateLabel(rIdx, fIdx, val)} />
                                                                {renderFieldContent(f)}
                                                                {isEditMode && !isLast && <div className="resizer" onMouseDown={(e)=>startResize(e, rIdx, fIdx, f.width)}></div>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <EditableBlock tagName="div" className="legal-text" html={texts.body1} isEditMode={isEditMode} onChange={(val) => updateText('body1', val)} />
                                <EditableBlock tagName="div" className="legal-text fill-space" html={texts.body2} isEditMode={isEditMode} onChange={(val) => updateText('body2', val)} />

                                <div className="mt-auto flex h-52 pt-4 relative flex-shrink-0 justify-center">
                                    <div className="w-1/2 flex flex-col justify-between px-4 h-full pb-4">
                                        <div className="text-[11px] font-bold text-center">
                                            <EditableBlock tagName="span" html={texts.sigAgente} isEditMode={isEditMode} onChange={(val) => updateText('sigAgente', val)} /> {formData.agente}
                                        </div>
                                        <div className="border-t border-black pt-1 text-[11px] text-center mt-auto">Fdo.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
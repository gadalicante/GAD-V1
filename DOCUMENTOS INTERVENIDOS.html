<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Documentos Intervenidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-light: #f3f4f6;
      --text-main: #1f2937;
      --card-bg: #ffffff;
      --primary-blue: #2563eb;
      --primary-blue-dark: #1e40af;
      --button-edit: #16a34a; 
      --button-edit-dark: #15803d;
      --button-delete: #dc2626; 
      --button-delete-dark: #b91c1c;
      --button-view: #f59e0b; 
      --button-view-dark: #d97706;
      --border-color: #e2e8f0;
      --color-warning: #f97316; 
      --color-warning-dark: #c2410c;
      --color-brown: #8B4513; 
      --color-purple: #800080;
      --color-teal: #0d9488;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: auto;
      padding: 2rem;
    }
    header {
      background-color: var(--primary-blue);
      color: white;
      text-align: center;
      padding: 1rem 0;
    }
    
    /* MODALES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }
    .modal-overlay.open {
      visibility: visible;
      opacity: 1;
    }
    .modal {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      width: 90%;
      max-width: 600px;
      transform: scale(0.95);
      transition: transform 0.3s ease-out;
      color: var(--text-main);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-overlay.open .modal {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #aaa;
      cursor: pointer;
    }
    .modal-body {
      padding: 1rem;
    }
    
    /* FICHA VISTA */
    .view-card { display: flex; flex-direction: column; gap: 15px; }
    .view-image-container {
        width: 100%; text-align: center; background-color: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #eee;
    }
    .view-image { max-width: 100%; max-height: 300px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .view-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; }
    .view-full-width { grid-column: span 2; }
    .view-label { font-weight: bold; color: #555; display: block; font-size: 0.8rem; }
    .view-value { color: #000; font-weight: 500; }
    .view-obs-box { background-color: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 6px; margin-top: 5px; }

    /* FORMULARIOS */
    .form-fields { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .field label { display: block; margin-bottom: 3px; font-weight: 600; font-size: 0.85rem; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; font-size: 0.85rem;
    }
    .field textarea { resize: vertical; min-height: 60px; }
    .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 5px; margin-bottom: 5px; }
    .checkbox-wrapper input[type="checkbox"] { width: auto; transform: scale(1.2); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); }
    .btn-primary { background-color: var(--primary-blue); color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-ghost { background-color: transparent; color: var(--primary-blue); border: 1px solid var(--primary-blue); padding: 8px 16px; border-radius: 5px; cursor: pointer; }
    .hidden { display: none; }

    /* ESTILOS DE TABLA */
    .btn-add { background-color: var(--primary-blue); color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 700; cursor: pointer; margin-top: 2rem; }
    .results-container { margin-top: 2rem; background-color: var(--card-bg); padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); width: 100%; overflow-x: auto; }
    .results-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    .results-table th, .results-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .results-table th { background-color: #f8fafc; font-weight: 600; }
    
    .action-buttons { display: flex; gap: 0.5rem; }
    .edit-btn, .delete-btn, .view-btn { width: 35px; height: 35px; border-radius: 4px; color: white; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
    .edit-btn { background-color: var(--button-edit); }
    .delete-btn { background-color: var(--button-delete); }
    .view-btn { background-color: var(--button-view); }
    .view-btn:hover { background-color: var(--button-view-dark); }
    
    /* ESTILOS DE DEVOLUCIÓN */
    .devuelto-row td {
        background-color: #fff1f2; 
        color: #dc2626; 
        text-decoration: line-through;
        font-weight: 600;
    }
    .devuelto-row td[data-label="Acciones"], 
    .devuelto-row td[data-label="Imagen"], 
    .devuelto-row td[data-label="Devolución"],
    .devuelto-row td[data-label="Resultado"] {
        text-decoration: none;
    }
    
    /* Input fecha dentro de la tabla */
    .date-return-input {
        border: 1px solid #fca5a5;
        background: #fff;
        color: #b91c1c;
        border-radius: 4px;
        padding: 2px 5px;
        font-size: 0.75rem;
        margin-top: 4px;
        width: 100%;
        max-width: 110px;
    }

    .devuelto-chk { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-blue); }

    /* ESTILOS ACTA SÍ/NO */
    .acta-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.8rem;
    }
    .acta-option {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
    .acta-option input { cursor: pointer; }
    
    /* Imagen con Aspa */
    .image-container { position: relative; display: inline-block; }
    .thumbnail { max-width: 80px; border-radius: 4px; border: 1px solid #ddd; }
    .cross-overlay {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 3rem; color: #dc2626; opacity: 0.9; pointer-events: none; text-shadow: 0 0 5px white; display: none;
    }
    .devuelto-row .cross-overlay { display: block; }
    .acta-link-icon { color: var(--color-teal); font-size: 1.2rem; margin-left: 5px; cursor: pointer; }
    
    /* Filtros */
    .filter-btn { padding: 8px 16px; border-radius: 5px; background-color: var(--primary-blue); color: white; margin-right: 5px; font-weight: 600; }
    .filter-btn.active { background-color: var(--button-edit); }
    #filterDevueltosBtn { background-color: var(--color-warning); }
    #filterDevueltosBtn.active { background-color: var(--button-delete); }

    /* Panel Ayuda */
    .help-panel { background-color: #fff; border-radius: 8px; padding: 1rem; margin-top: 1rem; max-width: 800px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .help-item { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .color-box { width: 18px; height: 18px; border-radius: 4px; border: 1px solid #ccc; }

    /* Responsive */
    @media (max-width: 900px) {
      .results-table thead { display: none; }
      .results-table, tbody, tr, td { display: block; width: 100%; }
      .results-table tr { margin-bottom: 1rem; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
      .results-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 10px; }
      .results-table td::before { content: attr(data-label); font-weight: 600; text-align: left; flex: 1; }
      .results-table .action-buttons { justify-content: flex-end; }
      .view-details { grid-template-columns: 1fr; }
      .view-full-width { grid-column: span 1; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col pb-16">

  <header>
    <div class="w-32 h-32 rounded-full overflow-hidden shadow-lg mx-auto bg-transparent border-2 border-white/20">
      <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-cover block">
    </div>
  </header>

  <h1 class="text-center mt-6 text-2xl font-bold px-4 text-gray-800">
    DOCUMENTOS INTERVENIDOS
  </h1>

  <main class="flex-grow flex flex-col items-center py-8 px-4">
    <button id="addNewRowBtn" class="btn-add">
        <i class="fas fa-plus mr-2"></i>Nuevo Documento Intervenido
    </button>
    
    <div class="mt-8 flex flex-wrap justify-center gap-4">
        <button id="filterAllBtn" class="filter-btn active"><i class="fas fa-list mr-2"></i>Todos</button>
        <button id="filterActiveBtn" class="filter-btn"><i class="fas fa-check-circle mr-2"></i>Activos</button>
        <button id="filterDevueltosBtn" class="filter-btn"><i class="fas fa-undo mr-2"></i>Devueltos</button>
        <button id="toggleHelpBtn" class="filter-btn bg-gray-500 hover:bg-gray-700"><i class="fas fa-info-circle mr-2"></i>Ayuda</button>
    </div>
    
    <div id="helpPanel" class="help-panel hidden">
        <h3 class="font-bold text-lg mb-3 border-b pb-2">Guía de Uso</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="help-item">
                <i class="fas fa-check-square text-blue-600 text-xl"></i>
                <p><strong>Devolución:</strong> Marca para devolver. El resultado cambiará a "Devuelto" con la fecha editable.</p>
            </div>
            <div class="help-item">
                <i class="fas fa-file-contract text-teal-600 text-xl"></i>
                <p><strong>Acta (Sí/No):</strong> Marca <strong>Sí</strong> para añadir la URL del acta. Marca <strong>No</strong> para quitarla.</p>
            </div>
            <div class="help-item">
                <div class="color-box bg-yellow-500"></div>
                <p><strong>Botón Ver:</strong> Abre la ficha detallada con imagen grande y observaciones.</p>
            </div>
        </div>
    </div>

    <div id="resultsContainer" class="results-container hidden">
      <h2 class="text-lg font-bold mb-4 text-gray-700">Registros</h2>
      <div class="overflow-x-auto">
        <table class="results-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>País</th>
              <th>Doc.</th>
              <th>Atestado</th>
              <th class="text-center">Acta</th>
              <th class="text-center">Devolución</th>
              <th>Resultado</th>
              <th>Imagen</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            </tbody>
        </table>
      </div>
    </div>
    
    <div class="mt-8 flex justify-center">
        <button onclick="window.location.href='index.html'" class="px-6 py-3 bg-yellow-400 text-black font-bold rounded-lg shadow-md hover:bg-yellow-300 transition">
            MENÚ PRINCIPAL
        </button>
    </div>
  </main>

  <footer class="mt-auto text-center py-6 bg-gray-200 text-sm">
    <p class="font-bold">GRUPO DE ANÁLISIS DOCUMENTAL</p>
    <p>POLICÍA LOCAL DE ALICANTE</p>
    <p>&copy; GAD - Todos los derechos reservados</p>
  </footer>

  <div id="documentModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <strong id="modalTitle">Nuevo Documento Intervenido</strong>
        <button id="closeModalBtn" class="close-btn">&times;</button>
      </div>
      <form id="documentForm">
        <div class="modal-body">
          <input type="hidden" id="recordKey">
          <div class="form-fields">
            
            <div class="field">
              <label for="fechaSuceso">Fecha del Suceso</label>
              <input id="fechaSuceso" name="fechaSuceso" type="date" required />
            </div>

            <div class="field">
              <label for="pais">País</label>
              <input id="pais" name="pais" type="text" placeholder="Ej: España" required list="paisesList" />
              <datalist id="paisesList"></datalist>
            </div>

            <div class="field">
              <label for="tipoDocumento">Tipo de Documento</label>
              <select id="tipoDocumento" name="tipoDocumento" required>
                <option value="PNC">PNC</option>
                <option value="PIC">PIC</option>
                <option value="TIE">TIE</option>
                <option value="CI">CI</option>
                <option value="PCIRC">PCIRC</option>
                <option value="ITV">ITV</option>
                <option value="SOA">SOA</option>
                <option value="PASAPORTE">PASAPORTE</option>
                <option value="OTRO">OTRO</option>
              </select>
            </div>

            <div class="field">
              <label for="atestadoNumero">Número de Atestado</label>
              <input id="atestadoNumero" name="atestadoNumero" type="text" placeholder="Ej: 1234/23" required />
            </div>

            <div class="field">
                <label for="resultado">Resultado / Estado</label>
                <select id="resultado" name="resultado" required>
                  <option value="Se desconoce">Se desconoce</option>
                  <option value="Intervenido">Intervenido</option>
                  <option value="Peritado">Peritado</option>
                  <option value="En Trámite">En Trámite</option>
                  <option value="Entregado">Entregado</option>
                </select>
            </div>

            <div class="field" style="border-top: 1px solid #eee; padding-top: 10px; margin-top:5px;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="tieneActa">
                    <label for="tieneActa" style="margin:0; cursor:pointer;">¿Existe ACTA?</label>
                </div>
                <div id="actaUrlContainer" class="hidden">
                    <label for="actaUrl" class="text-xs text-teal-600">Enlace al Documento del Acta (URL)</label>
                    <input id="actaUrl" name="actaUrl" type="text" placeholder="Pega aquí la URL del Acta" />
                </div>
            </div>

            <div class="field" style="background-color: #eff6ff; padding: 10px; border-radius: 5px; border: 1px solid #bfdbfe; margin-bottom: 10px;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="esJudicializado">
                    <label for="esJudicializado" style="margin:0; cursor:pointer; color: #1e40af; font-weight: bold;">
                        <i class="fas fa-gavel mr-1"></i> Añadir también a JUDICIALIZADOS
                    </label>
                </div>
            </div>

            <div class="field">
                <label for="observaciones">Observaciones</label>
                <textarea id="observaciones" name="observaciones" placeholder="Detalles adicionales..."></textarea>
            </div>

            <div class="field">
              <label for="documentoUrl">Imagen del Documento (URL)</label>
              <input id="documentoUrl" name="documentoUrl" type="text" placeholder="Pega aquí la URL de la imagen/doc" />
            </div>

          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn-primary"><i class="fas fa-save mr-2"></i>Guardar</button>
          <button type="button" id="cancelModalBtn" class="btn-ghost"><i class="fas fa-times mr-2"></i>Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="viewModal" class="modal-overlay">
      <div class="modal">
          <div class="modal-header">
              <strong>Ficha del Documento</strong>
              <button id="closeViewModalBtn" class="close-btn">&times;</button>
          </div>
          <div class="modal-body">
              <div class="view-card">
                  <div class="view-image-container">
                      <div id="viewImageContent">
                          <span class="text-gray-400">Sin imagen disponible</span>
                      </div>
                  </div>
                  <div class="view-details">
                      <div>
                          <span class="view-label">Fecha del Suceso:</span>
                          <span id="viewFecha" class="view-value"></span>
                      </div>
                      <div>
                          <span class="view-label">País:</span>
                          <span id="viewPais" class="view-value"></span>
                      </div>
                      <div>
                          <span class="view-label">Tipo Documento:</span>
                          <span id="viewTipo" class="view-value"></span>
                      </div>
                      <div>
                          <span class="view-label">Nº Atestado:</span>
                          <span id="viewAtestado" class="view-value"></span>
                      </div>
                      <div>
                          <span class="view-label">Resultado:</span>
                          <span id="viewResultado" class="view-value"></span>
                      </div>
                       <div>
                          <span class="view-label">Estado:</span>
                          <span id="viewEstado" class="view-value"></span>
                      </div>
                      <div class="view-full-width">
                           <span class="view-label">Enlace Acta:</span>
                           <span id="viewActaLink" class="text-sm">No disponible</span>
                      </div>
                      <div class="view-full-width view-obs-box">
                          <span class="view-label">Observaciones:</span>
                          <p id="viewObservaciones" class="view-value" style="white-space: pre-wrap; margin-top:5px;"></p>
                      </div>
                  </div>
              </div>
          </div>
          <div class="modal-actions">
              <button id="closeViewBtn" class="btn-primary">Cerrar</button>
          </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
    
    // CONFIGURACIÓN DE FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyA6EDUJ2dG50DphB-dF6GLi3P2IlW8lDl4",
      authDomain: "gad-alicante-v3.firebaseapp.com",
      databaseURL: "https://gad-alicante-v3-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gad-alicante-v3",
      storageBucket: "gad-alicante-v3.firebasestorage.app",
      messagingSenderId: "906986258369",
      appId: "1:906986258369:web:21a7ea29a33b5f395e3940"
    };

      try {
          firebase.initializeApp(firebaseConfig);
      } catch (e) { console.log("Firebase ya iniciado"); }
      
      const auth = firebase.auth();
    const db = firebase.database();
      const documentsRef = db.ref('documentos_intervenidos');
      const savedPaisesRef = db.ref('paises');

      // Referencias DOM
      const documentModal = document.getElementById('documentModal');
      const viewModal = document.getElementById('viewModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelModalBtn = document.getElementById('cancelModalBtn');
      const closeViewModalBtn = document.getElementById('closeViewModalBtn');
      const closeViewBtn = document.getElementById('closeViewBtn');
      const addNewRowBtn = document.getElementById('addNewRowBtn');
      const documentForm = document.getElementById('documentForm');
      const modalTitle = document.getElementById('modalTitle');
      const recordKeyInput = document.getElementById('recordKey');
      const resultsTableBody = document.getElementById('resultsTableBody');
      const resultsContainer = document.getElementById('resultsContainer');
      const paisesList = document.getElementById('paisesList');
      
      const filterAllBtn = document.getElementById('filterAllBtn');
      const filterActiveBtn = document.getElementById('filterActiveBtn');
      const filterDevueltosBtn = document.getElementById('filterDevueltosBtn');
      const toggleHelpBtn = document.getElementById('toggleHelpBtn');
      const helpPanel = document.getElementById('helpPanel');
      let currentFilter = 'all';

      // Lógica checkbox Acta en Modal
      const tieneActaCheck = document.getElementById('tieneActa');
      const actaUrlContainer = document.getElementById('actaUrlContainer');

      tieneActaCheck.addEventListener('change', () => {
          if(tieneActaCheck.checked) {
              actaUrlContainer.classList.remove('hidden');
          } else {
              actaUrlContainer.classList.add('hidden');
              document.getElementById('actaUrl').value = ''; 
          }
      });

      let savedPaises = [];
      savedPaisesRef.on('value', (snapshot) => {
          savedPaises = snapshot.val() || [];
          paisesList.innerHTML = savedPaises.map(pais => `<option value="${pais}"></option>`).join('');
      });

      // RENDERIZADO DE TABLA
      const renderTable = (snapshot) => {
        resultsTableBody.innerHTML = '';
        let data = [];
        snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            item.key = childSnapshot.key;
            data.push(item);
        });
        
        // Filtros
        data = data.filter(item => {
            if (currentFilter === 'active') return !item.devolucion;
            if (currentFilter === 'devueltos') return item.devolucion === true;
            return true; 
        });

        if (data.length > 0) {
            resultsContainer.classList.remove('hidden');
            
            data.sort((a, b) => {
                const dateA = new Date(a.fechaSuceso).getTime(); 
                const dateB = new Date(b.fechaSuceso).getTime();
                return isNaN(dateB) ? -1 : dateB - dateA; 
            });

            data.forEach((item) => {
                const row = document.createElement('tr');
                row.dataset.key = item.key;
                
                // Si está marcado como devolución
                if (item.devolucion) {
                    row.classList.add('devuelto-row');
                }
                
                // Imagen con aspa superpuesta
                let imageHtml = '<span class="text-gray-400 text-xs">Sin img</span>';
                if (item.documentoUrl) {
                    let imgTag = '';
                    if (item.documentoUrl.includes('1drv.ms') || /\.(jpg|png|jpeg)$/i.test(item.documentoUrl)) {
                         imgTag = `<img src="${item.documentoUrl}" class="thumbnail" alt="Doc">`;
                    } else {
                         imgTag = `<span class="text-blue-600 underline text-xs cursor-pointer">Ver Doc</span>`;
                    }
                    
                    imageHtml = `
                        <div class="image-container">
                            <a href="${item.documentoUrl}" target="_blank">${imgTag}</a>
                            <i class="fas fa-times-circle cross-overlay"></i>
                        </div>
                    `;
                }

                // Acta con Checkboxes Sí/No
                const hasActa = item.tieneActa === true;
                const hasUrl = item.actaUrl && item.actaUrl.length > 0;
                
                let actaCellContent = `
                    <div class="acta-cell">
                        <div class="acta-option">
                            <input type="radio" name="acta_grp_${item.key}" class="acta-chk-yes" ${hasActa ? 'checked' : ''}>
                            <label>Sí</label>
                            ${(hasActa && hasUrl) ? `<a href="${item.actaUrl}" target="_blank" title="Ver Acta" class="acta-link-icon"><i class="fas fa-file-contract"></i></a>` : ''}
                        </div>
                        <div class="acta-option">
                            <input type="radio" name="acta_grp_${item.key}" class="acta-chk-no" ${!hasActa ? 'checked' : ''}>
                            <label>No</label>
                        </div>
                    </div>
                `;

                // Checkbox Devolución
                const isDevuelto = item.devolucion === true;
                const devolucionHtml = `
                    <div class="flex justify-center">
                        <input type="checkbox" class="devuelto-chk" ${isDevuelto ? 'checked' : ''} title="Marcar como devuelto">
                    </div>
                `;

                // Resultado: Si es devuelto, mostrar "DEVUELTO" y fecha editable
                let resultadoHtml;
                if(isDevuelto) {
                    // Si no hay fecha guardada, poner hoy
                    const fechaValue = item.fechaDevolucion || new Date().toISOString().split('T')[0];
                    resultadoHtml = `
                        <div>
                            <span class="font-bold text-red-600">DEVUELTO</span><br>
                            <input type="date" class="date-return-input" value="${fechaValue}">
                        </div>
                    `;
                } else {
                    resultadoHtml = item.resultado;
                }

                row.innerHTML = `
                    <td data-label="Fecha">${item.fechaSuceso}</td>
                    <td data-label="País">${item.pais}</td>
                    <td data-label="Doc.">${item.tipoDocumento}</td>
                    <td data-label="Atestado">${item.atestadoNumero}</td>
                    <td data-label="Acta">${actaCellContent}</td>
                    <td data-label="Devolución">${devolucionHtml}</td>
                    <td data-label="Resultado">${resultadoHtml}</td>
                    <td data-label="Imagen">${imageHtml}</td>
                    <td data-label="Acciones">
                      <div class="action-buttons">
                        <button class="edit-btn" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                        <button class="view-btn" title="Ver Ficha Completa"><i class="fas fa-eye"></i></button>
                        <button class="delete-btn" title="Eliminar definitivamente"><i class="fas fa-trash"></i></button>
                      </div>
                    </td>
                `;
                resultsTableBody.appendChild(row);
            });
        } else {
            resultsContainer.classList.add('hidden');
        }
      };

      documentsRef.on('value', renderTable, (error) => {
           console.error("Error lectura:", error);
      });

      addNewRowBtn.addEventListener('click', () => {
        documentForm.reset();
        recordKeyInput.value = '';
        actaUrlContainer.classList.add('hidden');
        modalTitle.textContent = 'Nuevo Documento Intervenido';
        documentModal.classList.add('open');
      });

      // GUARDAR DATOS
      documentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const atestadoNumero = document.getElementById('atestadoNumero').value.trim();
        const safeKey = atestadoNumero.trim().replace(/[\/.\s]/g, '-').toUpperCase();
        const existingKey = recordKeyInput.value;
        
        const dataIntervenido = {
          fechaSuceso: document.getElementById('fechaSuceso').value,
          pais: document.getElementById('pais').value,
          tipoDocumento: document.getElementById('tipoDocumento').value,
          atestadoNumero: atestadoNumero,
          resultado: document.getElementById('resultado').value,
          documentoUrl: document.getElementById('documentoUrl').value || null,
          observaciones: document.getElementById('observaciones').value || '',
          tieneActa: document.getElementById('tieneActa').checked,
          actaUrl: document.getElementById('actaUrl').value || null,
        };

        const quiereJudicializar = document.getElementById('esJudicializado').checked;

        try {
            const updates = {};
            
            // 1. Intervenidos
            if (existingKey) {
                const snapshot = await documentsRef.child(existingKey).once('value');
                const prevData = snapshot.val();
                dataIntervenido.devolucion = prevData.devolucion || false; 
                if(prevData.fechaDevolucion) dataIntervenido.fechaDevolucion = prevData.fechaDevolucion;

                if (existingKey !== safeKey) {
                    await documentsRef.child(existingKey).remove();
                    updates['documentos_intervenidos/' + safeKey] = dataIntervenido;
                } else {
                    updates['documentos_intervenidos/' + safeKey] = dataIntervenido;
                }
            } else {
                dataIntervenido.devolucion = false;
                updates['documentos_intervenidos/' + safeKey] = dataIntervenido;
            }

            // 2. Judicializados (Corrección)
            if (quiereJudicializar) {
                // Creamos el objeto exactamente como lo espera judicializados
                const dataJudicial = {
                    fechaSuceso: dataIntervenido.fechaSuceso,
                    pais: dataIntervenido.pais,
                    tipoDocumento: dataIntervenido.tipoDocumento,
                    atestadoNumero: dataIntervenido.atestadoNumero,
                    documentoUrl: dataIntervenido.documentoUrl,
                    juicioRapido: "No", // Valor por defecto
                    juzgado: "Se desconoce", // Valor por defecto
                    resultado: "En Trámite", // Valor por defecto
                    sentenciaUrl: "",
                    archived: false
                };
                
                // Usamos la referencia global db para actualizar otra ruta
                updates['judicializados/' + safeKey] = dataJudicial;
            }

            await db.ref().update(updates);

            const pais = dataIntervenido.pais.trim();
            if (pais && !savedPaises.includes(pais)) {
              savedPaises.push(pais);
              savedPaisesRef.set(savedPaises);
            }

            documentModal.classList.remove('open');
            documentForm.reset();
            
            let msg = "Guardado correctamente.";
            if(quiereJudicializar) msg += " Copia enviada a Judicializados.";
            // alert(msg);

        } catch (error) {
            alert("Error al guardar: " + error.message);
        }
      });

      // MANEJO DE CLICS EN TABLA
      resultsTableBody.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;
        const key = row.dataset.key;

        // 1. CAMBIO DE FECHA EN DEVOLUCIÓN
        if (target.classList.contains('date-return-input')) {
            // Evitar que el clic en el input dispare otras acciones
            e.stopPropagation();
            return;
        }

        // 2. Toggle Devolución
        if (target.classList.contains('devuelto-chk')) {
            const newState = target.checked;
            const updateData = { devolucion: newState };
            
            // Si se activa, poner fecha de hoy por defecto si no existe
            if(newState) {
                updateData.fechaDevolucion = new Date().toISOString().split('T')[0];
            } else {
                updateData.fechaDevolucion = null; // Limpiar fecha si se desmarca
            }
            
            await documentsRef.child(key).update(updateData);
            return;
        }

        // 3. ACTA (Sí / No)
        if (target.classList.contains('acta-chk-yes')) {
             e.preventDefault(); // Prevenir check visual inmediato
             // Abrir modal igual que editar
             openEditModal(key, true);
        } else if (target.classList.contains('acta-chk-no')) {
             // Marcar como NO tiene acta y borrar URL
             await documentsRef.child(key).update({
                 tieneActa: false,
                 actaUrl: null
             });
        }

        // 4. Editar Normal
        else if (target.closest('.edit-btn')) {
             openEditModal(key, false);
        }

        // 5. Botón VER
        else if (target.closest('.view-btn')) {
            const snapshot = await documentsRef.child(key).once('value');
            const item = snapshot.val();
            
            document.getElementById('viewFecha').textContent = item.fechaSuceso;
            document.getElementById('viewPais').textContent = item.pais;
            document.getElementById('viewTipo').textContent = item.tipoDocumento;
            document.getElementById('viewAtestado').textContent = item.atestadoNumero;
            document.getElementById('viewResultado').textContent = item.resultado;
            
            const estadoSpan = document.getElementById('viewEstado');
            if (item.devolucion) {
                const fDev = item.fechaDevolucion ? item.fechaDevolucion.split('-').reverse().join('/') : '';
                estadoSpan.textContent = `DEVUELTO (${fDev})`;
                estadoSpan.style.color = '#dc2626';
            } else {
                estadoSpan.textContent = "ACTIVO / EN DEPÓSITO";
                estadoSpan.style.color = '#16a34a';
            }
            estadoSpan.style.fontWeight = 'bold';

            document.getElementById('viewObservaciones').textContent = item.observaciones || 'Sin observaciones.';
            
            const imgContainer = document.getElementById('viewImageContent');
            if (item.documentoUrl) {
                if(item.documentoUrl.includes('1drv.ms') || /\.(jpg|png|jpeg)$/i.test(item.documentoUrl)){
                    imgContainer.innerHTML = `<a href="${item.documentoUrl}" target="_blank"><img src="${item.documentoUrl}" class="view-image" alt="Documento"></a>`;
                } else {
                    imgContainer.innerHTML = `<a href="${item.documentoUrl}" target="_blank" class="text-blue-600 underline font-bold text-lg">Ver Documento Externo</a>`;
                }
            } else {
                imgContainer.innerHTML = '<span class="text-gray-400">Sin imagen disponible</span>';
            }

            const linkContainer = document.getElementById('viewActaLink');
            if (item.tieneActa && item.actaUrl) {
                linkContainer.innerHTML = `<a href="${item.actaUrl}" target="_blank" class="text-teal-600 underline font-bold">Ver ACTA</a>`;
            } else {
                linkContainer.textContent = "No hay acta asociada.";
            }

            viewModal.classList.add('open');
        }

        // 6. Eliminar
        else if (target.closest('.delete-btn')) {
          if (confirm('¿Eliminar definitivamente este registro?')) {
            await documentsRef.child(key).remove();
          }
        }
      });

      // Listener para el cambio de fecha (Evento Change)
      resultsTableBody.addEventListener('change', async (e) => {
          if (e.target.classList.contains('date-return-input')) {
              const row = e.target.closest('tr');
              const key = row.dataset.key;
              const newDate = e.target.value;
              await documentsRef.child(key).update({ fechaDevolucion: newDate });
          }
      });

      // Función auxiliar para abrir modal
      async function openEditModal(key, forceActa) {
            const snapshot = await documentsRef.child(key).once('value');
            const item = snapshot.val();
            
            document.getElementById('fechaSuceso').value = item.fechaSuceso;
            document.getElementById('pais').value = item.pais;
            document.getElementById('tipoDocumento').value = item.tipoDocumento;
            document.getElementById('atestadoNumero').value = item.atestadoNumero;
            document.getElementById('resultado').value = item.resultado;
            document.getElementById('observaciones').value = item.observaciones || '';
            document.getElementById('documentoUrl').value = item.documentoUrl || '';
            
            let showActaField = item.tieneActa;
            if (forceActa) {
                showActaField = true;
                document.getElementById('tieneActa').checked = true;
                actaUrlContainer.classList.remove('hidden');
            } else {
                document.getElementById('tieneActa').checked = item.tieneActa || false;
                if(item.tieneActa) actaUrlContainer.classList.remove('hidden');
                else actaUrlContainer.classList.add('hidden');
            }
            
            document.getElementById('actaUrl').value = item.actaUrl || '';
            
            recordKeyInput.value = key;
            modalTitle.textContent = 'Editar Documento';
            documentModal.classList.add('open');
            
            if (forceActa) {
                document.getElementById('actaUrl').focus();
            }
      }

      const closeModal = () => { documentModal.classList.remove('open'); };
      const closeView = () => { viewModal.classList.remove('open'); };
      
      closeModalBtn.addEventListener('click', closeModal);
      cancelModalBtn.addEventListener('click', closeModal);
      documentModal.addEventListener('click', (e) => { if (e.target === documentModal) closeModal(); });

      closeViewModalBtn.addEventListener('click', closeView);
      closeViewBtn.addEventListener('click', closeView);
      viewModal.addEventListener('click', (e) => { if (e.target === viewModal) closeView(); });

      const setFilter = (filter) => {
          currentFilter = filter;
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          if (filter === 'all') filterAllBtn.classList.add('active');
          if (filter === 'active') filterActiveBtn.classList.add('active');
          if (filter === 'devueltos') filterDevueltosBtn.classList.add('active');
          documentsRef.once('value', renderTable);
      };
      
      filterAllBtn.addEventListener('click', () => setFilter('all'));
      filterActiveBtn.addEventListener('click', () => setFilter('active'));
      filterDevueltosBtn.addEventListener('click', () => setFilter('devueltos'));

      toggleHelpBtn.addEventListener('click', () => {
          helpPanel.classList.toggle('hidden');
      });

    });
  </script>
</body>
</html>
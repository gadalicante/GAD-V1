<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de denuncias ORA - GAD</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        .title-panel-blue {
            background-color: #3b82f6;
            display: grid; 
            grid-template-columns: auto 1fr auto; 
            align-items: center;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }
        .title-panel-blue h1 {
            color: white;
            margin: 0;
            padding: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            text-align: center;
        }
        .title-panel-blue .header-logo-container {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }
        .title-panel-blue .header-logo-container:first-child { justify-self: start; }
        .title-panel-blue .header-logo-container:last-child { justify-self: end; }
        .title-panel-blue .header-logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        footer {
            background-color: #e0e0e0;
            text-align: center;
            padding: 20px;
            width: 100%;
            margin-top: auto;
            box-sizing: border-box;
        }
        footer p { margin: 5px 0; font-size: 1em; color: #333; font-weight: bold; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex: 1;
            padding: 15px;
            display: flex;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }
        .app-container {
            max-width: 1300px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .panel {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        h1, h2, h3 {
            color: #2c3e50;
            padding-bottom: 10px;
            margin-top: 0;
            font-weight: 700;
        }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.2em; }

        button {
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            margin-right: 8px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: white;
            font-size: 0.9em;
        }
        button i { font-size: 1em; }
        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-primary:hover { box-shadow: 0 4px 10px rgba(41, 128, 185, 0.4); }
        .btn-delete { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .btn-delete:hover { box-shadow: 0 4px 10px rgba(192, 57, 43, 0.4); }
        .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .btn-success:hover { box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-warning:hover { box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); }
        .btn-info { background: linear-gradient(135deg, #5bc0de, #31b0d5); }
        .btn-info:hover { box-shadow: 0 4px 10px rgba(49, 176, 213, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ff8c00, #dc143c); } 
        .btn-danger:hover { box-shadow: 0 4px 10px rgba(220, 20, 60, 0.4); }

        /* Icono papelera roja sin borde */
        .btn-icon-delete {
            background-color: transparent;
            color: #ef4444; 
            padding: 5px;
            margin: 0;
            border: none; 
            font-size: 1.3em; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-icon-delete:hover {
            transform: scale(1.1);
            background-color: transparent;
            box-shadow: none;
        }

        input[type="text"], input[type="number"], input[type="url"], input[type="date"], select {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px 12px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
            font-size: 0.95em;
            width: 100%;
            box-sizing: border-box;
        }

        #drop-zone {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: #555;
            background-color: #f8f9fa;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
        }
        #drop-zone.dragover {
            background-color: #e0f2f7;
            border-color: #0288d1;
        }
        #drop-zone i {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: end;
            flex-grow: 1;
            max-width: 500px;
        }
        .search-controls label {
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
        }

        .results-container {
            overflow-x: auto;
            padding-bottom: 10px;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fdfdfd;
        }
        .results-header, .doc-row {
            display: grid;
            gap: 15px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            min-width: 600px;
            transition: background-color 0.3s ease;
        }
        .results-header {
            font-weight: bold;
            background: #e9f2f7;
            border-bottom: 2px solid #3498db;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #2c3e50;
        }
        .doc-row:nth-child(even) { background: #f9f9f9; }
        .doc-row:hover { background: #eef4f9; }
        .doc-row div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: center;
        }

        /* --- ESTILOS DE COLOR DE FILA --- */
        .doc-row.highlight-yellow { background-color: #fffde7; }
        .doc-row.highlight-yellow:hover { background-color: #fff9c4; }
        
        .doc-row.highlight-green { background-color: #e8f5e9; }
        .doc-row.highlight-green:hover { background-color: #c8e6c9; }
        
        .doc-row.highlight-blue { background-color: #e3f2fd; }
        .doc-row.highlight-blue:hover { background-color: #bbdefb; }
        
        .doc-row.highlight-red { background-color: #ffcdd2; }
        .doc-row.highlight-red:hover { background-color: #ef9a9a; }
        
        .revisado-cell { text-align: center; align-self: center; }
        .revisado-cell.date-set {
            font-weight: bold;
            color: #0d47a1;
            cursor: pointer;
            font-size: 0.95em;
        }
        
        /* Estilos Select Estado */
        .estado-select {
            width: 100%;
            padding: 5px;
            font-size: 0.9em;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        .estado-select:focus { border-color: #3498db; outline: none; }

        /* Estilos Colores Matrícula */
        .doc-row .cell-matricula.group-color-1 { color: #D32F2F; font-weight: bold; }
        .doc-row .cell-matricula.group-color-2 { color: #1976D2; font-weight: bold; }
        .doc-row .cell-matricula.group-color-3 { color: #388E3C; font-weight: bold; }
        .doc-row .cell-matricula.group-color-4 { color: #F57C00; font-weight: bold; }
        .doc-row .cell-matricula.group-color-5 { color: #7B1FA2; font-weight: bold; }
        .doc-row .cell-matricula.group-color-6 { color: #5D4037; font-weight: bold; }
        
        #status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
            font-weight: bold;
        }
        #status-message.success { background-color: #e8f5e9; color: #27ae60; border: 1px solid #c8e6c9; }
        #status-message.error { background-color: #fef2f2; color: #c0392b; border: 1px solid #f44336; }
        #status-message.loading { background-color: #e0f2f7; color: #0288d1; border: 1px solid #b3e5fc; }
        #status-message.info { background-color: #e0f2f7; color: #0288d1; border: 1px solid #b3e5fc; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modern-alert {
            text-align: center;
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px;
            background-color: #f0f4f7;
            border: 1px solid #dcdcdc;
            color: #555;
            font-size: 0.9em; 
        }
        .modern-alert h4 { font-size: 1.1em; margin-top: 5px; margin-bottom: 5px; }
        .modern-alert p { margin-bottom: 0; }
        .modern-alert-error { background-color: #fef2f2; border-color: #f44336; }
         
        /* --- CSS Leyenda --- */
        #legend-panel {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }
        #legend-panel p { margin: 2px 0; }
        .legend-blue { color: #0d47a1; font-weight: bold; }
        .legend-yellow { color: #f57f17; font-weight: bold; }
        .legend-green { color: #1b5e20; font-weight: bold; }
        .legend-red { color: #c62828; font-weight: bold; }
        
        /* --- CSS Modal --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }
        .modal-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            width: 90%;
            max-width: 450px;
            overflow: hidden;
        }
        .modal-header {
            background: #f1f1f1;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .modal-header h2 { margin: 0; color: #333; }
        .modal-content {
            padding: 20px;
            display: grid;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-content label {
            font-weight: bold;
            font-size: 0.9em;
            color: #555;
            margin-bottom: -10px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f9f9f9;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
        }

         @media (max-width: 767px) {
             .title-panel-blue {
                grid-template-columns: auto 1fr auto;
                padding: 15px;
             }
             .title-panel-blue .header-logo-container { width: 60px; height: 60px; }
             .title-panel-blue h1 { font-size: 1.4em; gap: 5px; }
             .controls-container { flex-direction: column; align-items: stretch; }
             .search-controls { grid-template-columns: 1fr; max-width: 100%; }
             .filter-controls { justify-content: center; }
         }
         @media (max-width: 480px) {
             .title-panel-blue { padding: 15px; }
             .title-panel-blue .header-logo-container { width: 50px; height: 50px; }
             .title-panel-blue h1 { font-size: 1.2em; }
             .panel { padding: 15px; }
             button { font-size: 0.85em; padding: 8px 12px; }
             h2 { font-size: 1.3em; }
             h3 { font-size: 1.1em; }
         }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>
    <main>
        <div class="app-container">

            <div class="title-panel-blue">
                <div class="header-logo-container">
                    <img src="logoora.png" alt="Logo ORA">
                </div>
                <h1><i class="fas fa-file-invoice-dollar"></i> Listado de denuncias ORA</h1>
                <div class="header-logo-container">
                    <img src="logogad.png" alt="Logo GAD">
                </div>
            </div>
            <div class="panel">
                <h2><i class="fas fa-upload"></i> Cargar Archivo Excel</h2>
                <p>Arrastra y suelta un archivo Excel (.xls, .xlsx) en la zona o haz clic para seleccionarlo. <strong>Esto AÑADIRÁ los datos del archivo a los ya existentes.</strong></p>
                
                <div id="drop-zone">
                    <i class="fas fa-file-excel"></i>
                    <p>Arrastra tu archivo aquí o haz clic para seleccionar</p>
                </div>
                <input type="file" id="file-input" accept=".xls, .xlsx" style="display: none;">
                
                <div id="status-message"></div>

                <h2 style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;"><i class="fas fa-search"></i> Buscar Denuncias</h2>
                
                <div class="controls-container">
                    <div class="search-controls">
                        <div>
                            <label for="search-matricula">MATRÍCULA A BUSCAR (Exacta):</label>
                            <input type="text" id="search-matricula" placeholder="Introduce la matrícula...">
                        </div>
                        <div class="align-bottom">
                            <button id="search-btn" class="btn-success" style="width: 100%;"><i class="fas fa-search"></i> Buscar</button>
                        </div>
                    </div>
                    
                    <div class="filter-controls">
                        <button id="sort-matricula-btn" class="btn-primary"><i class="fas fa-sort-alpha-down"></i> Matrícula (A-Z)</button>
                        <button id="sort-fecha-asc-btn" class="btn-info"><i class="fas fa-calendar-alt"></i> Fecha (Antigua)</button>
                        <button id="sort-fecha-desc-btn" class="btn-info"><i class="fas fa-calendar-alt"></i> Fecha (Reciente)</button>
                        <button id="show-all-btn" class="btn-warning"><i class="fas fa-list"></i> Mostrar Todos</button>
                        <button id="find-duplicates-btn" class="btn-danger"><i class="fas fa-copy"></i> Reincidentes</button>
                        <button id="crear-alerta-btn" class="btn-info"><i class="fas fa-exclamation-triangle"></i> Crear Alerta Eurocop</button>
                        <button id="delete-all-btn" class="btn-delete"><i class="fas fa-trash-alt"></i> Borrar Todo</button>
                    </div>
                    </div>
                
                <h3 style="margin-top: 30px;">Resultados <span id="results-count">(0)</span></h3>
                
                <div id="legend-panel">
                  <p>Activa la casilla <span class="legend-blue">Revisado</span> si ya se ha hecho comprobación.</p>
                  <p>ESTADO EXPEDIENTE (Desplegable):</p>
                  <p>- Selecciona <span class="legend-yellow">Sin datos en Eurocop</span> (Marca automáticamente Revisado).</p>
                  <p>- Selecciona <span class="legend-red">Alerta grabada en Eurocop</span> para vehículos reincidentes con alerta.</p>
                  <p>- Selecciona <span class="legend-green">Notificado a sanciones</span> cuando hayas enviado los datos (abre formulario).</p>
                </div>
                <div class="results-container">
                    <div id="results-header" class="results-header" style="display: none;">
                        </div>
                    <div id="search-results">
                        <div class="modern-alert">
                            <i class="fas fa-list-alt fa-2x"></i>
                            <h4 style="color: #3498db; margin-top: 10px;">Sin Datos</h4>
                            <p>Carga un archivo Excel o pulsa "Mostrar Todos" para ver las denuncias.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <div id="notification-modal-overlay" class="modal-overlay"></div>
    <div id="notification-modal" class="modal-container">
        <div class="modal-header">
            <h2><i class="fas fa-paper-plane"></i> Notificar Datos Eurocop</h2>
        </div>
        <div class="modal-content">
            <label for="modal-nombre">Nombre:</label>
            <input type="text" id="modal-nombre" placeholder="Nombre completo...">
            
            <label for="modal-doi">DOI:</label>
            <input type="text" id="modal-doi" placeholder="Nº de identificación NIE, DNI, otros">
            
            <label for="modal-direccion">Dirección:</label>
            <input type="text" id="modal-direccion" placeholder="Dirección...">
            
            <label for="modal-localidad">Localidad:</label>
            <input type="text" id="modal-localidad" placeholder="Localidad...">

            <label for="modal-fecha-nacimiento">Fecha de Nacimiento:</label>
            <input type="date" id="modal-fecha-nacimiento">
            
            <label for="modal-telefono">Teléfono:</label>
            <input type="text" id="modal-telefono" placeholder="Teléfono...">
        </div>
        <div class="modal-buttons">
            <button id="modal-cancel-btn" class="btn-warning"><i class="fas fa-times"></i> Cancelar</button>
            <button id="modal-accept-btn" class="btn-success"><i class="fas fa-copy"></i> Aceptar y Copiar</button>
        </div>
    </div>
    <footer>
        <p>GRUPO DE ANÁLISIS DOCUMENTAL</p>
        <p>POLICÍA LOCAL DE ALICANTE</p>
        <p>© GAD - Todos los derechos reservados</p>
    </footer>


    <script>
        const firebaseConfig = {
apiKey: "AIzaSyCY8V_P7m8lZUvGbMVlGaa-GVhbmyikmag",
  authDomain: "gad-alicante-v4.firebaseapp.com",
  databaseURL: "https://gad-alicante-v4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gad-alicante-v4",
  storageBucket: "gad-alicante-v4.firebasestorage.app",
  messagingSenderId: "119727545224",
  appId: "1:119727545224:web:36880c50d196c456cdb83d"
};

        let app = null;
        let database = null;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("✅ Firebase inicializado correctamente.");
        } catch (error) {
            console.error("❌ ERROR CRÍTICO DE FIREBASE:", error.message);
            alert("❌ Error al inicializar Firebase. Revisa tus credenciales.");
        }

        const DENUNCIAS_ORA_REF = 'denuncias_ORA';
        
        const HEADER_DISPLAY_NAMES = {
            'matricula': 'MATRÍCULA',
            'fecha_de_creacion': 'FECHA DENUNCIA', 
            'marca': 'MARCA',
            'modelo': 'MODELO',
            'revisado': 'REVISADO', 
            'estado_expediente': 'ESTADO EXPEDIENTE',
            'acciones': 'BORRAR' 
        };
        
        const CANONICAL_KEYS_LIST = Object.keys(HEADER_DISPLAY_NAMES);
        
        let allDenuncias = []; 

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const statusMessage = document.getElementById('status-message');
        
        const searchInput = document.getElementById('search-matricula');
        const searchBtn = document.getElementById('search-btn');
        
        const sortMatriculaBtn = document.getElementById('sort-matricula-btn');
        const sortFechaAscBtn = document.getElementById('sort-fecha-asc-btn');
        const sortFechaDescBtn = document.getElementById('sort-fecha-desc-btn');
        const showAllBtn = document.getElementById('show-all-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        
        const findDuplicatesBtn = document.getElementById('find-duplicates-btn');
        const crearAlertaBtn = document.getElementById('crear-alerta-btn'); 
        
        const resultsHeader = document.getElementById('results-header');
        const searchResultsDiv = document.getElementById('search-results');
        const resultsCount = document.getElementById('results-count');

        let currentNotificadoSelect = null; 
        let currentNotificadoDataObject = null;
        let previousSelectValue = ""; 

        function showStatus(message, type = 'loading') {
            statusMessage.textContent = message;
            statusMessage.className = type;
            statusMessage.style.display = 'block';

            if (type === 'loading') {
                statusMessage.innerHTML = `<span class="loader"></span> ${message}`;
            }
        }
        
        // --- FUNCIÓN ROBUSTA COPIAR PORTAPAPELES ---
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                let textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                return new Promise((resolve, reject) => {
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) resolve();
                        else reject(new Error("Fallback copy failed"));
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }

        // --- CARGA DE ARCHIVO ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        function sanitizeKey(key) {
            if (!key) return '';
            return key
                .trim()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") 
                .replace(/[.$#\[\]\/]/g, '_') 
                .replace(/\s/g, '_');
        }
        
        function getCanonicalKey(sanitizedKey) {
            if (sanitizedKey === 'matricula') return 'matricula';
            if (sanitizedKey === 'fecha_de_creacion' || sanitizedKey === 'fecha_creacion' || sanitizedKey === 'fechacreacion' || sanitizedKey === 'fecha') return 'fecha_de_creacion';
            if (sanitizedKey === 'marca') return 'marca';
            if (sanitizedKey === 'modelo') return 'modelo';
            if (sanitizedKey === 'revisado') return 'revisado';
            if (sanitizedKey === 'eurocop') return 'eurocop';
            if (sanitizedKey === 'notificado') return 'notificado';
            if (sanitizedKey === 'alerta') return 'alerta';
            return null;
        }

        function handleFile(file) {
            if (!file || !/\.(xlsx|xls)$/i.test(file.name)) {
                showStatus("Error: El archivo debe ser un .xls o .xlsx", 'error');
                return;
            }

            showStatus("Procesando archivo Excel...", 'loading');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) throw new Error("El archivo Excel está vacío o no tiene datos.");

                    const sanitizedJsonData = jsonData.map(row => {
                        const newRow = {};
                        Object.keys(row).forEach(excelKey => {
                            const sanitizedExcelKey = sanitizeKey(excelKey);
                            const canonicalKey = getCanonicalKey(sanitizedExcelKey);
                            
                            if (canonicalKey) {
                                if (canonicalKey === 'fecha_de_creacion' || canonicalKey === 'revisado') {
                                    let value = row[excelKey];
                                    if (value instanceof Date) {
                                        newRow[canonicalKey] = value.toISOString();
                                    } else if (typeof value === 'number' && value > 10000) {
                                        let converted = new Date(Math.round((value - 25569) * 86400 * 1000));
                                        newRow[canonicalKey] = converted.toISOString();
                                    } else if (typeof value === 'string' && value.includes('/')) {
                                        let [fecha, hora] = value.split(' ');
                                        let [d, m, y] = fecha.split('/');
                                        let [hh, mm] = hora ? hora.split(':') : [0, 0];
                                        if (y && m && d) {
                                            let fixed = new Date(Date.UTC(y, m - 1, d, hh || 0, mm || 0));
                                            newRow[canonicalKey] = fixed.toISOString();
                                        } else {
                                             newRow[canonicalKey] = value ?? null;
                                        }
                                    } else if (typeof value === 'string' && value.includes('-')) {
                                        let parsed = new Date(value);
                                        if (!isNaN(parsed.getTime())) {
                                            newRow[canonicalKey] = parsed.toISOString();
                                        } else {
                                            newRow[canonicalKey] = value ?? null;
                                        }
                                    } else {
                                        newRow[canonicalKey] = value ?? null;
                                    }
                                } else {
                                    newRow[canonicalKey] = row[excelKey];
                                }
                            }
                        });
                        return newRow;
                    });
                    
                    const intermediateData = sanitizedJsonData.filter(row => Object.keys(row).length > 0);
                    const spanishPlateRegex = /^\d{4}[A-Z]{3}$/i;
                    let spanishPlatesCount = 0;
                    const matriculaKey = 'matricula'; 

                    const finalData = intermediateData.filter(row => {
                        const plateValue = row[matriculaKey]; 
                        if (plateValue) {
                            const plate = String(plateValue).trim().replace(/\s/g, '');
                            if (spanishPlateRegex.test(plate)) {
                                spanishPlatesCount++; 
                                return false; 
                            }
                        }
                        return true; 
                    });

                    if (spanishPlatesCount > 0) {
                        alert(`Se han detectado y eliminado ${spanishPlatesCount} matrículas con formato español (1234ABC).`);
                    }
                    
                    if (finalData.length === 0) {
                        throw new Error("El archivo no contiene datos válidos tras el filtrado.");
                    }
                    
                    addAndSaveToFirebase(finalData);

                } catch (error) {
                    console.error("Error al leer el archivo Excel:", error);
                    showStatus(`Error: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function addAndSaveToFirebase(newData) {
            if (!database) {
                showStatus("Error: Firebase no está inicializado.", 'error');
                return;
            }
            
            showStatus("Cargando datos existentes para comparar...", 'loading');
            
            try {
                const snapshot = await database.ref(DENUNCIAS_ORA_REF).once('value');
                const existingData = snapshot.val() || [];
                const existingArray = Array.isArray(existingData) ? existingData : Object.values(existingData);

                const matriculaKey = 'matricula';
                
                const existingStatusMap = {};
                const existingCountMap = {};

                existingArray.forEach(item => {
                    const mat = String(item[matriculaKey] || '').trim().toUpperCase();
                    if (mat) {
                        if (item.alerta || item.notificado) {
                            existingStatusMap[mat] = {
                                alerta: item.alerta,
                                notificado: item.notificado,
                                revisado: item.revisado
                            };
                        }
                        existingCountMap[mat] = (existingCountMap[mat] || 0) + 1;
                    }
                });

                let reincidenciasAlertMsg = [];

                const processedNewData = newData.map(newItem => {
                    const newMat = String(newItem[matriculaKey] || '').trim().toUpperCase();
                    
                    if (newMat && existingCountMap[newMat]) {
                        const count = existingCountMap[newMat];
                        reincidenciasAlertMsg.push(`- ${newMat}: Constaba ${count} veces.`);

                        if (existingStatusMap[newMat]) {
                            if (existingStatusMap[newMat].alerta) newItem.alerta = true;
                            if (existingStatusMap[newMat].notificado) newItem.notificado = true;
                        }
                    }
                    return newItem;
                });

                if (reincidenciasAlertMsg.length > 0) {
                    let msgText = "Se han detectado que estos vehículos ya se encontraban como reincidentes:\n\n";
                    if (reincidenciasAlertMsg.length > 10) {
                        msgText += reincidenciasAlertMsg.slice(0, 10).join('\n') + `\n... y ${reincidenciasAlertMsg.length - 10} más.`;
                    } else {
                        msgText += reincidenciasAlertMsg.join('\n');
                    }
                    msgText += "\n\nSe les ha aplicado el estado (Alerta/Notificado) correspondiente si lo tenían.";
                    alert(msgText);
                }

                const combinedData = [...existingArray, ...processedNewData];
                
                showStatus(`Guardando ${newData.length} nuevos registros...`, 'loading');
                await database.ref(DENUNCIAS_ORA_REF).set(combinedData);

                showStatus(`¡Éxito! Se han añadido ${newData.length} registros.`, 'success');
                loadAndDisplayData();

            } catch (error) {
                console.error("Error al guardar en Firebase:", error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function loadAndDisplayData() {
            if (!database) return;
            showStatus("Cargando datos desde Firebase...", 'loading');
            try {
                const snapshot = await database.ref(DENUNCIAS_ORA_REF).once('value');
                const data = snapshot.val();

                if (!data) {
                    allDenuncias = [];
                    showStatus("No hay datos en Firebase.", 'error');
                } else {
                    allDenuncias = Array.isArray(data) ? data : Object.values(data);
                    showStatus(`Datos cargados (${allDenuncias.length} registros).`, 'success');
                }
                
                const fechaKey = 'fecha_de_creacion';
                const sortedByDefault = [...allDenuncias].sort((a, b) => {
                    const dateA = parseDate(a[fechaKey]) || new Date(0);
                    const dateB = parseDate(b[fechaKey]) || new Date(0);
                    return dateB - dateA; 
                });
                allDenuncias = sortedByDefault;
                displayResults(allDenuncias);

            } catch (error) {
                 console.error("Error al cargar datos:", error);
                 showStatus(`Error: ${error.message}`, 'error');
                 displayResults([]);
            }
        }
        
        function formatDisplayValue(value, key) {
            if (value === null || typeof value === 'undefined') return 'N/A';
            if (key === 'fecha_de_creacion') {
                let date;
                if (value instanceof Date) date = value; 
                else if (typeof value === 'string') date = new Date(value);
                else if (typeof value === 'number') date = new Date(Math.round((value - 25569) * 86400 * 1000));

                if (date instanceof Date && !isNaN(date.getTime())) {
                    const y = date.getUTCFullYear();
                    const m = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const d = String(date.getUTCDate()).padStart(2, '0');
                    const h = String(date.getUTCHours()).padStart(2, '0');
                    const min = String(date.getUTCMinutes()).padStart(2, '0');
                    return `${d}/${m}/${y} ${h}:${min}`;
                }
            }
            if (key === 'revisado') return formatRevisadoDate(value);
            return value;
        }

        function displayResults(results, isDuplicateSearch = false) {
             searchResultsDiv.innerHTML = '';
             resultsHeader.innerHTML = '';
             resultsHeader.style.display = 'none';
             resultsCount.textContent = `(${results.length})`;
            
            if (results.length === 0) {
                searchResultsDiv.innerHTML = `<div class="modern-alert modern-alert-error"><h4>Sin Resultados</h4><p>No se encontraron denuncias.</p></div>`;
                return;
            }

            const headers = CANONICAL_KEYS_LIST; 
            // Grid: Matricula | Fecha | Marca | Modelo | Revisado | Estado | Borrar
            const gridLayout = '1.5fr 2fr 1.5fr 1.5fr 1fr 2fr 0.5fr';

            resultsHeader.innerHTML = headers.map(h => `<div>${HEADER_DISPLAY_NAMES[h] || h.toUpperCase()}</div>`).join('');
            resultsHeader.style.gridTemplateColumns = gridLayout;
            resultsHeader.style.display = 'grid';

            const matriculaKey = 'matricula';
            const colorClasses = ['group-color-1', 'group-color-2', 'group-color-3', 'group-color-4', 'group-color-5', 'group-color-6'];
            let lastColorIndex = -1;
            let currentColorIndex = 0;
            let currentMatricula = null;
            let matriculaCounter = 0; 

            results.forEach(item => { 
                const row = document.createElement('div');
                row.classList.add('doc-row');

                const originalIndex = allDenuncias.indexOf(item);
                row.dataset.originalIndex = originalIndex;

                // Color Reincidentes
                let matriculaColorClass = '';
                const matricula = String(item[matriculaKey] || '').trim().toUpperCase(); 

                if (isDuplicateSearch) {
                    if (matricula !== currentMatricula) {
                        currentMatricula = matricula;
                        matriculaCounter = 1; 
                        let newColorIndex = Math.floor(Math.random() * colorClasses.length);
                        while (newColorIndex === lastColorIndex && colorClasses.length > 1) { 
                            newColorIndex = Math.floor(Math.random() * colorClasses.length);
                        }
                        lastColorIndex = newColorIndex;
                        currentColorIndex = newColorIndex;
                    } else {
                        matriculaCounter++; 
                    }
                    matriculaColorClass = colorClasses[currentColorIndex];
                }

                let rowHTML = '';
                headers.forEach(h => {
                    if (h === 'estado_expediente') {
                        let selectedVal = "";
                        if (item.notificado === true) selectedVal = "notificado";
                        else if (item.alerta === true) selectedVal = "alerta";
                        else if (item.eurocop === true) selectedVal = "eurocop";

                        rowHTML += `
                        <div>
                            <select class="estado-select">
                                <option value="" ${selectedVal === "" ? "selected" : ""}>Pendiente Revisión</option>
                                <option value="eurocop" ${selectedVal === "eurocop" ? "selected" : ""}>Sin datos en Eurocop</option>
                                <option value="alerta" ${selectedVal === "alerta" ? "selected" : ""}>Alerta grabada en Eurocop</option>
                                <option value="notificado" ${selectedVal === "notificado" ? "selected" : ""}>Notificado a sanciones</option>
                            </select>
                        </div>`;
                    
                    } else if (h === 'revisado') {
                        const revisadoDate = item[h]; 
                        const formattedDate = formatRevisadoDate(revisadoDate);
                        if (formattedDate) {
                            rowHTML += `<div class="revisado-cell date-set" data-state="date">${formattedDate}</div>`;
                        } else {
                            rowHTML += `<div class="revisado-cell" data-state="check"><input type="checkbox" class="check-revisado"></div>`;
                        }
                    
                    } else if (h === 'acciones') {
                        rowHTML += `<div style="text-align: center;"><button class="btn-icon-delete" title="Eliminar registro"><i class="fas fa-trash"></i></button></div>`;
                    } else {
                        const value = item[h];
                        let cellClasses = '';
                        let displayValue = formatDisplayValue(value, h);

                        if (h === 'matricula') {
                            cellClasses = 'cell-matricula ' + matriculaColorClass;
                            if (isDuplicateSearch) {
                                displayValue = `${displayValue} (${matriculaCounter})`; 
                            }
                        }
                        rowHTML += `<div class="${cellClasses}">${displayValue}</div>`;
                    }
                });
                row.innerHTML = rowHTML;
                row.style.gridTemplateColumns = gridLayout;
                searchResultsDiv.appendChild(row);

                updateRowColor(row);
            });
        }
        
        function performSearch() {
            const searchQuery = searchInput.value.trim().toUpperCase();
            if (!searchQuery) {
                const fechaKey = 'fecha_de_creacion';
                const sortedByDefault = [...allDenuncias].sort((a, b) => {
                    const dateA = parseDate(a[fechaKey]) || new Date(0);
                    const dateB = parseDate(b[fechaKey]) || new Date(0);
                    return dateB - dateA;
                });
                displayResults(sortedByDefault);
                return;
            }
            const matriculaKey = 'matricula';
            const results = allDenuncias.filter(item => {
                return item && item[matriculaKey] && 
                       String(item[matriculaKey]).toUpperCase().includes(searchQuery);
            });
            displayResults(results); 
        }
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('input', performSearch);
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); performSearch(); }});
        
        showAllBtn.addEventListener('click', () => {
            searchInput.value = '';
            const fechaKey = 'fecha_de_creacion';
            const sortedByDefault = [...allDenuncias].sort((a, b) => {
                const dateA = parseDate(a[fechaKey]) || new Date(0);
                const dateB = parseDate(b[fechaKey]) || new Date(0);
                return dateB - dateA;
            });
            displayResults(sortedByDefault);
        });

        sortMatriculaBtn.addEventListener('click', () => {
            const matriculaKey = 'matricula'; 
            const sorted = [...allDenuncias].sort((a, b) => {
                const matA = String(a[matriculaKey] || '').trim().toUpperCase();
                const matB = String(b[matriculaKey] || '').trim().toUpperCase();
                return matA.localeCompare(matB);
            });
            displayResults(sorted);
        });
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            if (String(dateStr).includes('/')) {
                const parts = String(dateStr).split(' ');
                const dateParts = parts[0].split('/');
                if (dateParts.length === 3) {
                    if (parts.length > 1) {
                        const timeParts = parts[1].split(':');
                        return new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0] || 0, timeParts[1] || 0);
                    } else {
                        return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    }
                }
            }
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) return date;
            return null;
        }

        sortFechaAscBtn.addEventListener('click', () => {
            const fechaKey = 'fecha_de_creacion'; 
            const sorted = [...allDenuncias].sort((a, b) => {
                const dateA = parseDate(a[fechaKey]) || new Date(0);
                const dateB = parseDate(b[fechaKey]) || new Date(0);
                return dateA - dateB;
            });
            displayResults(sorted);
        });
        
        sortFechaDescBtn.addEventListener('click', () => {
             const fechaKey = 'fecha_de_creacion';
            const sorted = [...allDenuncias].sort((a, b) => {
                const dateA = parseDate(a[fechaKey]) || new Date(0);
                const dateB = parseDate(b[fechaKey]) || new Date(0);
                return dateB - dateA;
            });
            displayResults(sorted); 
        });
        
        async function deleteAllData() {
            const confirmation = window.prompt('Esto borrará PERMANENTEMENTE todos los datos. \n\nEscribe "BORRAR" y pulsa Aceptar.');
            if (confirmation !== 'BORRAR') return;
            if (!database) return;
            showStatus("Borrando todo...", 'loading');
            try {
                await database.ref(DENUNCIAS_ORA_REF).remove();
                showStatus("Datos borrados.", 'success');
                allDenuncias = [];
                displayResults([]);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        function formatRevisadoDate(dateValue) {
            if (!dateValue) return '';
            try {
                let date = parseDate(dateValue); 
                if (date && !isNaN(date.getTime())) {
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const y = date.getFullYear();
                    return `${d}-${m}-${y}`;
                }
                return '';
            } catch (e) { return ''; }
        }

        function updateRowColor(row) {
            if (!row) return;
            const select = row.querySelector('.estado-select');
            const selectedValue = select ? select.value : '';
            const revisadoCell = row.querySelector('.revisado-cell');
            const isRevisado = (revisadoCell && revisadoCell.classList.contains('date-set'));

            row.classList.remove('highlight-yellow', 'highlight-green', 'highlight-blue', 'highlight-red');

            if (selectedValue === 'notificado') row.classList.add('highlight-green');
            else if (selectedValue === 'alerta') row.classList.add('highlight-red');
            else if (selectedValue === 'eurocop') row.classList.add('highlight-yellow');
            else if (isRevisado) row.classList.add('highlight-blue');
        }

        function findAndDisplayDuplicates() {
            if (!allDenuncias.length) {
                showStatus("No hay datos cargados.", "info");
                return;
            }
            showStatus("Buscando reincidentes...", "loading");
            const matriculaCounts = new Map();
            const matriculaKey = 'matricula';
            for (const item of allDenuncias) {
                const matricula = String(item[matriculaKey] || '').trim().toUpperCase();
                if (matricula) matriculaCounts.set(matricula, (matriculaCounts.get(matricula) || 0) + 1);
            }
            const duplicateMatriculas = new Set();
            for (const [matricula, count] of matriculaCounts.entries()) {
                if (count > 1) duplicateMatriculas.add(matricula);
            }
            if (duplicateMatriculas.size === 0) {
                showStatus("No se encontraron reincidentes.", "info");
                displayResults([], false);
                return;
            }
            const duplicatesList = allDenuncias.filter(item => {
                const matricula = String(item[matriculaKey] || '').trim().toUpperCase();
                return duplicateMatriculas.has(matricula);
            });
            const sortedDuplicates = duplicatesList.sort((a, b) => {
                const matA = String(a[matriculaKey] || '').trim().toUpperCase();
                const matB = String(b[matriculaKey] || '').trim().toUpperCase();
                const matriculaComparison = matA.localeCompare(matB);
                if (matriculaComparison !== 0) return matriculaComparison;
                const dateA = parseDate(a['fecha_de_creacion']) || new Date(0);
                const dateB = parseDate(b['fecha_de_creacion']) || new Date(0);
                return dateB - dateA;
            });
            showStatus(`Se encontraron ${sortedDuplicates.length} registros de ${duplicateMatriculas.size} matrículas reincidentes.`, "success");
            displayResults(sortedDuplicates, true);
        }
        
        function crearAlertaEurocop() {
            const alertText = 'Este vehículo es de interés para el negociado de sanciones del Ayuntamiento de Alicante. Se trata de un vehículo reincidente en infracciones de estacionamiento ORA. Es necesario tratar de obtener un domicilio para notificaciones, número de identificación DNI o NIE, e identificar plenamente al conductor. Realizar incidencia en Eurocop con seguimiento al GAD para su tramitación. Si el vehículo fuera inmovilizado por cualquier causa debe quedar "A disposición del GAD"';
            copyToClipboard(alertText)
                .then(() => alert("¡Texto de Alerta copiado!"))
                .catch(err => alert('Error al copiar el texto: ' + err));
        }

        // --- FUNCIÓN CORREGIDA Y ROBUSTA PARA SINCRONIZAR DUPLICADOS ---
        function syncDuplicatesState(matriculaRaw, sourceDataObject) {
            if (!matriculaRaw) return;
            
            // AQUÍ ESTABA EL ERROR: Convertimos a string explícitamente antes del .trim()
            const matTarget = String(matriculaRaw).trim().toUpperCase();
            
            // 1. Actualizar Data Model global
            allDenuncias.forEach(item => {
                const m = String(item.matricula || '').trim().toUpperCase();
                if (m === matTarget) {
                    item.eurocop = sourceDataObject.eurocop;
                    item.alerta = sourceDataObject.alerta;
                    item.notificado = sourceDataObject.notificado;
                    item.revisado = sourceDataObject.revisado;
                }
            });

            // 2. Actualizar DOM visible (todas las filas de esa matrícula)
            const allRows = searchResultsDiv.querySelectorAll('.doc-row');
            allRows.forEach(row => {
                const idx = row.dataset.originalIndex;
                if (idx) {
                    // Recuperamos el dato real
                    const data = allDenuncias[parseInt(idx, 10)];
                    // Comprobamos si su matrícula coincide (usando String() para seguridad)
                    if (data && String(data.matricula||'').trim().toUpperCase() === matTarget) {
                        
                        // Sincronizar Select
                        const select = row.querySelector('.estado-select');
                        if (select) {
                            if (data.notificado) select.value = 'notificado';
                            else if (data.alerta) select.value = 'alerta';
                            else if (data.eurocop) select.value = 'eurocop';
                            else select.value = '';
                        }

                        // Sincronizar Celda Revisado
                        const revisadoCell = row.querySelector('.revisado-cell');
                        if (revisadoCell) {
                            const fDate = formatRevisadoDate(data.revisado);
                            if (fDate) {
                                revisadoCell.innerHTML = fDate;
                                revisadoCell.classList.add('date-set');
                                revisadoCell.dataset.state = 'date';
                            } else {
                                revisadoCell.innerHTML = '<input type="checkbox" class="check-revisado">';
                                revisadoCell.classList.remove('date-set');
                                revisadoCell.dataset.state = 'check';
                            }
                        }
                        
                        // Sincronizar Color
                        updateRowColor(row);
                    }
                }
            });
            
            // 3. Guardar en Firebase
            database.ref(DENUNCIAS_ORA_REF).set(allDenuncias);
        }

        async function deleteRow(index) {
            if (!confirm("¿Seguro que quieres eliminar este registro?")) return;
            
            allDenuncias.splice(index, 1);
            
            if (database) {
                 await database.ref(DENUNCIAS_ORA_REF).set(allDenuncias);
            }
            
            const isSearchingDuplicates = document.getElementById('results-count').textContent.includes('reincidentes');
            if (isSearchingDuplicates) findAndDisplayDuplicates();
            else if (searchInput.value.trim() !== '') performSearch();
            else showAllBtn.click();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAndDisplayData();
            
            deleteAllBtn.addEventListener('click', deleteAllData);
            findDuplicatesBtn.addEventListener('click', findAndDisplayDuplicates); 
            crearAlertaBtn.addEventListener('click', crearAlertaEurocop);

            searchResultsDiv.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('estado-select')) {
                    previousSelectValue = e.target.value;
                }
            });

            // Listener GLOBAL CHANGE para el Select
            searchResultsDiv.addEventListener('change', (e) => {
                const row = e.target.closest('.doc-row');
                if (!row || typeof row.dataset.originalIndex === 'undefined') return;
                const dataIndex = parseInt(row.dataset.originalIndex, 10);
                const dataObject = allDenuncias[dataIndex];
                if (!dataObject) return;

                if (e.target.classList.contains('estado-select')) {
                    const newValue = e.target.value;

                    // Resetear flags de estado
                    dataObject.eurocop = false;
                    dataObject.alerta = false;
                    dataObject.notificado = false;

                    // --- AUTOMATISMO REVISADO ---
                    if (newValue !== "") {
                        const today = new Date();
                        dataObject.revisado = today.toISOString();
                    } else {
                        // Si vuelve a Pendiente, quitamos la fecha
                        dataObject.revisado = null;
                    }

                    if (newValue === 'eurocop') { 
                        dataObject.eurocop = true;
                        syncDuplicatesState(dataObject.matricula, dataObject);

                    } else if (newValue === 'alerta') {
                        dataObject.alerta = true;
                        syncDuplicatesState(dataObject.matricula, dataObject);

                    } else if (newValue === 'notificado') {
                        // Abrir Modal
                        currentNotificadoSelect = e.target;
                        currentNotificadoDataObject = dataObject;
                        
                        document.getElementById('modal-nombre').value = '';
                        document.getElementById('modal-doi').value = '';
                        document.getElementById('modal-direccion').value = '';
                        document.getElementById('modal-localidad').value = '';
                        document.getElementById('modal-fecha-nacimiento').value = '';
                        document.getElementById('modal-telefono').value = '';
                        document.getElementById('notification-modal').style.display = 'block';
                        document.getElementById('notification-modal-overlay').style.display = 'block';
                        document.getElementById('modal-nombre').focus(); 
                    } else {
                        // Estado Pendiente
                        syncDuplicatesState(dataObject.matricula, dataObject);
                    }
                }
            });
            
            searchResultsDiv.addEventListener('click', (e) => {
                const target = e.target;

                // Botón Papelera
                const deleteBtn = target.closest('.btn-icon-delete');
                if (deleteBtn) {
                    const row = deleteBtn.closest('.doc-row');
                    const dataIndex = parseInt(row.dataset.originalIndex, 10);
                    deleteRow(dataIndex);
                    return;
                }

                const cell = target.closest('.revisado-cell');
                if (!cell) return;

                const row = cell.closest('.doc-row');
                if (!row || typeof row.dataset.originalIndex === 'undefined') return;
                const dataIndex = parseInt(row.dataset.originalIndex, 10);
                const dataObject = allDenuncias[dataIndex];
                
                // Clic checkbox revisado
                if (target.classList.contains('check-revisado')) {
                    const today = new Date();
                    dataObject.revisado = today.toISOString();
                    syncDuplicatesState(dataObject.matricula, dataObject);
                }
                // Clic fecha puesta (para quitar o actualizar)
                else if (target.classList.contains('revisado-cell') && target.classList.contains('date-set')) {
                    const confirmation = window.confirm("Aceptar: Actualizar fecha revisión.\nCancelar: Desactivar revisión.");
                    if (confirmation) {
                        const today = new Date();
                        dataObject.revisado = today.toISOString();
                    } else {
                        dataObject.revisado = null; 
                    }
                    syncDuplicatesState(dataObject.matricula, dataObject);
                }
            });
            
            // Lógica Modal
            const notificationModal = document.getElementById('notification-modal');
            const notificationOverlay = document.getElementById('notification-modal-overlay');
            const modalAcceptBtn = document.getElementById('modal-accept-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            function closeModal(cancelled = false) {
                notificationModal.style.display = 'none';
                notificationOverlay.style.display = 'none';
                if (cancelled && currentNotificadoSelect) {
                    currentNotificadoSelect.value = previousSelectValue;
                    // Si cancela, revertimos el select visualmente,
                    // el estado interno 'notificado' no se llegó a poner a true
                }
                currentNotificadoSelect = null;
                currentNotificadoDataObject = null;
            }

            modalCancelBtn.addEventListener('click', () => closeModal(true));
            notificationOverlay.addEventListener('click', () => closeModal(true));

            modalAcceptBtn.addEventListener('click', () => {
                if (!currentNotificadoDataObject || !currentNotificadoSelect) return;
                
                const nombre = document.getElementById('modal-nombre').value;
                const doi = document.getElementById('modal-doi').value;
                const direccion = document.getElementById('modal-direccion').value;
                const localidad = document.getElementById('modal-localidad').value;
                const fechaNac = document.getElementById('modal-fecha-nacimiento').value;
                const telefono = document.getElementById('modal-telefono').value;

                // --- RESTAURADO: PLANTILLA DE TEXTO COMPLETA ---
                const textToCopy = `
Grupo de Análisis Documental (GAD) Policía Local de Alicante
Le informamos de que disponemos de los siguientes datos en relación a este vehículo
---
DENUNCIA ORA:
- Matrícula: ${currentNotificadoDataObject.matricula || 'N/A'}
- Fecha: ${formatDisplayValue(currentNotificadoDataObject.fecha_de_creacion, 'fecha_de_creacion') || 'N/A'}
- Marca: ${currentNotificadoDataObject.marca || 'N/A'}
- Modelo: ${currentNotificadoDataObject.modelo || 'N/A'}
---
DATOS PERSONALES:
- Nombre: ${nombre || 'N/A'}
- DOI: ${doi || 'N/A'}
- Dirección: ${direccion || 'N/A'}
- Localidad: ${localidad || 'N/A'}
- F. Nacimiento: ${fechaNac || 'N/A'}
- Teléfono: ${telefono || 'N/A'}
                `.trim().replace(/^\s+/gm, ''); // Limpia espacios extra

                // Usamos la función robusta copyToClipboard
                copyToClipboard(textToCopy)
                    .then(() => {
                        currentNotificadoDataObject.notificado = true;
                        currentNotificadoDataObject.eurocop = false;
                        currentNotificadoDataObject.alerta = false;
                        
                        // IMPORTANTE: Sincronizar duplicados AHORA que se ha confirmado
                        syncDuplicatesState(currentNotificadoDataObject.matricula, currentNotificadoDataObject);
                        
                        closeModal(false);
                        alert('¡Notificación copiada! Estado actualizado para todos los duplicados.');
                    })
                    .catch(err => {
                        alert('Error al copiar: ' + err);
                        closeModal(true);
                    });
            });
        });
    </script>
</body>
</html>
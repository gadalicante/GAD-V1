<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAD - Ayuda Países v17.2 (Img Tools Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow-x: hidden; width: 100vw; }
        .main-container { width: 98%; margin: 0 auto; max-width: 100vw; }

        /* HEADER & SIDEBAR */
        .header-logo { height: 160px; width: auto; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }
        
        .sidebar-item { 
            font-size: 13px; font-weight: 700; text-transform: uppercase;
            margin-bottom: 6px; border-radius: 12px; transition: all 0.3s;
            border: 1px solid transparent; width: 100%; text-align: left; padding: 0.8rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .country-empty { background-color: #f3f4f6; color: #94a3b8; font-weight: 400; opacity: 0.7; }
        .country-has-data { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .sidebar-item.active { background-color: #2563eb !important; color: white !important; border-color: #1d4ed8; opacity: 1; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .flag-img { width: 28px; height: auto; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.1); }

        /* EDITOR */
        .editor-wrapper { 
            min-height: 700px; background: white; border-radius: 2rem; 
            border: 1px solid #e2e8f0; margin-bottom: 2rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
        }
        #mainEditor { 
            outline: none; padding: 3rem; color: #1e293b; font-size: 1.15rem; 
            line-height: 1.8; word-wrap: break-word; overflow-wrap: break-word;
        }

        /* --- GRID & CELDAS --- */
        .grid-container {
            position: relative; margin-bottom: 2rem; border-radius: 12px; transition: all 0.2s;
        }
        
        .row-tools-header {
            display: none; height: 32px; background: #e2e8f0; border-radius: 10px 10px 0 0; padding: 0 15px;
            justify-content: flex-end; align-items: center; border: 2px dashed #cbd5e1; border-bottom: none;
        }
        .editing .row-tools-header { display: flex; } 
        
        .row-delete-btn { 
            color: #ef4444; font-size: 11px; font-weight: 900; cursor: pointer; 
            text-transform: uppercase; display: flex; align-items: center; gap: 6px; 
            padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.5);
        }
        .row-delete-btn:hover { background: #fee2e2; color: #b91c1c; }

        .grid-row-2, .grid-row-1 { display: grid; gap: 1.5rem; align-items: start; width: 100%; }
        .grid-row-2 { grid-template-columns: 1fr 1fr; }
        .grid-row-1 { grid-template-columns: 1fr; }

        @media (max-width: 768px) { .grid-row-2 { grid-template-columns: 1fr !important; } }

        .grid-cell {
            min-height: 150px; padding: 10px; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%;
            /* Alineación por defecto */
            align-items: flex-start; 
        }

        .editing .grid-container { background: #f8fafc; }
        .editing .grid-row-2, .editing .grid-row-1 {
            border: 2px dashed #cbd5e1; border-top: none; padding: 15px; background: #f8fafc; border-radius: 0 0 12px 12px;
        }
        .editing .grid-cell { border: 2px dashed #94a3b8; background-color: white; }
        .editing .grid-cell.drag-over {
            background-color: #dcfce7 !important; border-color: #16a34a !important; transform: scale(1.02); z-index: 50;
        }

        /* --- BOTÓN AÑADIR (PLACEHOLDER) --- */
        .placeholder-btn {
            width: 100%; min-height: 150px; flex-grow: 1;
            border: 2px dashed #e2e8f0; border-radius: 10px;
            color: #94a3b8; font-weight: 700; font-size: 12px; background: #f8fafc;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .placeholder-btn:hover { background: #f1f5f9; color: #3b82f6; border-color: #3b82f6; }
        body:not(.editing-mode) .placeholder-btn { display: none !important; }

        /* --- IMÁGENES --- */
        .img-block { 
            position: relative; display: block; 
            /* Importante: width ya no es 100% fijo, sino controlado por style inline */
            max-width: 100%;
            margin: 0; /* Controlado por alineación */
            opacity: 1 !important; filter: none !important; mix-blend-mode: normal !important;
        }
        .img-block img { 
            display: block; width: 100%; height: auto; 
            border-radius: 12px; border: 2px solid #cbd5e1; pointer-events: auto; 
        }
        .img-block.dragging { opacity: 0.5 !important; border: 2px dashed #3b82f6; }

        /* TOOLBAR DE IMAGEN */
        .img-tools { 
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            display: none; gap: 4px; z-index: 100; 
            background: #1e293b; padding: 6px; border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        /* Flecha del tooltip */
        .img-tools::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }

        .editing .img-block:hover .img-tools { display: flex; }
        .editing .img-block { cursor: grab; border: 2px solid transparent; }
        
        .tool-btn { width: 28px; height: 28px; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: none; transition: 0.2s; }
        .btn-blue { background: #3b82f6; } .btn-blue:hover { background: #2563eb; }
        .btn-red { background: #ef4444; } .btn-red:hover { background: #dc2626; }
        .btn-gray { background: #475569; } .btn-gray:hover { background: #334155; }
        
        .separator { width: 1px; height: 18px; background: #475569; margin: 0 4px; }

        /* VISOR */
        #zoomOverlay { display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; flex-direction: column; }
        #zoomImgContainer { position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; }
        #zoomImg { max-width: 100%; max-height: 85vh; border-radius: 4px; border: 2px solid #fff; cursor: pointer; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 20px; font-size: 24px; cursor: pointer; border-radius: 50%; z-index: 10001; }
        .prev-btn { left: -80px; } .next-btn { right: -80px; }
        .close-zoom-btn { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; opacity: 0.7; z-index: 10002; }

        .tab-btn { font-size: 13px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; border-bottom: 4px solid transparent; padding-bottom: 12px; transition: all 0.2s; white-space: nowrap; }
        .tab-btn.active { border-bottom: 5px solid #2563eb; color: #2563eb; font-weight: 900; }
        
        /* HERRAMIENTAS GENERALES */
        .toolbar-group { display: flex; align-items: center; gap: 8px; padding: 0 10px; border-right: 1px solid #475569; margin-right: 5px; }
        .tool-icon-btn { width: 32px; height: 32px; text-align: center; color: white; background: rgba(255,255,255,0.1); border-radius: 6px; transition: all 0.2s; font-size: 12px; }
        .tool-icon-btn:hover { background: rgba(255,255,255,0.2); }
        .tool-select { background: #334155; border: 1px solid #475569; color: white; border-radius: 6px; padding: 0 6px; font-size: 12px; height: 32px; font-weight: bold; }
        .color-dot-btn { width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); transition: transform 0.2s; cursor: pointer; }
        .color-dot-btn:hover { transform: scale(1.15); border-color: white; }
        .insert-label { font-size: 10px; font-weight: 800; color: #94a3b8; margin-right: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-900 text-white shadow-2xl py-1 px-6 flex flex-wrap items-center justify-between z-50">
        <div class="flex items-center gap-8">
            <img src="logogad.png" onerror="this.src='https://via.placeholder.com/200/FFFFFF/0000FF?text=GAD'" class="header-logo">
            <div>
                <h1 class="text-4xl font-black uppercase tracking-tighter">GAD ALICANTE</h1>
                <p class="text-[11px] font-bold text-blue-300 tracking-[0.5em] uppercase mt-1">NODO PERMANENTE: AYUDA PAÍSES</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="nuevoPaisManual()" class="bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl text-[10px] font-black border border-slate-600 transition-all shadow-lg"><i class="fas fa-plus mr-2"></i> AÑADIR PAÍS MANUAL</button>
            <button id="btnMode" onclick="toggleEdit()" class="bg-amber-500 hover:bg-amber-400 text-blue-950 px-8 py-3 rounded-2xl text-sm font-black shadow-2xl transition-all flex items-center gap-3"><i class="fas fa-lock" id="iconStatus"></i> <span id="textStatus">ENTRAR A MODO EDICIÓN</span></button>
        </div>
    </header>

    <div class="flex flex-grow flex-col lg:flex-row overflow-hidden main-container">
        <aside class="w-full lg:w-80 lg:flex-shrink-0 bg-white border-r border-slate-200 flex flex-col shadow-inner overflow-y-auto max-h-[400px] lg:max-h-full z-10">
            <div class="p-4 bg-slate-50 sticky top-0 z-10 border-b">
                <input type="text" id="search" placeholder=" Buscar País..." class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold outline-none focus:ring-4 focus:ring-blue-100 transition-all">
            </div>
            <nav id="countryList" class="p-3 space-y-1"></nav>
        </aside>

        <main class="flex-grow flex flex-col bg-slate-100 p-4 md:p-10 overflow-y-auto h-full overflow-x-hidden">
            <div id="welcome" class="flex-grow flex flex-col items-center justify-center text-slate-300 opacity-20"><i class="fas fa-shield-halved text-[15rem]"></i></div>
            <div id="contentSection" class="hidden">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
                    <h2 id="countryName" class="text-5xl md:text-7xl font-black text-slate-800 uppercase tracking-tighter">--</h2>
                    <button onclick="eliminarPais()" class="edit-ui hidden bg-red-600 text-white px-6 py-2 rounded-lg text-xs font-black shadow-lg hover:bg-red-700 transition-all"><i class="fas fa-trash-alt mr-2"></i> ELIMINAR PAÍS</button>
                </div>
                
                <div class="flex gap-6 md:gap-12 border-b border-slate-300 mb-8 overflow-x-auto whitespace-nowrap scrollbar-hide">
                    <button onclick="switchTab('permiso')" id="tab-permiso" class="tab-btn active">Permiso Circulación</button>
                    <button onclick="switchTab('itv')" id="tab-itv" class="tab-btn">Ficha ITV</button>
                    <button onclick="switchTab('seguro')" id="tab-seguro" class="tab-btn">Seguro</button>
                    <button onclick="switchTab('personales')" id="tab-personales" class="tab-btn">Doc. Personales</button>
                    <button onclick="switchTab('otros')" id="tab-otros" class="tab-btn">Otros / Notas</button>
                </div>
                
                <div id="toolbar" class="hidden bg-slate-900 p-3 rounded-t-2xl flex items-center gap-2 flex-wrap border-b border-slate-700 sticky top-0 z-20 shadow-2xl">
                    <div class="toolbar-group">
                        <button onclick="undo()" class="tool-icon-btn bg-slate-600 hover:bg-slate-500" title="Deshacer (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    </div>

                    <div class="toolbar-group">
                        <button onmousedown="event.preventDefault(); exec('bold')" class="tool-icon-btn"><i class="fas fa-bold"></i></button>
                        <button onmousedown="event.preventDefault(); exec('insertUnorderedList')" class="tool-icon-btn"><i class="fas fa-list-ul"></i></button>
                        <button onmousedown="event.preventDefault(); exec('justifyLeft')" class="tool-icon-btn" title="Izquierda"><i class="fas fa-align-left"></i></button>
                        <button onmousedown="event.preventDefault(); exec('justifyCenter')" class="tool-icon-btn" title="Centro"><i class="fas fa-align-center"></i></button>
                        <button onmousedown="event.preventDefault(); exec('justifyRight')" class="tool-icon-btn" title="Derecha"><i class="fas fa-align-right"></i></button>
                        <button onmousedown="event.preventDefault(); exec('justifyFull')" class="tool-icon-btn" title="Justificar"><i class="fas fa-align-justify"></i></button>
                    </div>

                    <div class="toolbar-group">
                        <div class="flex gap-2 mx-1">
                            <button onmousedown="event.preventDefault(); exec('foreColor', '#000000')" class="color-dot-btn bg-black" title="Negro"></button>
                            <button onmousedown="event.preventDefault(); exec('foreColor', '#dc2626')" class="color-dot-btn bg-red-600" title="Rojo"></button>
                            <button onmousedown="event.preventDefault(); exec('foreColor', '#16a34a')" class="color-dot-btn bg-green-600" title="Verde"></button>
                        </div>
                        <select onchange="exec('fontSize', this.value); this.value=''" class="tool-select w-12 text-center" title="Tamaño">
                            <option value="" disabled selected>T</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>

                    <span class="insert-label">INSERTAR:</span>
                    <button onclick="insertTextTop()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase shadow border border-yellow-500 mr-1">
                        <i class="fas fa-arrow-up mr-1"></i> TXT INI
                    </button>
                    <button onclick="insertText()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase shadow border border-slate-500"><i class="fas fa-font mr-1"></i> TXT</button>
                    <button onclick="insertGrid(1)" class="bg-indigo-700 hover:bg-indigo-600 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase shadow border border-indigo-500 ml-1"><i class="fas fa-square mr-1"></i> 1 COL</button>
                    <button onclick="insertGrid(2)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded-lg text-[10px] font-black uppercase shadow border border-indigo-400 ml-1"><i class="fas fa-table-columns mr-1"></i> 2 COL</button>
                    
                    <button onclick="save()" class="ml-auto bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg text-[10px] font-black uppercase shadow-2xl border border-green-400"><i class="fas fa-save mr-2"></i> GUARDAR</button>
                </div>

                <div class="editor-wrapper">
                    <div id="mainEditor" contenteditable="false"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="zoomOverlay" onclick="closeZoom(event)">
        <div class="close-zoom-btn" onclick="document.getElementById('zoomOverlay').style.display='none'">&times;</div>
        <div id="zoomImgContainer" onclick="event.stopPropagation()">
            <button class="nav-btn prev-btn" onclick="navigateZoom(-1, event)"><i class="fas fa-chevron-left"></i></button>
            <img id="zoomImg" onclick="closeZoom(event)" title="Click para cerrar">
            <button class="nav-btn next-btn" onclick="navigateZoom(1, event)"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="text-white mt-4 font-bold bg-black/50 px-4 py-1 rounded-full"><span id="zoomCounter">1 / 1</span></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBu5ALRVJ5aDzuU9YIAQD_9KMgR6ZwttpU", authDomain: "gad-alicante-v1.firebaseapp.com", databaseURL: "https://gad-alicante-v1-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gad-alicante-v1", storageBucket: "gad-alicante-v1.appspot.com", messagingSenderId: "545835357966", appId: "1:545835357966:web:6351ec6c0d3c8e69eb695f" };
        firebase.initializeApp(firebaseConfig); const ref = firebase.database().ref('Ayuda Países'); 
        let isEdit = false, activeId = null, activeTab = 'permiso', countries = {};
        const flagCodes = { "ALBANIA": "al", "ALEMANIA": "de", "ANDORRA": "ad", "ARGELIA": "dz", "ARMENIA": "am", "AUSTRIA": "at", "AZERBAIYAN": "az", "BELGICA": "be", "BIELORRUSIA": "by", "BOSNIA Y HERZEGOVINA": "ba", "BULGARIA": "bg", "CHIPRE": "cy", "CIUDAD DEL VATICANO": "va", "CROACIA": "hr", "DINAMARCA": "dk", "ESLOVAQUIA": "sk", "ESLOVENIA": "si", "ESPANA": "es", "ESTONIA": "ee", "FINLANDIA": "fi", "FRANCIA": "fr", "GEORGIA": "ge", "GRECIA": "gr", "HUNGRIA": "hu", "IRLANDA": "ie", "ISLANDIA": "is", "ITALIA": "it", "KAZAJISTAN": "kz", "LETONIA": "lv", "LIECHTENSTEIN": "li", "LITUANIA": "lt", "LUXEMBURGO": "lu", "MALTA": "mt", "MARRUECOS": "ma", "MOLDAVIA": "md", "MONACO": "mc", "MONTENEGRO": "me", "NORUEGA": "no", "PAISES BAJOS": "nl", "POLONIA": "pl", "PORTUGAL": "pt", "REINO UNIDO": "gb", "REPUBLICA CHECA": "cz", "MACEDONIA DEL NORTE": "mk", "RUMANIA": "ro", "RUSIA": "ru", "SAN MARINO": "sm", "SERBIA": "rs", "SUECIA": "se", "SUIZA": "ch", "TURQUIA": "tr", "UCRANIA": "ua", "LIBIA": "ly", "TUNEZ": "tn", "EGIPTO": "eg" };

        /* UNDO */
        let historyStack = []; const MAX_HISTORY = 50;
        function pushHistory() {
            const editor = document.getElementById('mainEditor');
            const content = editor.innerHTML;
            if (historyStack.length > 0 && historyStack[historyStack.length - 1] === content) return;
            historyStack.push(content);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
        }
        function undo() {
            if (historyStack.length > 0) {
                const previousState = historyStack.pop();
                const editor = document.getElementById('mainEditor');
                if (editor.innerHTML === previousState && historyStack.length > 0) editor.innerHTML = historyStack.pop();
                else editor.innerHTML = previousState;
                if(isEdit) { makeDraggable(); }
            }
        }

        /* DRAG & DROP */
        let draggedElement = null;
        const mainEditor = document.getElementById('mainEditor');
        mainEditor.addEventListener('dragstart', (e) => {
            if (!isEdit) return;
            if (e.target.closest('.img-block')) { draggedElement = e.target.closest('.img-block'); e.dataTransfer.setData("text/plain", draggedElement.id); e.dataTransfer.effectAllowed = "move"; draggedElement.classList.add('dragging'); }
        });
        mainEditor.addEventListener('dragend', (e) => { if (draggedElement) draggedElement.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedElement = null; });
        mainEditor.addEventListener('dragover', (e) => {
            if (!isEdit) return; e.preventDefault(); const cell = e.target.closest('.grid-cell'); if (cell) { e.dataTransfer.dropEffect = "move"; cell.classList.add('drag-over'); }
        });
        mainEditor.addEventListener('dragleave', (e) => { const cell = e.target.closest('.grid-cell'); if (cell) cell.classList.remove('drag-over'); });
        mainEditor.addEventListener('drop', (e) => {
            if (!isEdit) return; e.preventDefault(); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const targetCell = e.target.closest('.grid-cell');
            if (draggedElement && targetCell) {
                pushHistory();
                if (targetCell.contains(draggedElement)) return; 
                const sourceCell = draggedElement.parentElement;
                const existingImg = targetCell.querySelector('.img-block');
                if (existingImg) { sourceCell.appendChild(existingImg); targetCell.appendChild(draggedElement); } 
                else { targetCell.innerHTML = ''; targetCell.appendChild(draggedElement); }
                cleanUpOldRows();
            }
        });

        /* RENDER */
        document.addEventListener('DOMContentLoaded', () => {
            ref.on('value', s => { countries = s.val() || {}; renderList(); });
            document.getElementById('search').addEventListener('input', e => renderList(e.target.value));
            mainEditor.addEventListener('click', e => { if(!isEdit && e.target.tagName === 'IMG' && e.target.closest('.img-block')) openZoom(e.target.src); });
        });
        function renderList(filter = '') {
            const list = document.getElementById('countryList'); list.innerHTML = '';
            Object.keys(countries).sort((a,b) => countries[a].nombre.localeCompare(countries[b].nombre)).forEach(id => {
                const c = countries[id]; const nombreKey = c.nombre.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if(c.nombre.toLowerCase().includes(filter.toLowerCase())) {
                    const hasData = c.datos && Object.values(c.datos).some(d => d && d.length > 50);
                    const btn = document.createElement('button'); btn.className = `sidebar-item transition-all ${activeId === id ? 'active' : (hasData ? 'country-has-data' : 'country-empty')}`;
                    btn.onclick = () => { activeId = id; selectCountry(); };
                    const code = flagCodes[nombreKey]; const flagHtml = code ? `<img src="https://flagcdn.com/w40/${code}.png" class="flag-img" alt="">` : '';
                    btn.innerHTML = `<span>${c.nombre}</span> ${flagHtml}`; list.appendChild(btn);
                }
            });
        }
        function selectCountry() { document.getElementById('welcome').classList.add('hidden'); document.getElementById('contentSection').classList.remove('hidden'); document.getElementById('countryName').innerText = countries[activeId].nombre; loadContent(); renderList(); }
        function loadContent() { document.getElementById('mainEditor').innerHTML = countries[activeId].datos?.[activeTab] || "<p class='text-slate-400 italic'>Sin datos registrados en esta sección.</p>"; historyStack = []; }
        function switchTab(t) { activeTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + t).classList.add('active'); loadContent(); }

        function toggleEdit() {
            isEdit = !isEdit; const btn = document.getElementById('btnMode'), toolbar = document.getElementById('toolbar'), editor = document.getElementById('mainEditor');
            if(isEdit) {
                document.body.classList.add('editing-mode');
                btn.classList.replace('bg-amber-500', 'bg-green-600'); document.getElementById('iconStatus').className = "fas fa-save"; document.getElementById('textStatus').innerText = "VOLVER A MODO CONSULTA";
                toolbar.classList.remove('hidden'); editor.contentEditable = "true"; editor.parentElement.classList.add('editing');
                document.querySelectorAll('.edit-ui').forEach(el => el.classList.remove('hidden'));
                cleanUpOldRows(); makeDraggable(); pushHistory();
            } else {
                document.body.classList.remove('editing-mode');
                btn.classList.replace('bg-green-600', 'bg-amber-500'); document.getElementById('iconStatus').className = "fas fa-lock"; document.getElementById('textStatus').innerText = "ENTRAR A MODO EDICIÓN";
                toolbar.classList.add('hidden'); editor.contentEditable = "false"; editor.parentElement.classList.remove('editing');
                document.querySelectorAll('.edit-ui').forEach(el => el.classList.add('hidden'));
            }
        }
        function cleanUpOldRows() {
            document.querySelectorAll('.grid-cell').forEach(cell => {
                const hasImg = cell.querySelector('.img-block'); const hasBtn = cell.querySelector('.placeholder-btn');
                if(hasImg && hasBtn) hasBtn.remove();
                if(!hasImg && !hasBtn) cell.innerHTML = `<div class="placeholder-btn" onclick="replaceWithImg(this)"><i class="fas fa-plus mr-2 text-lg"></i> AÑADIR IMAGEN</div>`;
            });
        }
        function makeDraggable() {
            document.querySelectorAll('.img-block').forEach(block => {
                block.contentEditable = "false"; block.draggable = true;
                if (!block.id) block.id = 'img_' + Math.random().toString(36).substr(2, 9);
            });
        }
        
        /* IMAGE TOOLS */
        function createImgBlock(url) {
            const block = document.createElement('div'); block.className = 'img-block'; block.contentEditable = "false"; block.draggable = true; block.id = 'img_' + Date.now();
            block.style.width = "450px"; // Default size
            block.innerHTML = `
                <div class="img-tools">
                    <button onclick="imgAlign(this, 'left')" class="tool-btn btn-gray" title="Izq"><i class="fas fa-align-left"></i></button>
                    <button onclick="imgAlign(this, 'center')" class="tool-btn btn-gray" title="Centro"><i class="fas fa-align-center"></i></button>
                    <button onclick="imgAlign(this, 'right')" class="tool-btn btn-gray" title="Der"><i class="fas fa-align-right"></i></button>
                    <div class="separator"></div>
                    <button onclick="imgResize(this, 0.9)" class="tool-btn btn-gray" title="Menos"><i class="fas fa-minus"></i></button>
                    <button onclick="imgResize(this, 1.1)" class="tool-btn btn-gray" title="Más"><i class="fas fa-plus"></i></button>
                    <div class="separator"></div>
                    <button onclick="swapUrl(this)" class="tool-btn btn-blue" title="Cambiar"><i class="fas fa-pen"></i></button>
                    <button onclick="deleteImage(this)" class="tool-btn btn-red" title="Borrar"><i class="fas fa-trash"></i></button>
                </div>
                <img src="${url}">`;
            return block;
        }
        
        function imgAlign(btn, align) {
            pushHistory();
            const block = btn.closest('.img-block');
            const cell = block.parentElement;
            // Use margins for alignment since block is display:block
            if(align === 'left') { block.style.marginLeft = '0'; block.style.marginRight = 'auto'; }
            if(align === 'center') { block.style.marginLeft = 'auto'; block.style.marginRight = 'auto'; }
            if(align === 'right') { block.style.marginLeft = 'auto'; block.style.marginRight = '0'; }
        }
        
        function imgResize(btn, factor) {
            pushHistory();
            const block = btn.closest('.img-block');
            // Get current width in px
            let currentW = block.clientWidth;
            // Apply factor
            let newW = Math.round(currentW * factor);
            // Limits
            if(newW < 100) newW = 100;
            // Check parent width to avoid overflow
            const parentW = block.parentElement.clientWidth;
            if(newW > parentW) newW = parentW - 20; // safe margin
            
            block.style.width = newW + 'px';
        }

        /* INSERT FUNCTIONS */
        function insertGrid(cols) {
            pushHistory(); let cells = ''; for(let i=0; i<cols; i++) cells += `<div class="grid-cell"><div class="placeholder-btn" onclick="replaceWithImg(this)"><i class="fas fa-plus mr-2 text-lg"></i> AÑADIR IMAGEN</div></div>`;
            const gridHTML = `<div class="grid-container" contenteditable="false"><div class="row-tools-header"><div class="row-delete-btn" onclick="deleteRow(this)"><i class="fas fa-trash-alt"></i> ELIMINAR FILA</div></div><div class="grid-row-${cols}">${cells}</div></div><p><br></p>`;
            insertHTMLAtCursor(gridHTML); makeDraggable();
        }
        function insertTextTop() { pushHistory(); const editor = document.getElementById('mainEditor'); const p = document.createElement('p'); p.innerHTML = "Escribe aquí tu texto de cabecera..."; editor.prepend(p); }
        function replaceWithImg(btn) { pushHistory(); const url = prompt("Introduce la URL de la imagen:"); if(url) { const cell = btn.parentElement; cell.innerHTML = ''; cell.appendChild(createImgBlock(url)); makeDraggable(); } }
        function deleteImage(btn) { pushHistory(); const cell = btn.closest('.grid-cell'); btn.closest('.img-block').remove(); cleanUpOldRows(); }
        function deleteRow(btn) { if(confirm("¿Eliminar esta fila?")) { pushHistory(); btn.closest('.grid-container').remove(); } }
        function exec(c, v = null) { pushHistory(); document.execCommand(c, false, v); }
        function insertText() { pushHistory(); insertHTMLAtCursor(`<p>Escribe aquí...</p>`); }
        function insertHTMLAtCursor(html) {
            const editor = document.getElementById('mainEditor'); editor.focus(); const selection = window.getSelection();
            if (selection.rangeCount > 0 && editor.contains(selection.getRangeAt(0).commonAncestorContainer)) { document.execCommand('insertHTML', false, html); } else { editor.insertAdjacentHTML('beforeend', html); }
        }
        function swapUrl(btn) { pushHistory(); const img = btn.parentElement.parentElement.querySelector('img'); const newUrl = prompt("Nueva URL:", img.src); if(newUrl) img.src = newUrl; }
        
        /* ZOOM */
        let currentZoomImages=[], currentZoomIndex=0;
        function openZoom(src) {
            const imgs = document.querySelectorAll('#mainEditor img'); currentZoomImages = Array.from(imgs).map(img => img.src);
            currentZoomIndex = currentZoomImages.indexOf(src); updateZoomView(); document.getElementById('zoomOverlay').style.display = 'flex';
        }
        function navigateZoom(dir, e) {
            if(e) e.stopPropagation(); currentZoomIndex += dir;
            if (currentZoomIndex < 0) currentZoomIndex = currentZoomImages.length - 1; if (currentZoomIndex >= currentZoomImages.length) currentZoomIndex = 0;
            updateZoomView();
        }
        function updateZoomView() { document.getElementById('zoomImg').src = currentZoomImages[currentZoomIndex]; document.getElementById('zoomCounter').innerText = `${currentZoomIndex + 1} / ${currentZoomImages.length}`; }
        function closeZoom(e) { if(e.target.id === 'zoomOverlay' || e.target.id === 'zoomImg') document.getElementById('zoomOverlay').style.display = 'none'; }
        
        function save() {
            if(!activeId) return; const clone = document.getElementById('mainEditor').cloneNode(true);
            clone.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            clone.querySelectorAll('.img-block').forEach(el => { el.removeAttribute('id'); el.removeAttribute('draggable'); el.contentEditable = "false"; el.classList.remove('dragging'); });
            ref.child(activeId).child('datos').child(activeTab).set(clone.innerHTML).then(() => alert("✅ GUARDADO CORRECTAMENTE"));
        }
        function nuevoPaisManual() { const n = prompt("Nombre del País:"); if(!n) return; const id = n.toUpperCase().replace(/\s+/g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, ""); ref.child(id).set({ nombre: n, datos: { permiso: "", itv: "", seguro: "", personales: "", otros: "" } }); }
        function eliminarPais() { const name = countries[activeId].nombre; if(prompt(`⚠️ Escribe el nombre EXACTO para eliminar ${name}:`) === name) { ref.child(activeId).remove().then(() => location.reload()); } else { alert("❌ Nombre incorrecto."); } }
    </script>
</body>
</html>
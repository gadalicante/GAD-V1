<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAD - Ayuda Países v20.1 (Bookmarks Bar)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- FUENTES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        /* --- GENERAL --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            overflow-x: hidden; 
            width: 100vw; 
            touch-action: manipulation; 
        }

        .main-container { 
            width: 98%; 
            margin: 0 auto; 
            max-width: 100vw; 
            height: calc(100vh - 80px); 
            display: flex;
        }
        
        @media (min-width: 768px) {
            .main-container { height: calc(100vh - 140px); }
        }

        /* --- SOLUCIÓN PANTALLA MÓVIL (PANTALLA COMPLETA) --- */
        @media (max-width: 1023px) {
            .main-container { 
                flex-direction: column; 
                height: auto; 
                min-height: calc(100vh - 80px);
                overflow: visible;
            }
            aside { 
                max-height: none !important; 
                height: auto !important;
                width: 100% !important;
                flex-grow: 1;
            }
            main {
                height: auto !important;
                overflow: visible !important;
            }
            /* Ocultar bienvenida en móvil para dar espacio a la lista */
            #welcome:not(.hidden) {
                display: flex;
                min-height: 300px;
                padding: 40px 0;
            }
        }

        /* --- CABECERA --- */
        .header-logo { 
            height: 60px; width: auto; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); 
            transition: all 0.3s;
        }

        @media (min-width: 768px) {
            .header-logo { height: 120px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); }
        }

        .header-title { font-size: 1.25rem; line-height: 1.2; }
        @media (min-width: 768px) { .header-title { font-size: 2.25rem; } }

        /* --- BARRA DE MARCADORES --- */
        #top-bar {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: #f8fafc; 
            border-bottom: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 60px;
        }

        .global-btn {
            background-color: white;
            border: 1px solid #cbd5e1;
            color: #334155;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .global-btn:hover { background-color: #f1f5f9; border-color: #94a3b8; transform: translateY(-1px); color: #0f172a; }
        
        .global-btn.add-btn {
            border-style: dashed;
            color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
            border-color: #93c5fd;
        }
        .global-btn.add-btn:hover { background-color: rgba(59, 130, 246, 0.1); }
        
        body:not(.editing-mode) .global-btn.add-btn { display: none !important; }

        /* --- SIDEBAR --- */
        .sidebar-item { 
            font-size: 13px; font-weight: 700; text-transform: uppercase;
            margin-bottom: 6px; border-radius: 12px; transition: all 0.3s;
            border: 1px solid transparent; width: 100%; text-align: left; padding: 0.8rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        .sidebar-item:active { transform: scale(0.98); }
        .country-empty { background-color: #f3f4f6; color: #94a3b8; font-weight: 400; opacity: 0.8; }
        .country-has-data { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; font-weight: 800; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sidebar-item.active { background-color: #2563eb !important; color: white !important; border-color: #1d4ed8 !important; opacity: 1 !important; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .flag-img { width: 28px; height: auto; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.1); }

        /* --- EDITOR (MEJORA ANCHO TOTAL) --- */
        .editor-wrapper { 
            min-height: 500px; background: white; border-radius: 2rem; 
            border: 1px solid #e2e8f0; margin-bottom: 2rem; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: visible !important; 
        }
        @media (min-width: 768px) { .editor-wrapper { min-height: 700px; } }
        
        #mainEditor { 
            outline: none; padding: 1.5rem; color: #1e293b; font-size: 1rem; line-height: 1.6; 
            word-wrap: break-word; overflow-wrap: break-word; 
            width: 100% !important; display: block !important;
        }
        @media (min-width: 768px) { #mainEditor { padding: 3rem; font-size: 1.15rem; line-height: 1.8; } }

        #mainEditor > * { width: 100% !important; box-sizing: border-box !important; }

        /* --- TABS --- */
        .tab-btn { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; border-bottom: 4px solid transparent; padding-bottom: 8px; transition: all 0.2s; white-space: nowrap; }
        @media (min-width: 768px) { .tab-btn { font-size: 13px; padding-bottom: 12px; } }
        .tab-btn.has-data { color: #16a34a; font-weight: 900; }
        .tab-btn.active { border-bottom: 5px solid #2563eb; color: #2563eb !important; font-weight: 900; }

        /* --- GRID --- */
        .grid-container { width: 100% !important; position: relative; margin-bottom: 2rem; border-radius: 12px; transition: all 0.2s; overflow: visible !important; display: block !important; clear: both; }
        .row-tools-header { display: none; height: 32px; background: #e2e8f0; border-radius: 10px 10px 0 0; padding: 0 15px; justify-content: flex-end; align-items: center; border: 2px dashed #cbd5e1; border-bottom: none; }
        .editing .row-tools-header { display: flex; } 
        .row-delete-btn { color: #ef4444; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.5); }
        .row-delete-btn:hover { background: #fee2e2; color: #b91c1c; }
        
        .grid-row-2, .grid-row-1 { display: grid; gap: 1rem; align-items: start; width: 100% !important; }
        .grid-row-2 { grid-template-columns: 1fr; } 
        .grid-row-1 { grid-template-columns: 1fr; }
        @media (min-width: 768px) { .grid-row-2 { grid-template-columns: 1fr 1fr; gap: 1.5rem; } }
        
        .grid-cell { min-height: 120px; padding: 10px; border-radius: 12px; display: flex; flex-direction: column; height: 100%; overflow: visible !important; width: 100% !important; }
        .editing .grid-container { background: #f8fafc; }
        .editing .grid-row-2, .editing .grid-row-1 { border: 2px dashed #cbd5e1; border-top: none; padding: 10px; background: #f8fafc; border-radius: 0 0 12px 12px; }
        .editing .grid-cell { border: 2px dashed #94a3b8; background-color: white; }
        .editing .grid-cell.drag-over { background-color: #dcfce7 !important; border-color: #16a34a !important; transform: scale(1.02); z-index: 50; }

        /* --- TOOLBAR (STICKY Y VISIBILIDAD) --- */
        #toolbar {
            position: sticky;
            top: 0;
            z-index: 45;
            background: #0f172a;
            padding: 0.75rem;
            border-radius: 1rem 1rem 0 0;
            display: none; 
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
            border-bottom: 2px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }
        .toolbar-group { display: flex; align-items: center; gap: 8px; padding: 0 10px; border-right: 1px solid #475569; margin-right: 5px; }
        .tool-icon-btn { width: 32px; height: 32px; text-align: center; color: white; background: rgba(255,255,255,0.1); border-radius: 6px; transition: all 0.2s; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .tool-icon-btn:hover { background: rgba(255,255,255,0.2); }
        .tool-select { background: #334155; border: 1px solid #475569; color: white; border-radius: 6px; padding: 0 6px; font-size: 12px; height: 32px; font-weight: bold; }
        .color-dot-btn { width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); }
        .insert-label { font-size: 10px; font-weight: 800; color: #94a3b8; margin-right: 6px; text-transform: uppercase; letter-spacing: 0.05em; }

        /* --- IMÁGENES --- */
        .img-block { position: relative; display: block; max-width: 100%; margin: 0; opacity: 1 !important; filter: none !important; mix-blend-mode: normal !important; }
        @media (max-width: 768px) { .img-block { width: 100% !important; height: auto !important; } }
        .img-block img { display: block; width: 100%; height: auto; border-radius: 12px; border: 2px solid #cbd5e1; pointer-events: auto; }
        .img-block.dragging { opacity: 0.5 !important; border: 2px dashed #3b82f6; pointer-events: none !important; z-index: 0 !important; }
        .img-tools { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); display: none; gap: 4px; z-index: 9999; background: #1e293b; padding: 6px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); white-space: nowrap; }
        .img-tools::after { content: ''; position: absolute; bottom: -5px; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
        .editing .img-block:hover { z-index: 100; }
        .editing .img-block:hover .img-tools { display: flex; }
        .editing .img-block { cursor: grab; border: 2px solid transparent; }
        .tool-btn { width: 32px; height: 32px; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-blue { background: #3b82f6; } .btn-red { background: #ef4444; } .btn-gray { background: #475569; }
        .separator { width: 1px; height: 18px; background: #475569; margin: 0 4px; }

        /* --- VISOR --- */
        #zoomOverlay { display: none; position: fixed; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        #zoomImgContainer { position: relative; width: 100%; height: 80vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #zoomImg { max-width: 95%; max-height: 95%; border-radius: 4px; border: 2px solid #fff; cursor: grab; transform-origin: center center; transition: transform 0.1s ease-out; user-select: none; }
        #zoomImg:active { cursor: grabbing; }
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 15px; font-size: 24px; cursor: pointer; border-radius: 50%; z-index: 10001; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.4); }
        .prev-btn { left: 10px; } .next-btn { right: 10px; }
        .close-zoom-btn { position: absolute; top: 20px; right: 20px; font-size: 30px; color: white; cursor: pointer; opacity: 0.8; z-index: 10002; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .zoom-legend { margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; pointer-events: none; text-align: center; padding: 0 10px; }

        .placeholder-btn { width: 100%; min-height: 120px; flex-grow: 1; border: 2px dashed #e2e8f0; border-radius: 10px; color: #94a3b8; font-weight: 700; font-size: 12px; background: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .placeholder-btn:hover { background: #f1f5f9; color: #3b82f6; border-color: #3b82f6; }
        body:not(.editing-mode) .placeholder-btn { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-blue-900 text-white shadow-2xl py-2 px-4 flex items-center justify-between z-50 sticky top-0 md:static">
        <div class="flex items-center gap-3 md:gap-8">
            <img src="logogad.png" onerror="this.src='https://via.placeholder.com/150/FFFFFF/0000FF?text=GAD'" class="header-logo">
            <div>
                <h1 class="header-title font-black uppercase tracking-tighter leading-tight">GAD ALICANTE</h1>
                <p class="text-[9px] md:text-[11px] font-bold text-blue-300 tracking-widest uppercase mt-0 md:mt-1">AYUDA PAÍSES</p>
            </div>
        </div>
        
        <div class="hidden md:flex items-center gap-4">
            <button onclick="nuevoPaisManual()" class="bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl text-[10px] font-black border border-slate-600 transition-all shadow-lg uppercase"><i class="fas fa-plus mr-2"></i> AÑADIR PAÍS</button>
            <button id="btnMode" onclick="toggleEdit()" class="bg-amber-500 hover:bg-amber-400 text-blue-950 px-8 py-3 rounded-2xl text-sm font-black shadow-2xl transition-all flex items-center gap-3"><i class="fas fa-lock" id="iconStatus"></i> <span id="textStatus">ENTRAR A MODO EDICIÓN</span></button>
        </div>
    </header>

    <div class="flex flex-grow flex-col lg:flex-row overflow-hidden main-container">
        <aside class="w-full lg:w-80 lg:flex-shrink-0 bg-white border-r border-slate-200 flex flex-col shadow-inner z-10 lg:max-h-full overflow-y-auto">
            <div class="p-3 bg-slate-50 sticky top-0 z-10 border-b">
                <input type="text" id="search" placeholder=" Buscar País..." class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold outline-none focus:ring-4 focus:ring-blue-100 transition-all">
            </div>
            <nav id="countryList" class="p-2 space-y-1"></nav>
        </aside>

        <main class="flex-grow flex flex-col bg-slate-100 overflow-y-auto h-full overflow-x-hidden">
            <div id="top-bar">
                <div id="global-buttons-container" class="flex flex-wrap gap-2 items-center w-full"></div>
            </div>

            <div class="p-3 md:p-10 flex-grow">
                <div id="welcome" class="flex flex-col items-center justify-center text-slate-300 opacity-20 py-10 h-full"><i class="fas fa-shield-halved text-[8rem] md:text-[15rem]"></i></div>
                
                <div id="contentSection" class="hidden">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 md:mb-8 gap-2">
                        <h2 id="countryName" class="text-3xl md:text-7xl font-black text-slate-800 uppercase tracking-tighter mt-4">--</h2>
                        <button onclick="eliminarPais()" class="edit-ui hidden bg-red-600 text-white px-6 py-2 rounded-lg text-xs font-black shadow-lg hover:bg-red-700 transition-all uppercase"><i class="fas fa-trash-alt mr-2"></i> ELIMINAR PAÍS</button>
                    </div>
                    
                    <div class="flex gap-4 md:gap-12 border-b border-slate-300 mb-4 md:mb-8 overflow-x-auto whitespace-nowrap scrollbar-hide pb-1">
                        <button onclick="switchTab('permiso')" id="tab-permiso" class="tab-btn active">Permiso Circulación</button>
                        <button onclick="switchTab('itv')" id="tab-itv" class="tab-btn">Ficha ITV</button>
                        <button onclick="switchTab('seguro')" id="tab-seguro" class="tab-btn">Seguro</button>
                        <button onclick="switchTab('personales')" id="tab-personales" class="tab-btn">Doc. Personales</button>
                        <button onclick="switchTab('otros')" id="tab-otros" class="tab-btn">Otros / Notas</button>
                    </div>
                    
                    <div id="toolbar" class="bg-slate-900 p-3 rounded-t-2xl flex items-center gap-2 flex-wrap border-b border-slate-700 sticky top-0 z-20 shadow-2xl">
                        <div class="toolbar-group"><button onclick="undo()" class="tool-icon-btn bg-slate-600 hover:bg-slate-500" title="Deshacer"><i class="fas fa-undo"></i></button></div>
                        <div class="toolbar-group">
                            <button onmousedown="event.preventDefault(); exec('bold')" class="tool-icon-btn"><i class="fas fa-bold"></i></button>
                            <button onmousedown="event.preventDefault(); exec('insertUnorderedList')" class="tool-icon-btn"><i class="fas fa-list-ul"></i></button>
                            <button onmousedown="event.preventDefault(); exec('justifyLeft')" class="tool-icon-btn"><i class="fas fa-align-left"></i></button>
                            <button onmousedown="event.preventDefault(); exec('justifyCenter')" class="tool-icon-btn"><i class="fas fa-align-center"></i></button>
                            <button onmousedown="event.preventDefault(); exec('justifyRight')" class="tool-icon-btn"><i class="fas fa-align-right"></i></button>
                            <button onmousedown="event.preventDefault(); exec('justifyFull')" class="tool-icon-btn"><i class="fas fa-align-justify"></i></button>
                        </div>
                        <div class="toolbar-group">
                            <div class="flex gap-2 mx-1">
                                <button onmousedown="event.preventDefault(); exec('foreColor', '#000000')" class="color-dot-btn bg-black"></button>
                                <button onmousedown="event.preventDefault(); exec('foreColor', '#dc2626')" class="color-dot-btn bg-red-600"></button>
                                <button onmousedown="event.preventDefault(); exec('foreColor', '#16a34a')" class="color-dot-btn bg-green-600"></button>
                            </div>
                            <select onchange="exec('fontSize', this.value); this.value=''" class="tool-select w-12 text-center">
                                <option value="" disabled selected>T</option>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
                            </select>
                        </div>
                        <span class="insert-label">INSERTAR:</span>
                        <button onclick="insertTextTop()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-2 py-1 md:px-3 md:py-2 rounded-lg text-[10px] font-black uppercase shadow border border-yellow-500 mr-1">TXT INI</button>
                        <button onclick="insertText()" class="bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 md:px-3 md:py-2 rounded-lg text-[10px] font-black uppercase shadow border border-slate-500">TXT</button>
                        <button onclick="insertGrid(1)" class="bg-indigo-700 hover:bg-indigo-600 text-white px-2 py-1 md:px-3 md:py-2 rounded-lg text-[10px] font-black uppercase shadow border border-indigo-500 ml-1">1 COL</button>
                        <button onclick="insertGrid(2)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 md:px-3 md:py-2 rounded-lg text-[10px] font-black uppercase shadow border border-indigo-400 ml-1">2 COL</button>
                        <button onclick="save()" class="ml-auto bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase shadow-2xl border border-green-400"><i class="fas fa-save"></i> GUARDAR</button>
                    </div>

                    <div class="editor-wrapper">
                        <div id="mainEditor" contenteditable="false"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="zoomOverlay">
        <div class="close-zoom-btn" onclick="closeZoom(true)">&times;</div>
        <button class="nav-btn prev-btn" onclick="navigateZoom(-1)"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-btn next-btn" onclick="navigateZoom(1)"><i class="fas fa-chevron-right"></i></button>
        <div id="zoomImgContainer"><img id="zoomImg" draggable="false"></div>
        <div class="zoom-legend">PULSA IMAGEN PARA SALIR</div>
        <div class="text-white mt-2 font-bold bg-black/50 px-4 py-1 rounded-full"><span id="zoomCounter">1 / 1</span></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBu5ALRVJ5aDzuU9YIAQD_9KMgR6ZwttpU", authDomain: "gad-alicante-v1.firebaseapp.com", databaseURL: "https://gad-alicante-v1-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gad-alicante-v1", storageBucket: "gad-alicante-v1.appspot.com", messagingSenderId: "545835357966", appId: "1:545835357966:web:6351ec6c0d3c8e69eb695f" };
        firebase.initializeApp(firebaseConfig); const ref = firebase.database().ref('Ayuda Países'); 
        let isEdit = false, activeId = null, activeTab = 'permiso', countries = {}, globalLinks = {};
        const flagCodes = { "ALBANIA": "al", "ALEMANIA": "de", "ANDORRA": "ad", "ARGELIA": "dz", "ARMENIA": "am", "AUSTRIA": "at", "AZERBAIYAN": "az", "BELGICA": "be", "BIELORRUSIA": "by", "BOSNIA Y HERZEGOVINA": "ba", "BULGARIA": "bg", "CHIPRE": "cy", "CIUDAD DEL VATICANO": "va", "CROACIA": "hr", "DINAMARCA": "dk", "ESLOVAQUIA": "sk", "ESLOVENIA": "si", "ESPANA": "es", "ESTONIA": "ee", "FINLANDIA": "fi", "FRANCIA": "fr", "GEORGIA": "ge", "GRECIA": "gr", "HUNGRIA": "hu", "IRLANDA": "ie", "ISLANDIA": "is", "ITALIA": "it", "KAZAJISTAN": "kz", "LETONIA": "lv", "LIECHTENSTEIN": "li", "LITUANIA": "lt", "LUXEMBURGO": "lu", "MALTA": "mt", "MARRUECOS": "ma", "MOLDAVIA": "md", "MONACO": "mc", "MONTENEGRO": "me", "NORUEGA": "no", "PAISES BAJOS": "nl", "POLONIA": "pl", "PORTUGAL": "pt", "REINO UNIDO": "gb", "REPUBLICA CHECA": "cz", "MACEDONIA DEL NORTE": "mk", "RUMANIA": "ro", "RUSIA": "ru", "SAN MARINO": "sm", "SERBIA": "rs", "SUECIA": "se", "SUIZA": "ch", "TURQUIA": "tr", "UCRANIA": "ua", "LIBIA": "ly", "TUNEZ": "tn", "EGIPTO": "eg" };

        let historyStack = []; const MAX_HISTORY = 50;
        function pushHistory() { const c = document.getElementById('mainEditor').innerHTML; if(historyStack[historyStack.length-1] !== c) { historyStack.push(c); if(historyStack.length > MAX_HISTORY) historyStack.shift(); } }
        function undo() { if(historyStack.length>0) { const p = historyStack.pop(); document.getElementById('mainEditor').innerHTML = p; if(isEdit) makeDraggable(); } }

        function normalizeText(text) { if(typeof text !== 'string') return ""; return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
        function hasContent(html) { if(!html) return false; return html.replace(/<[^>]*>/g, '').trim().length > 0 || html.includes('<img'); }

        function renderList(filter = '') {
            const list = document.getElementById('countryList'); list.innerHTML = '';
            const filterNorm = normalizeText(filter);
            const keys = Object.keys(countries).filter(k => k !== '_GLOBAL_LINKS').sort((a,b) => countries[a].nombre.localeCompare(countries[b].nombre));
            keys.forEach(id => {
                const c = countries[id]; if(!c.nombre) return;
                if(normalizeText(c.nombre).includes(filterNorm)) {
                    const hasData = c.datos && Object.values(c.datos).some(d => hasContent(d));
                    const btn = document.createElement('button');
                    btn.className = `sidebar-item transition-all ${activeId === id ? 'active' : (hasData ? 'country-has-data' : 'country-empty')}`;
                    btn.onclick = () => { activeId = id; selectCountry(); };
                    const code = flagCodes[normalizeText(c.nombre).toUpperCase()]; 
                    btn.innerHTML = `<span>${c.nombre}</span> ${code ? `<img src="https://flagcdn.com/w40/${code}.png" class="flag-img">` : ''}`; list.appendChild(btn);
                }
            });
        }

        function renderGlobalButtons() {
            const container = document.getElementById('global-buttons-container'); container.innerHTML = '';
            Object.keys(globalLinks).forEach(key => {
                const link = globalLinks[key]; const btn = document.createElement('button'); btn.className = 'global-btn';
                btn.innerHTML = `<i class="fas fa-external-link-alt"></i> ${link.name}`;
                if (isEdit) btn.onclick = () => editGlobalLink(key); else btn.onclick = () => window.open(link.url, '_blank');
                container.appendChild(btn);
            });
            if (isEdit) { const addBtn = document.createElement('button'); addBtn.className = 'global-btn add-btn'; addBtn.innerHTML = '<i class="fas fa-plus"></i> AÑADIR'; addBtn.onclick = addGlobalLink; container.appendChild(addBtn); }
        }

        function addGlobalLink() {
            const name = prompt("Nombre:"); if(!name) return; const url = prompt("URL:"); if(!url) return;
            ref.child('_GLOBAL_LINKS').child('link_'+Date.now()).set({ name, url });
        }

        function editGlobalLink(key) {
            const link = globalLinks[key]; const newName = prompt("Nombre:", link.name); if (!newName) return;
            const newUrl = prompt("URL (vacío para borrar):", link.url);
            if (newUrl === "") { if(confirm("¿Eliminar?")) ref.child('_GLOBAL_LINKS').child(key).remove(); }
            else ref.child('_GLOBAL_LINKS').child(key).set({ name: newName, url: newUrl });
        }
        
        function selectCountry() { 
            document.getElementById('welcome').classList.add('hidden'); 
            document.getElementById('contentSection').classList.remove('hidden'); 
            document.getElementById('countryName').innerText = countries[activeId].nombre; 
            loadContent(); renderList(); updateTabsState(); 
            if(window.innerWidth < 768) { setTimeout(() => { document.getElementById('contentSection').scrollIntoView({behavior: 'smooth', block: 'start'}); }, 100); } 
        }
        function loadContent() { document.getElementById('mainEditor').innerHTML = countries[activeId].datos?.[activeTab] || "<p>Sin datos registrados en esta sección.</p>"; if(isEdit) makeDraggable(); historyStack = []; }
        function updateTabsState() { if(!activeId) return; ['permiso','itv','seguro','personales','otros'].forEach(tab => { const el = document.getElementById('tab-'+tab); if(el) { el.classList.toggle('has-data', hasContent(countries[activeId].datos?.[tab])); } }); }
        function switchTab(t) { activeTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); loadContent(); }

        function toggleEdit() {
            isEdit = !isEdit; const btn = document.getElementById('btnMode'), toolbar = document.getElementById('toolbar'), editor = document.getElementById('mainEditor');
            if(isEdit) {
                document.body.classList.add('editing-mode'); btn.classList.replace('bg-amber-500', 'bg-green-600'); document.getElementById('iconStatus').className = "fas fa-save"; document.getElementById('textStatus').innerText = "VOLVER A MODO CONSULTA";
                toolbar.style.display = 'flex'; 
                editor.contentEditable = "true"; editor.parentElement.classList.add('editing'); document.querySelectorAll('.edit-ui').forEach(el => el.classList.remove('hidden')); 
                document.execCommand('styleWithCSS', false, true); document.execCommand('defaultParagraphSeparator', false, 'p');
                cleanUpOldRows(); makeDraggable(); pushHistory(); renderGlobalButtons();
            } else {
                save(); document.body.classList.remove('editing-mode'); btn.classList.replace('bg-green-600', 'bg-amber-500'); document.getElementById('iconStatus').className = "fas fa-lock"; document.getElementById('textStatus').innerText = "ENTRAR A MODO EDICIÓN";
                toolbar.style.display = 'none'; 
                editor.contentEditable = "false"; editor.parentElement.classList.remove('editing'); document.querySelectorAll('.edit-ui').forEach(el => el.classList.add('hidden'));
                renderGlobalButtons();
            }
        }
        
        const mainEditor = document.getElementById('mainEditor');
        mainEditor.addEventListener('dragstart', (e) => { if(isEdit && e.target.closest('.img-block')) { e.dataTransfer.setData("text", e.target.closest('.img-block').id); e.target.closest('.img-block').classList.add('dragging'); }});
        mainEditor.addEventListener('dragend', () => { document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging')); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); });
        mainEditor.addEventListener('dragover', (e) => { if(isEdit) { e.preventDefault(); const c = e.target.closest('.grid-cell'); if(c) c.classList.add('drag-over'); }});
        mainEditor.addEventListener('dragleave', (e) => { const c = e.target.closest('.grid-cell'); if(c) c.classList.remove('drag-over'); });
        
        mainEditor.addEventListener('drop', (e) => {
            if(!isEdit) return; e.preventDefault(); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const dragged = document.getElementById(e.dataTransfer.getData("text"));
            const targetCell = e.target.closest('.grid-cell');
            if(dragged && targetCell && !targetCell.contains(dragged)) {
                pushHistory(); const exist = targetCell.querySelector('.img-block'); const srcCell = dragged.parentElement;
                if(exist) { srcCell.appendChild(exist); targetCell.appendChild(dragged); } else { targetCell.innerHTML = ''; targetCell.appendChild(dragged); }
                cleanUpOldRows();
            }
        });

        /* EVENTOS TÁCTILES PARA MÓVIL (SWAP) */
        let touchTarget = null;
        mainEditor.addEventListener('touchstart', (e) => {
            if(!isEdit) return;
            const imgBlock = e.target.closest('.img-block');
            if(imgBlock) { touchTarget = imgBlock; imgBlock.classList.add('dragging'); }
        }, {passive: true});

        mainEditor.addEventListener('touchmove', (e) => {
            if(!isEdit || !touchTarget) return;
            e.preventDefault();
            const touch = e.touches[0];
            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
            const cell = targetEl ? targetEl.closest('.grid-cell') : null;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if(cell) cell.classList.add('drag-over');
        }, {passive: false});

        mainEditor.addEventListener('touchend', (e) => {
            if(!isEdit || !touchTarget) return;
            const touch = e.changedTouches[0];
            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetCell = targetEl ? targetEl.closest('.grid-cell') : null;
            touchTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if(targetCell && !targetCell.contains(touchTarget)) {
                pushHistory();
                const exist = targetCell.querySelector('.img-block');
                const srcCell = touchTarget.parentElement;
                if(exist) { srcCell.appendChild(exist); targetCell.appendChild(touchTarget); } 
                else { targetCell.innerHTML = ''; targetCell.appendChild(touchTarget); }
                cleanUpOldRows();
            }
            touchTarget = null;
        });

        function cleanUpOldRows() { document.querySelectorAll('.grid-cell').forEach(c => { if(c.querySelector('.img-block') && c.querySelector('.placeholder-btn')) c.querySelector('.placeholder-btn').remove(); if(!c.innerHTML.trim() || c.innerHTML === '<br>') c.innerHTML=`<div class="placeholder-btn" onclick="replaceWithImg(this)"><i class="fas fa-plus mr-2 text-lg"></i> AÑADIR IMAGEN</div>`; }); }
        function makeDraggable() { document.querySelectorAll('.img-block').forEach(b => { b.contentEditable="false"; b.draggable=true; if(!b.id) b.id='img_'+Math.random().toString(36).substr(2,9); }); }
        function createImgBlock(url) { return `<div id="img_${Date.now()}" class="img-block" draggable="true" style="width:450px; margin:0 auto;" contenteditable="false"><div class="img-tools"><button onclick="imgAlign(this,'left')" class="tool-btn btn-gray"><i class="fas fa-align-left"></i></button><button onclick="imgAlign(this,'center')" class="tool-btn btn-gray"><i class="fas fa-align-center"></i></button><button onclick="imgAlign(this,'right')" class="tool-btn btn-gray"><i class="fas fa-align-right"></i></button><div class="separator"></div><button onclick="imgResize(this,0.9)" class="tool-btn btn-gray"><i class="fas fa-minus"></i></button><button onclick="imgResize(this,1.1)" class="tool-btn btn-gray"><i class="fas fa-plus"></i></button><div class="separator"></div><button onclick="swapUrl(this)" class="tool-btn btn-blue"><i class="fas fa-pen"></i></button><button onclick="deleteImage(this)" class="tool-btn btn-red"><i class="fas fa-trash"></i></button></div><img src="${url}"></div>`; }
        
        function insertGrid(cols) { 
            pushHistory(); let c=''; for(let i=0;i<cols;i++) c+=`<div class="grid-cell"><div class="placeholder-btn" onclick="replaceWithImg(this)"><i class="fas fa-plus mr-2 text-lg"></i> AÑADIR IMAGEN</div></div>`; 
            const html = `<div class="grid-container" contenteditable="false"><div class="row-tools-header"><div class="row-delete-btn" onclick="this.closest('.grid-container').remove();"><i class="fas fa-trash-alt"></i> ELIMINAR FILA</div></div><div class="grid-row-${cols}">${c}</div></div><p><br></p>`;
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let range = selection.getRangeAt(0); let container = range.commonAncestorContainer;
                if (container.nodeType === 3) container = container.parentNode;
                if (container !== mainEditor && mainEditor.contains(container)) {
                    while (container.parentNode !== mainEditor) container = container.parentNode;
                    container.insertAdjacentHTML('afterend', html);
                } else { insertHTML(html); }
            } else { insertHTML(html); }
            makeDraggable(); 
        }

        function replaceWithImg(btn) { 
            const u=prompt("URL Imagen:"); 
            if(u) { 
                pushHistory(); 
                const cell = btn.parentElement;
                cell.innerHTML = createImgBlock(u); 
                makeDraggable(); 
                cleanUpOldRows();
            } 
        }

        function imgAlign(b,a) { pushHistory(); const bl=b.closest('.img-block'); bl.style.marginLeft=(a==='left'?'0':(a==='right'?'auto':'auto')); bl.style.marginRight=(a==='right'?'0':(a==='left'?'auto':'auto')); }
        function imgResize(b,f) { pushHistory(); const bl=b.closest('.img-block'); let w=Math.round(bl.clientWidth*f); bl.style.width=w+'px'; }
        function deleteImage(b) { pushHistory(); b.closest('.img-block').remove(); cleanUpOldRows(); }
        function swapUrl(b) { pushHistory(); const i=b.closest('.img-block').querySelector('img'); const u=prompt("Nueva URL:",i.src); if(u) i.src=u; }
        function insertTextTop() { pushHistory(); document.getElementById('mainEditor').prepend(document.createRange().createContextualFragment('<p>Texto inicio...</p>')); }
        function insertText() { pushHistory(); insertHTML('<p>Texto...</p>'); }
        function insertHTML(h) { document.execCommand('insertHTML',false,h); }
        function exec(c,v=null) { pushHistory(); document.execCommand(c,false,v); }

        let zoomState = { scale: 1, pX: 0, pY: 0, sX: 0, sY: 0, isDragging: false, imgs: [], index: 0 };
        const zoomImg = document.getElementById('zoomImg'); const zoomOverlay = document.getElementById('zoomOverlay');
        document.addEventListener('DOMContentLoaded', () => { 
            ref.on('value', s => { const val = s.val() || {}; globalLinks = val._GLOBAL_LINKS || {}; countries = val; renderList(); renderGlobalButtons(); if(activeId) updateTabsState(); }); 
            document.getElementById('search').addEventListener('input', e => renderList(e.target.value)); 
            mainEditor.addEventListener('click', e => { if(!isEdit && e.target.tagName==='IMG' && e.target.closest('.img-block')) openZoom(e.target.src); }); 
            zoomImg.addEventListener('mousedown', startDrag); zoomImg.addEventListener('touchstart', startDrag, {passive: false}); window.addEventListener('mousemove', drag); window.addEventListener('touchmove', drag, {passive: false}); window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag); zoomImg.addEventListener('wheel', handleWheel, {passive: false}); document.addEventListener('keydown', handleKeys); 
        });
        function openZoom(src) { zoomState.imgs = Array.from(document.querySelectorAll('#mainEditor img')).map(i => i.src); zoomState.index = zoomState.imgs.indexOf(src); updateZoomImage(); zoomOverlay.style.display = 'flex'; }
        function closeZoom(force) { if(force || zoomState.scale === 1) zoomOverlay.style.display = 'none'; }
        function updateZoomImage() { zoomImg.src = zoomState.imgs[zoomState.index]; document.getElementById('zoomCounter').innerText = `${zoomState.index+1} / ${zoomState.imgs.length}`; resetZoom(); }
        function navigateZoom(dir) { zoomState.index = (zoomState.index+dir+zoomState.imgs.length)%zoomState.imgs.length; updateZoomImage(); }
        function resetZoom() { zoomState.scale = 1; zoomState.pX = 0; zoomState.pY = 0; updateTransform(); }
        function updateTransform() { zoomImg.style.transform = `translate(${zoomState.pX}px, ${zoomState.pY}px) scale(${zoomState.scale})`; }
        function handleWheel(e) { e.preventDefault(); const delta = e.deltaY > 0 ? 0.9 : 1.1; zoomState.scale *= delta; if(zoomState.scale < 1) zoomState.scale = 1; updateTransform(); }
        let clickStartTime = 0; let startTouchesDistance = 0;
        function startDrag(e) { if(e.type === 'touchstart' && e.touches.length === 2) { startTouchesDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); return; } clickStartTime = Date.now(); zoomState.isDragging = true; const c = e.type.includes('touch') ? e.touches[0] : e; zoomState.sX = c.clientX - zoomState.pX; zoomState.sY = c.clientY - zoomState.pY; }
        function drag(e) { if(e.type === 'touchmove' && e.touches.length === 2) { e.preventDefault(); const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); zoomState.scale *= (dist / startTouchesDistance); startTouchesDistance = dist; if(zoomState.scale < 1) zoomState.scale = 1; updateTransform(); return; } if(!zoomState.isDragging) return; e.preventDefault(); const c = e.type.includes('touch') ? e.touches[0] : e; zoomState.pX = c.clientX - zoomState.sX; zoomState.pY = c.clientY - zoomState.sY; updateTransform(); }
        function endDrag(e) { zoomState.isDragging = false; if(zoomState.scale === 1) { if(Math.abs(zoomState.pX) > 50) { navigateZoom(zoomState.pX > 0 ? -1 : 1); } else if(Date.now() - clickStartTime < 200 && Math.abs(zoomState.pX) < 5) { closeZoom(true); } else { resetZoom(); } } }
        function handleKeys(e) { if(zoomOverlay.style.display === 'flex') { if(e.key === 'ArrowRight') navigateZoom(1); if(e.key === 'ArrowLeft') navigateZoom(-1); if(e.key === 'Escape') closeZoom(true); } }

        function save() {
            if(!activeId) return; const clone = document.getElementById('mainEditor').cloneNode(true);
            clone.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            clone.querySelectorAll('.img-block').forEach(el => { el.removeAttribute('id'); el.removeAttribute('draggable'); el.contentEditable="false"; el.classList.remove('dragging'); });
            if(!countries[activeId].datos) countries[activeId].datos = {};
            countries[activeId].datos[activeTab] = clone.innerHTML;
            ref.child(activeId).child('datos').child(activeTab).set(clone.innerHTML).then(() => { alert("✅ GUARDADO"); updateTabsState(); });
        }
        function nuevoPaisManual() { const n = prompt("Nombre:"); if(!n) return; const id = n.toUpperCase().replace(/\s+/g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, ""); ref.child(id).set({ nombre: n, datos: { permiso: "", itv: "", seguro: "", personales: "", otros: "" } }); }
        function eliminarPais() { const name = countries[activeId].nombre; if(prompt(`⚠️ Escribe el nombre EXACTO para eliminar ${name}:`) === name) { ref.child(activeId).remove().then(() => location.reload()); } }
    </script>
</body>
</html>
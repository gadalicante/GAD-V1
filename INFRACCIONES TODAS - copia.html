<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscador y Clasificador de Infracciones GAD</title>
  
  <!-- Estilos y Librer√≠as -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PDF.js para leer los documentos (Modo Texto Puro) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script>
    // Configuraci√≥n del worker de PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .highlight { background-color: #fde047; padding: 0 2px; border-radius: 2px; color: black; }
    
    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    /* Animaci√≥n de carga */
    .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>
<body class="flex flex-col min-h-screen pb-20">

  <!-- CABECERA -->
  <header class="bg-blue-800 text-white shadow-lg pt-6 pb-12">
    <div class="container mx-auto px-4 text-center">
      <div class="w-20 h-20 mx-auto bg-white rounded-full flex items-center justify-center shadow-md mb-3 overflow-hidden border-4 border-blue-900">
        <i class="fas fa-traffic-light text-3xl text-blue-700"></i>
      </div>
      <h1 class="text-2xl font-bold tracking-tight">CODIFICADO INFRACCIONES (GAD)</h1>
      <p class="text-blue-200 text-sm mt-1">Base de Datos Conectada & Clasificador IA (Sin Canvas)</p>
    </div>
  </header>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="flex-grow container mx-auto px-4 -mt-8 z-10 max-w-3xl">
    
    <!-- BARRA DE B√öSQUEDA -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
      <div class="relative">
        <input type="text" id="searchInput" placeholder="Buscar por art√≠culo, hecho, importe..." 
               class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-lg">
        <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
        <button id="clearSearch" class="hidden absolute right-3 top-3 text-gray-400 hover:text-red-500">
            <i class="fas fa-times-circle text-xl"></i>
        </button>
      </div>
      
      <div class="flex flex-wrap gap-2 mt-3">
        <select id="regulationFilter" class="flex-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm text-gray-700 focus:ring-2 focus:ring-blue-500">
            <option value="todas">Todas las Normativas</option>
            <option value="LSV">Ley de Seguridad Vial (LSV)</option>
            <option value="RGC">Rgto. Gral. Circulaci√≥n (RGC)</option>
            <option value="RGCond">Rgto. Gral. Conductores (CON)</option>
            <option value="RGV">Rgto. Gral. Veh√≠culos (VEH)</option>
            <option value="SOA">Seguro Obligatorio</option>
            <option value="OM">Ordenanza Municipal</option>
        </select>
        <span id="countBadge" class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-2 rounded flex items-center">
            Cargando...
        </span>
      </div>
    </div>

    <!-- ESTADO DE LA CONEXI√ìN -->
    <div id="statusMessage" class="hidden mb-4 p-3 rounded text-center text-sm font-bold"></div>

    <!-- LISTA DE RESULTADOS -->
    <div id="resultsArea" class="space-y-3 pb-10">
        <div class="text-center py-10 text-gray-400">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-2"></div>
            <p>Conectando con Firebase GAD Alicante...</p>
        </div>
    </div>

    <!-- BOTONES FLOTANTES -->
    <div class="fixed bottom-6 left-0 right-0 flex justify-center gap-4 px-4 z-50 pointer-events-none">
        <button id="btnImport" class="pointer-events-auto shadow-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full flex items-center transition-transform hover:scale-105 border border-indigo-400">
            <i class="fas fa-robot mr-2"></i> Importar PDF (IA)
        </button>
        <button id="btnRefresh" class="pointer-events-auto shadow-xl bg-white text-gray-700 hover:bg-gray-100 font-bold p-3 rounded-full transition-transform hover:scale-105 border border-gray-300" title="Recargar datos">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

  </main>

  <!-- MODAL: IMPORTADOR IA -->
  <div id="modalImport" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden z-[60] flex justify-center items-center p-4">
    <div class="bg-gray-800 w-full max-w-lg rounded-2xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <!-- Cabecera Modal -->
        <div class="bg-gray-900 p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-white font-bold text-lg"><i class="fas fa-brain text-indigo-400 mr-2"></i>Extractor Inteligente</h3>
            <button class="close-modal text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- Cuerpo Modal -->
        <div class="p-6 overflow-y-auto">
            <!-- Zona Drop -->
            <div id="dropZone" class="border-2 border-dashed border-gray-600 bg-gray-700/50 rounded-xl p-8 text-center cursor-pointer transition-colors hover:border-indigo-500 hover:bg-gray-700">
                <input type="file" id="fileInput" accept=".pdf,image/*" class="hidden">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                <p class="text-gray-300 font-medium">Arrastra tu PDF o Imagen aqu√≠</p>
                <p class="text-xs text-gray-500 mt-1">Detecta autom√°ticamente CON (Conductores) y VEH (Veh√≠culos).</p>
            </div>

            <!-- Preview -->
            <div id="filePreview" class="hidden mt-4 bg-gray-900 p-3 rounded-lg border border-gray-700 flex items-center justify-between">
                <div class="flex items-center truncate">
                    <i class="fas fa-file-pdf text-red-500 mr-3 text-xl"></i>
                    <span id="fileName" class="text-sm text-white truncate max-w-[200px]">archivo.pdf</span>
                </div>
                <span id="pageCount" class="text-xs text-indigo-400 font-bold bg-indigo-900/30 px-2 py-1 rounded">...</span>
            </div>

            <!-- Progreso -->
            <div id="progressArea" class="hidden mt-6">
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span id="statusText">Iniciando an√°lisis...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="logArea" class="mt-2 h-32 bg-black rounded p-2 text-xs font-mono text-green-400 overflow-y-auto border border-gray-700"></div>
            </div>
        </div>

        <!-- Footer Modal -->
        <div class="bg-gray-900 p-4 border-t border-gray-700 flex justify-end gap-3">
            <button class="close-modal px-4 py-2 text-gray-400 hover:text-white text-sm font-bold">Cancelar</button>
            <button id="btnStartProcess" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-sm shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Analizar y Guardar
            </button>
        </div>
    </div>
  </div>

  <script type="module">
    // -----------------------------------------------------------------------
    // 1. CONFIGURACI√ìN FIREBASE (GAD Alicante V3)
    // -----------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
apiKey: "AIzaSyCY8V_P7m8lZUvGbMVlGaa-GVhbmyikmag",
  authDomain: "gad-alicante-v4.firebaseapp.com",
  databaseURL: "https://gad-alicante-v4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gad-alicante-v4",
  storageBucket: "gad-alicante-v4.firebasestorage.app",
  messagingSenderId: "119727545224",
  appId: "1:119727545224:web:36880c50d196c456cdb83d"
};

    // üî¥ PEGA TU CLAVE DE GEMINI AQU√ç üî¥
    const GEMINI_API_KEY = "GZSyDFx0wBf0MC7dreCopgHckrp0"; 

    // Inicializaci√≥n
    let db, auth;
    let colRef;
    const COLLECTION_NAME = "infracciones_gad_v3";

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        colRef = collection(db, COLLECTION_NAME);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario autenticado (An√≥nimo):", user.uid);
                showStatus("Conectado a GAD Alicante V3", "success");
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Error Auth:", error);
                    showStatus("Error de autenticaci√≥n", "error");
                });
            }
        });

    } catch (e) {
        console.error("Error Inicializaci√≥n:", e);
        showStatus("Error al iniciar Firebase: " + e.message, "error");
    }

    // Variables globales
    let allData = [];
    let currentPdfDoc = null;

    // -----------------------------------------------------------------------
    // 2. L√ìGICA DE UI Y B√öSQUEDA
    // -----------------------------------------------------------------------
    
    // Escuchar cambios en Firestore
    if(colRef) {
        onSnapshot(colRef, (snapshot) => {
            allData = [];
            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                allData.push({
                    id: docSnap.id,
                    norma: d.norma || "Desconocida",
                    articulo: d.articulo || "",
                    apartado: d.apartado || "",
                    opcion: d.opcion || "",
                    descripcion: d.descripcion || "",
                    importe: d.importe || 0,
                    importeReducido: d.importeReducido || 0,
                    puntos: d.puntos || 0,
                    responsable: d.responsable || "Conductor",
                    keywords: d.keywords || ""
                });
            });
            
            // Ordenar
            allData.sort((a,b) => {
                if (a.norma !== b.norma) return a.norma.localeCompare(b.norma);
                const numA = parseFloat(a.articulo.replace(/[^0-9.]/g, '')) || 0;
                const numB = parseFloat(b.articulo.replace(/[^0-9.]/g, '')) || 0;
                return numA - numB;
            });

            updateCount();
            filterData();
        }, (err) => {
            console.error("Error lectura:", err);
            showStatus("Permisos insuficientes o error de red.", "error");
        });
    }

    function showStatus(msg, type) {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.className = type === 'error' ? 'bg-red-100 text-red-800 mb-4 p-3 rounded text-center' : 'bg-green-100 text-green-800 mb-4 p-3 rounded text-center';
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 5000);
    }

    function updateCount() {
        document.getElementById('countBadge').textContent = `${allData.length} Regs`;
    }

    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('regulationFilter');
    const clearBtn = document.getElementById('clearSearch');

    function filterData() {
        const term = normalizeText(searchInput.value);
        const regFilter = filterSelect.value;
        const hasTerm = term.length > 0;

        clearBtn.classList.toggle('hidden', !hasTerm);

        const filtered = allData.filter(item => {
            const rawText = normalizeText(`${item.norma} ${item.articulo} ${item.descripcion} ${item.responsable} ${item.keywords}`);
            let passReg = true;
            if (regFilter !== 'todas') {
                const normUpper = item.norma.toUpperCase();
                if (regFilter === 'LSV' && !normUpper.includes('SEGURIDAD') && !normUpper.includes('LSV')) passReg = false;
                else if (regFilter === 'RGC' && !normUpper.includes('CIRCULACION') && !normUpper.includes('RGC')) passReg = false;
                else if (regFilter === 'RGCond' && !normUpper.includes('CONDUCTORES')) passReg = false;
                else if (regFilter === 'RGV' && !normUpper.includes('VEHICULOS')) passReg = false;
                else if (regFilter === 'SOA' && !normUpper.includes('SEGURO')) passReg = false;
                else if (regFilter === 'OM' && !normUpper.includes('ORDENANZA')) passReg = false;
            }
            const passText = rawText.includes(term);
            return passReg && passText;
        });

        renderResults(filtered);
    }

    function normalizeText(t) {
        return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function highlight(text, term) {
        if (!term) return text;
        const cleanTerm = normalizeText(term);
        if(!cleanTerm) return text;
        const regex = new RegExp(`(${cleanTerm.split(' ').join('|')})`, 'gi');
        return String(text).replace(regex, '<span class="highlight">$1</span>');
    }

    function renderResults(data) {
        const container = document.getElementById('resultsArea');
        if (data.length === 0) {
            container.innerHTML = `<div class="text-center py-12 text-gray-500 bg-white rounded-lg border border-gray-200"><i class="fas fa-inbox text-4xl mb-3 opacity-30"></i><p>No se encontraron resultados.</p></div>`;
            return;
        }

        const term = normalizeText(searchInput.value);

        container.innerHTML = data.map(item => {
            const isTitular = item.responsable.toLowerCase().includes('titular');
            const respBadge = isTitular 
                ? 'bg-purple-100 text-purple-800 border-purple-200' 
                : 'bg-gray-100 text-gray-600 border-gray-200';
            
            const puntosHtml = item.puntos > 0 
                ? `<span class="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded border border-red-100 ml-2">-${item.puntos} Pts</span>` 
                : '';
            const reducedHtml = item.importeReducido > 0
                ? `<div class="text-xs font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded inline-block mt-1">Reducido: ${item.importeReducido}‚Ç¨</div>`
                : '';

            return `
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 card-hover relative group">
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-4">
                        <span class="text-[10px] font-bold uppercase text-blue-600 bg-blue-50 px-2 py-0.5 rounded tracking-wider border border-blue-100">${item.norma}</span>
                        <div class="flex items-baseline mt-1 gap-2 flex-wrap">
                            <h3 class="text-lg font-bold text-gray-900">Art. ${highlight(item.articulo, term)}</h3>
                            ${item.apartado ? `<span class="text-sm font-semibold text-gray-600">Ap. ${item.apartado}</span>` : ''}
                            ${item.opcion ? `<span class="text-sm font-semibold text-indigo-600">Op. ${item.opcion}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-right min-w-[80px]">
                        <div class="text-xl font-bold text-gray-800">${item.importe}‚Ç¨</div>
                        ${reducedHtml}
                    </div>
                </div>
                <p class="text-gray-700 text-sm mt-3 leading-relaxed border-t border-dashed border-gray-100 pt-2">${highlight(item.descripcion, term)}</p>
                <div class="mt-3 flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="px-2 py-1 rounded text-xs font-bold border ${respBadge} flex items-center">
                            <i class="fas ${isTitular ? 'fa-building' : 'fa-user'} mr-1.5"></i> ${item.responsable}
                        </span>
                        ${puntosHtml}
                    </div>
                    <button class="text-gray-300 hover:text-red-500 transition-colors p-1" onclick="window.borrarItem('${item.id}')" title="Borrar"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
        }).join('');
    }

    searchInput.addEventListener('input', filterData);
    filterSelect.addEventListener('change', filterData);
    clearBtn.addEventListener('click', () => { searchInput.value = ''; filterData(); });
    document.getElementById('btnRefresh').onclick = () => location.reload();

    window.borrarItem = async (id) => {
        if(confirm("¬øEst√°s seguro de eliminar esta infracci√≥n?")) {
            try { await deleteDoc(doc(db, COLLECTION_NAME, id)); showStatus("Eliminado", "success"); } 
            catch(e) { alert("Error al borrar: " + e.message); }
        }
    };

    // -----------------------------------------------------------------------
    // 3. LOGICA IMPORTACI√ìN (GEMINI AI + PDF.js TEXT ONLY)
    // -----------------------------------------------------------------------
    const modal = document.getElementById('modalImport');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const btnProcesar = document.getElementById('btnStartProcess');
    
    document.getElementById('btnImport').onclick = () => { modal.classList.remove('hidden'); resetModal(); };
    document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => modal.classList.add('hidden'));
    
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-gray-700'); };
    dropZone.ondragleave = () => dropZone.classList.remove('bg-gray-700');
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('bg-gray-700'); handleFile(e.dataTransfer.files[0]); };
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    let selectedFile = null;

    async function handleFile(file) {
        if(!file) return;
        selectedFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('filePreview').classList.remove('hidden');
        dropZone.classList.add('hidden');
        if (file.type === 'application/pdf') {
            const ab = await file.arrayBuffer();
            currentPdfDoc = await pdfjsLib.getDocument(ab).promise;
            document.getElementById('pageCount').textContent = `${currentPdfDoc.numPages} P√°ginas`;
        } else {
            document.getElementById('pageCount').textContent = "Imagen";
            currentPdfDoc = null;
        }
    }

    function resetModal() {
        dropZone.classList.remove('hidden');
        document.getElementById('filePreview').classList.add('hidden');
        document.getElementById('progressArea').classList.add('hidden');
        document.getElementById('logArea').innerHTML = '';
        selectedFile = null;
        currentPdfDoc = null;
        btnProcesar.disabled = false;
    }

    function log(msg, type="info") {
        const area = document.getElementById('logArea');
        const color = type === 'error' ? 'text-red-400 font-bold' : 'text-green-400';
        area.innerHTML += `<div class="${color} mb-1">> ${msg}</div>`;
        area.scrollTop = area.scrollHeight;
    }

    btnProcesar.onclick = async () => {
        if(!selectedFile) return;
        if(!GEMINI_API_KEY || GEMINI_API_KEY.includes('AQUI_TU_CLAVE')) {
            alert("‚ö†Ô∏è ERROR: No has pegado tu clave de API de Gemini en el c√≥digo (L√≠nea ~158).");
            return;
        }

        btnProcesar.disabled = true;
        document.getElementById('progressArea').classList.remove('hidden');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');

        try {
            if (currentPdfDoc) {
                // PDF processing
                const totalPages = currentPdfDoc.numPages;
                const batchSize = 2; 

                for (let i = 1; i <= totalPages; i += batchSize) {
                    const end = Math.min(i + batchSize - 1, totalPages);
                    log(`Leyendo texto p√°gs ${i}-${end}...`);
                    
                    let textChunk = "";
                    for(let p = i; p <= end; p++) {
                        const page = await currentPdfDoc.getPage(p);
                        const content = await page.getTextContent();
                        textChunk += `--- P√ÅG ${p} ---\n` + content.items.map(item => item.str).join(' | ') + "\n";
                    }

                    log(`Enviando a IA...`);
                    const result = await callGeminiAI(textChunk);
                    
                    if(result && result.length > 0) {
                        const savedCount = await saveToFirestore(result);
                        log(`‚úÖ Guardados: ${savedCount}`);
                    } else {
                        log(`‚Ñπ Sin datos √∫tiles en lote.`);
                    }

                    const pct = Math.round((end / totalPages) * 100);
                    progressBar.style.width = `${pct}%`;
                    percentText.textContent = `${pct}%`;
                    await new Promise(r => setTimeout(r, 800));
                }

            } else {
                // Image processing
                log("Leyendo imagen...");
                const reader = new FileReader();
                reader.readAsDataURL(selectedFile);
                reader.onloadend = async () => {
                    const base64 = reader.result.split(',')[1];
                    log("Consultando IA...");
                    const result = await callGeminiAI(null, base64, selectedFile.type);
                    if(result) {
                        const savedCount = await saveToFirestore(result);
                        log(`‚úÖ Finalizado: ${savedCount} regs.`);
                    }
                    progressBar.style.width = "100%";
                    percentText.textContent = "100%";
                };
            }

            log("üèÅ PROCESO COMPLETADO.");
            setTimeout(() => { alert("Importaci√≥n finalizada."); modal.classList.add('hidden'); }, 1500);

        } catch (err) {
            console.error(err);
            log(`ERROR: ${err.message}`, 'error');
            alert(err.message);
        } finally {
            btnProcesar.disabled = false;
        }
    };

    // --- FUNCI√ìN ROBUSTA DE LLAMADA A IA (Con Fallback 404) ---
    async function callGeminiAI(text, base64Image, mimeType) {
        // Intenta primero con Flash (R√°pido), si falla por 404 (API no habilitada/Modelo no encontrado), prueba Pro.
        const models = ["gemini-1.5-flash", "gemini-1.0-pro"];
        
        for (const modelName of models) {
            try {
                return await tryModel(modelName, text, base64Image, mimeType);
            } catch (error) {
                // Si el error es 404 y NO es el √∫ltimo modelo, probamos el siguiente
                if (error.message.includes("404") && modelName !== models[models.length - 1]) {
                    console.warn(`Modelo ${modelName} fall√≥ (404), intentando con ${models[1]}...`);
                    log(`‚ö†Ô∏è ${modelName} fall√≥. Probando modelo alternativo...`, 'error');
                    continue; 
                }
                // Si es otro error o ya probamos todos, lanzamos el error final
                throw error;
            }
        }
    }

    async function tryModel(model, text, base64Image, mimeType) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
        
        const schema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "norma": { type: "STRING" },
                    "articulo": { type: "STRING" },
                    "apartado": { type: "STRING" },
                    "opcion": { type: "STRING" },
                    "descripcion": { type: "STRING" },
                    "importe": { type: "NUMBER" },
                    "importeReducido": { type: "NUMBER" },
                    "puntos": { type: "NUMBER" },
                    "responsable": { type: "STRING", enum: ["Conductor", "Titular", "Arrendatario", "Desconocido"] }
                },
                required: ["norma", "articulo", "descripcion", "importe", "responsable"]
            }
        };

        const prompt = `
            Eres un experto administrativo en multas. Extrae datos a JSON.
            REGLAS NORMATIVA:
            1. Si ves "CON" o "Conductores" -> "Reglamento General de Conductores".
            2. Si ves "VEH" o "Veh√≠culos" -> "Reglamento General de Veh√≠culos".
            3. Si ves "CIR" o "RGC" -> "Reglamento General de Circulaci√≥n".
            4. Si ves "LSV" -> "Ley de Seguridad Vial".
            OTRAS:
            - Desglosa art√≠culo.
            - Responsable: Si es ITV/Seguro -> TITULAR. Si es manejo -> CONDUCTOR.
            - Importes: Total y Reducido (50%).
        `;

        const parts = [{ text: prompt }];
        if(text) parts.push({ text: `DOC:\n${text}` });
        if(base64Image) parts.push({ inlineData: { mimeType: mimeType, data: base64Image } });

        const body = {
            contents: [{ parts: parts }],
            generationConfig: { responseMimeType: "application/json", responseSchema: schema }
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });

        if(!response.ok) {
            // Manejo espec√≠fico del error 404 para dar feedback √∫til al usuario
            if(response.status === 404) {
                throw new Error(`Error 404 (Not Found): Es muy probable que la API 'Generative Language API' no est√© habilitada en tu proyecto de Google Cloud para esta Key.`);
            }
            const errText = await response.text();
            throw new Error(`Error API (${response.status}): ${errText}`);
        }
        
        const json = await response.json();
        return JSON.parse(json.candidates[0].content.parts[0].text);
    }

    async function saveToFirestore(items) {
        if(!items || !Array.isArray(items)) return 0;
        const batch = writeBatch(db);
        let count = 0;
        const currentSigs = new Set(allData.map(d => `${d.norma}-${d.articulo}-${d.opcion}-${d.importe}`));

        items.forEach(item => {
            const norma = item.norma || "Varios";
            const art = String(item.articulo || "").trim();
            const opc = String(item.opcion || "").trim();
            const imp = parseFloat(item.importe) || 0;
            const sig = `${norma}-${art}-${opc}-${imp}`;

            if(!currentSigs.has(sig)) {
                const ref = doc(colRef);
                batch.set(ref, {
                    norma: norma,
                    articulo: art,
                    apartado: String(item.apartado || "").trim(),
                    opcion: opc,
                    descripcion: item.descripcion || "Sin descripci√≥n",
                    importe: imp,
                    importeReducido: parseFloat(item.importeReducido) || (imp/2),
                    puntos: parseInt(item.puntos) || 0,
                    responsable: item.responsable || "Conductor",
                    keywords: "",
                    fechaCreacion: new Date().toISOString()
                });
                count++;
                currentSigs.add(sig);
            }
        });

        if(count > 0) await batch.commit();
        return count;
    }
  </script>
</body>
</html>